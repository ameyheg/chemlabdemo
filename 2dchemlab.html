<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Chemistry Lab | NCERT Classes 6-8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&family=Nunito:wght@600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-bench: #8B7355;
            --bg-shelf: #252542;
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0;
            --accent: #00d4ff;
            --accent-secondary: #7c3aed;
            --accent-light: rgba(0, 212, 255, 0.15);
            --accent-glow: rgba(0, 212, 255, 0.4);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --radius: 16px;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-accent: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
            --gradient-warm: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-cool: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --glow-accent: 0 0 20px rgba(0, 212, 255, 0.5);
            --glow-purple: 0 0 20px rgba(124, 58, 237, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-primary);
            background-image:
                radial-gradient(ellipse at 20% 0%, rgba(124, 58, 237, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(0, 212, 255, 0.1) 0%, transparent 50%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* ===== HOME SCREEN ===== */
        .home-screen {
            min-height: 100vh;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .home-screen::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(circle at 30% 20%, rgba(124, 58, 237, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 70% 80%, rgba(0, 212, 255, 0.08) 0%, transparent 25%);
            animation: floatBg 20s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes floatBg {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            33% {
                transform: translate(2%, 1%) rotate(1deg);
            }

            66% {
                transform: translate(-1%, 2%) rotate(-1deg);
            }
        }

        .home-header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
            z-index: 1;
        }

        .home-header h1 {
            font-size: 2.75rem;
            font-weight: 700;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.75rem;
            text-shadow: 0 0 40px rgba(0, 212, 255, 0.3);
        }

        .home-header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .class-selector {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 3rem;
            flex-wrap: wrap;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .class-btn {
            width: 140px;
            height: 140px;
            border: 2px solid var(--border);
            border-radius: 20px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 212, 255, 0.2);
            user-select: none;
            -webkit-user-select: none;
            position: relative;
            z-index: 10;
            overflow: hidden;
        }

        .class-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-accent);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 18px;
        }

        .class-btn:hover::before,
        .class-btn:active::before {
            opacity: 0.1;
        }

        .class-btn:hover,
        .class-btn:active {
            border-color: var(--accent);
            transform: translateY(-6px) scale(1.02);
            box-shadow: var(--glow-accent);
        }

        .class-btn.active {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(124, 58, 237, 0.15) 100%);
            box-shadow: var(--glow-accent);
        }

        .class-btn .number {
            font-size: 2.75rem;
            font-weight: 700;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        .class-btn .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        /* Experiment List */
        .experiment-list {
            width: 100%;
            max-width: 800px;
            position: relative;
            z-index: 1;
        }

        .experiment-list h2 {
            font-size: 1.25rem;
            margin-bottom: 1.25rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .experiment-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: 4px solid;
            border-image: var(--gradient-accent) 1;
            border-radius: var(--radius);
            padding: 1.25rem 1.5rem;
            margin-bottom: 0.875rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            overflow: hidden;
        }

        .experiment-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.08) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .experiment-card:hover::before {
            opacity: 1;
        }

        .experiment-card:hover {
            border-color: var(--accent);
            box-shadow: 0 8px 24px rgba(0, 212, 255, 0.15);
            transform: translateX(8px);
        }

        .experiment-card .icon {
            width: 52px;
            height: 52px;
            background: var(--gradient-accent);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        .experiment-card .info {
            position: relative;
            z-index: 1;
        }

        .experiment-card .info h3 {
            font-size: 1rem !important;
            font-weight: 600 !important;
            margin-bottom: 0.25rem !important;
            margin-top: 0 !important;
            display: block !important;
            visibility: visible !important;
            color: var(--text-primary) !important;
            line-height: 1.4 !important;
        }

        .experiment-card .info p {
            font-size: 0.875rem !important;
            color: var(--text-secondary) !important;
            margin: 0 !important;
            display: block !important;
            visibility: visible !important;
        }

        .experiment-card .arrow {
            margin-left: auto;
            color: var(--accent);
            font-size: 1.5rem;
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease;
        }

        .experiment-card:hover .arrow {
            transform: translateX(4px);
        }

        /* ===== LAB SCREEN ===== */
        .lab-screen {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .lab-screen.active {
            display: flex;
        }

        /* Lab Header */
        .lab-header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .back-btn {
            width: 42px;
            height: 42px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: var(--glow-accent);
        }

        .lab-header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            flex: 1;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .header-btn {
            padding: 0.5rem 1.25rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent);
            color: var(--accent);
        }

        .header-btn.primary {
            background: var(--gradient-accent);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .header-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }

        /* Lab Main Area */
        .lab-main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 280px;
            grid-template-rows: auto 1fr;
            grid-template-areas:
                "bench side"
                "observation side";
            align-items: start;
            gap: 0;
            overflow: auto;
        }

        .lab-bench-container {
            grid-area: bench;
        }

        .observation-panel {
            grid-area: observation;
        }

        .side-panel {
            grid-area: side;
        }

        /* Lab Bench */
        .lab-bench-container {
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #2a3f5f 0%, #1e2d47 60%, #162236 100%);
            position: relative;
            overflow: visible;
            box-shadow: inset 0 0 60px rgba(0, 0, 0, 0.4);
        }

        .lab-bench-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background:
                radial-gradient(ellipse at 50% 80%, rgba(0, 212, 255, 0.05) 0%, transparent 60%),
                radial-gradient(ellipse at 20% 20%, rgba(124, 58, 237, 0.03) 0%, transparent 40%);
            pointer-events: none;
        }

        .lab-bench {
            flex: none;
            height: 210px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 0;
            position: relative;
            z-index: 1;
        }

        .bench-surface {
            width: 100%;
            max-width: 700px;
            height: 100%;
            background:
                linear-gradient(180deg,
                    #b08968 0%,
                    #9a7856 15%,
                    #8B7355 35%,
                    #7a6248 70%,
                    #6b553d 100%);
            border-radius: 12px 12px 0 0;
            position: relative;
            box-shadow:
                0 -8px 32px rgba(0, 0, 0, 0.35),
                inset 0 2px 0 rgba(255, 255, 255, 0.1),
                inset 0 -4px 12px rgba(0, 0, 0, 0.2);
        }

        .bench-surface::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
            border-radius: 12px 12px 0 0;
        }

        .bench-surface::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.3) 100%);
        }

        /* Drop Zone */
        .drop-zone {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: calc(100% - 40px);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            transition: all 0.3s;
        }

        .drop-zone.drag-over {
            border-color: var(--accent);
            background: rgba(37, 99, 235, 0.1);
        }

        .drop-zone-hint {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
            text-align: center;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        .drop-zone:not(:empty) .drop-zone-hint {
            display: none;
        }

        /* Placed Apparatus */
        .placed-apparatus {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .apparatus-visual {
            width: 80px;
            height: 120px;
            position: relative;
        }

        /* Beaker SVG Styling */
        .beaker-svg {
            width: 100%;
            height: 100%;
        }

        .beaker-glass {
            fill: rgba(200, 220, 255, 0.15);
            stroke: rgba(150, 180, 220, 0.6);
            stroke-width: 2;
        }

        .beaker-liquid {
            transition: all 0.5s ease;
        }

        /* Stirring Animation - Glass Rod circular motion */
        .stir-animation {
            animation: stirCircular 0.6s ease-in-out;
            transform-origin: center top;
        }

        @keyframes stirCircular {
            0% {
                transform: rotate(0deg) translateX(0);
            }

            12.5% {
                transform: rotate(8deg) translateX(4px);
            }

            25% {
                transform: rotate(12deg) translateX(6px);
            }

            37.5% {
                transform: rotate(8deg) translateX(4px);
            }

            50% {
                transform: rotate(0deg) translateX(0);
            }

            62.5% {
                transform: rotate(-8deg) translateX(-4px);
            }

            75% {
                transform: rotate(-12deg) translateX(-6px);
            }

            87.5% {
                transform: rotate(-8deg) translateX(-4px);
            }

            100% {
                transform: rotate(0deg) translateX(0);
            }
        }

        /* Liquid vortex swirl effect */
        .liquid-swirl {
            animation: liquidVortex 0.8s ease-out;
            transform-origin: center center;
        }

        @keyframes liquidVortex {
            0% {
                transform: rotate(0deg) scaleY(1);
            }

            15% {
                transform: rotate(5deg) scaleY(0.98);
            }

            30% {
                transform: rotate(10deg) scaleY(0.96);
            }

            50% {
                transform: rotate(0deg) scaleY(0.94);
            }

            70% {
                transform: rotate(-8deg) scaleY(0.97);
            }

            85% {
                transform: rotate(-3deg) scaleY(0.99);
            }

            100% {
                transform: rotate(0deg) scaleY(1);
            }
        }

        /* Particle swirling animation - more dramatic */
        .particles-swirl {
            animation: particleVortex 0.7s ease-out;
            transform-origin: 50px 120px;
        }

        @keyframes particleVortex {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }

            20% {
                transform: translateY(-12px) rotate(30deg);
                opacity: 0.9;
            }

            40% {
                transform: translateY(-20px) rotate(80deg);
                opacity: 0.8;
            }

            60% {
                transform: translateY(-15px) rotate(150deg);
                opacity: 0.85;
            }

            80% {
                transform: translateY(-5px) rotate(250deg);
                opacity: 0.95;
            }

            100% {
                transform: translateY(0) rotate(360deg);
                opacity: 1;
            }
        }

        /* Bubbles rising animation */
        .bubble {
            animation: bubbleRise 1.2s ease-out forwards;
        }

        @keyframes bubbleRise {
            0% {
                transform: translateY(0) scale(1);
                opacity: 0.8;
            }

            30% {
                transform: translateY(-15px) translateX(3px) scale(1.1);
                opacity: 0.7;
            }

            60% {
                transform: translateY(-35px) translateX(-2px) scale(0.9);
                opacity: 0.5;
            }

            100% {
                transform: translateY(-60px) translateX(1px) scale(0.6);
                opacity: 0;
            }
        }

        /* Liquid wave effect */
        .liquid-wave {
            animation: waveMotion 0.8s ease-in-out;
        }

        @keyframes waveMotion {

            0%,
            100% {
                d: path('M10,50 Q30,50 50,50 T90,50');
            }

            25% {
                d: path('M10,48 Q30,55 50,48 T90,52');
            }

            50% {
                d: path('M10,52 Q30,45 50,52 T90,48');
            }

            75% {
                d: path('M10,49 Q30,52 50,49 T90,51');
            }
        }

        /* Dissolving animation for salt */
        .dissolving {
            animation: dissolve 0.8s ease-out forwards;
        }

        @keyframes dissolve {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(0.7);
            }

            100% {
                opacity: 0;
                transform: scale(0.2);
            }
        }

        /* Drip animation for filtration */
        .drip-animation {
            animation: dripFall 1.5s ease-in infinite;
        }

        @keyframes dripFall {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            80% {
                transform: translateY(40px);
                opacity: 0.8;
            }

            100% {
                transform: translateY(50px);
                opacity: 0;
            }
        }

        /* Pouring animation - smoother and more realistic */
        .beaker-tilt {
            animation: tiltPour 3s ease-in-out forwards;
            transform-origin: 64px 115px;
            /* Bottom-right corner - pivot point */
        }

        @keyframes tiltPour {
            0% {
                transform: translateY(0) rotate(0deg);
            }

            10% {
                transform: translateY(-30px) rotate(0deg);
                /* Lift beaker up first */
            }

            20% {
                transform: translateY(-30px) rotate(45deg);
                /* Tilt toward funnel (right side) while lifted */
            }

            80% {
                transform: translateY(-30px) rotate(45deg);
                /* Hold tilted position */
            }

            90% {
                transform: translateY(-30px) rotate(0deg);
                /* Rotate back while still lifted */
            }

            100% {
                transform: translateY(0) rotate(0deg);
                /* Lower beaker back down */
            }
        }

        /* Flowing liquid stream */
        .pour-stream {
            animation: streamFlow 0.4s ease-in-out infinite;
            stroke-linecap: round;
        }

        @keyframes streamFlow {
            0% {
                stroke-width: 5;
                stroke-dashoffset: 0;
            }

            50% {
                stroke-width: 7;
            }

            100% {
                stroke-width: 5;
                stroke-dashoffset: -10;
            }
        }

        /* Dripping droplets */
        .drip-drop {
            animation: dropFall 0.8s ease-in infinite;
        }

        @keyframes dropFall {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(50px);
                opacity: 0;
            }
        }

        /* Source beaker liquid draining */
        .liquid-drain {
            animation: liquidDrain 3s ease-out forwards;
        }

        @keyframes liquidDrain {
            0% {
                height: 50px;
                y: 55;
                opacity: 1;
            }

            100% {
                height: 0px;
                y: 105;
                opacity: 0;
            }
        }

        /* Collection beaker liquid filling */
        .liquid-fill {
            animation: liquidFill 3s ease-out forwards;
        }

        @keyframes liquidFill {
            0% {
                height: 5px;
            }

            100% {
                height: 45px;
                y: 35;
            }
        }

        /* Water level rising in funnel */
        .funnel-fill {
            animation: funnelFill 2s ease-out forwards;
        }

        @keyframes funnelFill {
            0% {
                clip-path: polygon(0% 100%, 100% 100%, 100% 100%, 0% 100%);
            }

            100% {
                clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%);
            }
        }

        /* Filtered water drops */
        .filter-drip {
            animation: filterDrip 0.6s ease-in infinite;
        }

        @keyframes filterDrip {
            0% {
                cy: 85;
                opacity: 1;
                r: 3;
            }

            50% {
                opacity: 0.8;
                r: 2.5;
            }

            100% {
                cy: 130;
                opacity: 0;
                r: 2;
            }
        }

        /* Steam animation for evaporation */
        .steam {
            animation: steamRise 2s ease-out infinite;
        }

        @keyframes steamRise {
            0% {
                transform: translateY(0);
                opacity: 0.5;
            }

            50% {
                transform: translateY(-20px);
                opacity: 0.3;
            }

            100% {
                transform: translateY(-40px);
                opacity: 0;
            }
        }

        .steam-group {
            animation: steamWave 1.5s ease-in-out infinite;
        }

        @keyframes steamWave {

            0%,
            100% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(5px);
            }
        }

        /* Liquid evaporating animation - gradual, 4 seconds */
        .liquid-evaporating {
            animation: liquidEvaporate 4s ease-out forwards;
        }

        @keyframes liquidEvaporate {
            0% {
                rx: 35;
                ry: 10;
                opacity: 0.9;
            }

            25% {
                rx: 30;
                ry: 8;
                opacity: 0.8;
            }

            50% {
                rx: 22;
                ry: 6;
                opacity: 0.6;
            }

            75% {
                rx: 12;
                ry: 4;
                opacity: 0.35;
            }

            100% {
                rx: 0;
                ry: 0;
                opacity: 0;
            }
        }

        /* Crystals appearing gradually during evaporation */
        .crystals-forming {
            animation: crystalsAppear 1.5s ease-out forwards;
        }

        /* Crystals appearing during evaporation animation */
        .crystals-during-evaporation {
            animation: crystalsDuringEvaporate 4s ease-out forwards;
        }

        @keyframes crystalsDuringEvaporate {
            0% {
                opacity: 0;
            }

            40% {
                opacity: 0;
            }

            60% {
                opacity: 0.4;
            }

            80% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes crystalsAppear {
            0% {
                opacity: 0;
            }

        }

        /* Litmus drop animation - drop falling straight down from dropper into test tube */
        .litmus-drop-falling {
            animation: litmusDropFall 0.5s ease-in forwards;
            transform-origin: center center;
        }

        @keyframes litmusDropFall {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(35px);
                opacity: 0;
            }
        }

        /* Dropper squeeze animation */
        .dropper-squeeze {
            animation: dropperSqueeze 0.4s ease-out;
        }

        @keyframes dropperSqueeze {
            0% {
                transform: scaleY(1);
            }

            50% {
                transform: scaleY(0.85);
            }

            100% {
                transform: scaleY(1);
            }
        }

        /* Liquid color transition - fades between colors */
        .liquid-color-transition {
            transition: fill 0.6s ease-out, stop-color 0.6s ease-out;
        }

        /* Ripple effect when drop enters liquid */
        .ripple-effect {
            animation: rippleExpand 0.6s ease-out forwards;
        }

        @keyframes rippleExpand {
            0% {
                transform: scale(0.3);
                opacity: 0.8;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Dropper bob animation - when waiting for drops */
        .dropper-bob {
            animation: dropperBob 1.5s ease-in-out infinite;
        }

        @keyframes dropperBob {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        /* Reset Banner - positioned in side panel area, not blocking lab bench */
        .reset-banner {
            position: fixed;
            top: 70px;
            right: 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 10px 16px;
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.5), 0 0 30px rgba(239, 68, 68, 0.3);
            z-index: 1000;
            animation: resetBannerPulse 1.5s ease-in-out infinite;
            cursor: pointer;
            white-space: normal;
            max-width: 220px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .reset-banner .arrow-icon {
            font-size: 1rem;
            animation: pointUp 1s ease-in-out infinite;
        }

        @keyframes resetBannerPulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(245, 158, 11, 0.5), 0 0 30px rgba(239, 68, 68, 0.3);
            }

            50% {
                transform: scale(1.03);
                box-shadow: 0 6px 25px rgba(245, 158, 11, 0.7), 0 0 40px rgba(239, 68, 68, 0.5);
            }
        }

        @keyframes pointUp {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        /* Mobile/Weebly embed optimized reset banner - appears above chemicals section */
        @media (max-width: 900px) {
            .reset-banner {
                position: fixed;
                top: auto;
                bottom: 10px;
                right: 10px;
                left: auto;
                padding: 8px 12px;
                font-size: 0.75rem;
                border-radius: 8px;
                max-width: 200px;
            }

            .reset-banner .arrow-icon {
                font-size: 0.9rem;
            }
        }

        /* Experiment Completion Popup */
        .completion-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .completion-popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .completion-popup {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #00d4ff;
            border-radius: 20px;
            padding: 30px 40px;
            text-align: center;
            max-width: 400px;
            transform: scale(0.8);
            transition: transform 0.3s ease;
            box-shadow: 0 0 40px rgba(0, 212, 255, 0.3), 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .completion-popup-overlay.active .completion-popup {
            transform: scale(1);
            animation: popupBounce 0.5s ease;
        }

        @keyframes popupBounce {
            0% {
                transform: scale(0.5);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .completion-popup .trophy-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: trophyBounce 1s ease infinite;
        }

        @keyframes trophyBounce {

            0%,
            100% {
                transform: translateY(0) rotate(-5deg);
            }

            50% {
                transform: translateY(-10px) rotate(5deg);
            }
        }

        .completion-popup h2 {
            color: #00d4ff;
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .completion-popup p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .completion-popup .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .completion-popup .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }

        .completion-popup .secondary-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .completion-popup .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .completion-popup .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .completion-popup .btn-continue {
            background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .completion-popup .btn-continue:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        /* All Experiments Complete - Grand Celebration Popup */
        .completion-popup.all-complete {
            max-width: 500px;
            padding: 40px 50px;
            border-color: #ffd700;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.4), 0 20px 80px rgba(0, 0, 0, 0.6);
            background: linear-gradient(135deg, #1a1a2e 0%, #2d1b4e 50%, #16213e 100%);
        }

        .completion-popup.all-complete .trophy-icon {
            font-size: 5rem;
        }

        .completion-popup.all-complete h2 {
            color: #ffd700;
            font-size: 2rem;
        }

        .completion-popup.all-complete .stars {
            font-size: 2rem;
            margin-bottom: 15px;
            animation: starPulse 1s ease infinite;
        }

        @keyframes starPulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        /* Confetti animation for grand completion */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(400px) rotate(720deg);
                opacity: 0;
            }
        }

        .beaker-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 0.5rem;
            text-align: center;
        }

        /* Burner */
        .burner-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .burner-container.active {
            opacity: 1;
        }

        .burner-visual {
            width: 60px;
            height: 80px;
            position: relative;
        }

        .burner-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 12px;
            background: linear-gradient(180deg, #666 0%, #444 100%);
            border-radius: 3px;
        }

        .burner-tube {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 50px;
            background: linear-gradient(90deg, #555 0%, #777 50%, #555 100%);
        }

        .burner-flame {
            position: absolute;
            bottom: 62px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 45px;
            opacity: 0;
            transition: opacity 0.3s, height 0.3s;
        }

        .burner-flame.on {
            opacity: 1;
        }

        .flame-outer {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.3) 0%, rgba(96, 165, 250, 0.6) 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: flameFlicker 0.15s infinite alternate;
        }

        .flame-inner {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50%;
            height: 75%;
            background: linear-gradient(180deg, #3b82f6 0%, #93c5fd 80%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: flameFlicker 0.1s infinite alternate;
        }

        @keyframes flameFlicker {
            0% {
                transform: translateX(-50%) scaleX(1) scaleY(1);
            }

            100% {
                transform: translateX(-50%) scaleX(0.92) scaleY(1.05);
            }
        }

        /* Side Panel */
        .side-panel {
            background: linear-gradient(180deg, rgba(26, 26, 46, 0.95) 0%, rgba(22, 33, 62, 0.98) 100%);
            border-left: 1px solid rgba(0, 212, 255, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(12px);
        }

        .panel-section {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
        }

        .panel-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.3), transparent);
        }

        .panel-section h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .panel-section h3::before {
            content: '';
            width: 4px;
            height: 14px;
            background: var(--gradient-accent);
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        /* Apparatus Shelf */
        .apparatus-shelf {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.6rem;
        }

        .apparatus-item {
            aspect-ratio: 1;
            background: linear-gradient(145deg, rgba(15, 15, 35, 0.9) 0%, rgba(26, 26, 46, 0.95) 100%);
            border: 1px solid rgba(0, 212, 255, 0.12);
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0.5rem;
            position: relative;
            overflow: hidden;
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .apparatus-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(124, 58, 237, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 13px;
        }

        .apparatus-item::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 212, 255, 0.15) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }

        .apparatus-item:hover::before,
        .apparatus-item:active::before {
            opacity: 1;
        }

        .apparatus-item:hover::after {
            opacity: 1;
        }

        .apparatus-item:hover,
        .apparatus-item:active {
            border-color: rgba(0, 212, 255, 0.4);
            transform: scale(1.08) translateY(-2px);
            box-shadow:
                0 8px 24px rgba(0, 212, 255, 0.25),
                0 0 20px rgba(0, 212, 255, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .apparatus-item:active {
            cursor: grabbing;
            transform: scale(0.98);
        }

        .apparatus-item.disabled {
            opacity: 0.35;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        .apparatus-item.disabled:hover {
            transform: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .apparatus-item .icon {
            font-size: 1.6rem;
            margin-bottom: 0.35rem;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .apparatus-item .name {
            font-family: 'Nunito', sans-serif;
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 700;
            text-align: center;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Chemical Shelf */
        .chemical-shelf {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .chemical-item {
            display: flex;
            align-items: center;
            gap: 0.85rem;
            padding: 0.7rem 1rem;
            background: linear-gradient(135deg, rgba(15, 15, 35, 0.9) 0%, rgba(26, 26, 46, 0.95) 100%);
            border: 1px solid rgba(0, 212, 255, 0.12);
            border-radius: 12px;
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .chemical-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .chemical-item:hover::before,
        .chemical-item:active::before {
            left: 100%;
        }

        .chemical-item:hover,
        .chemical-item:active {
            border-color: rgba(0, 212, 255, 0.35);
            box-shadow:
                0 6px 20px rgba(0, 212, 255, 0.2),
                inset 0 0 20px rgba(0, 212, 255, 0.05);
            transform: translateX(6px);
        }

        .chemical-item:active {
            transform: scale(0.98);
        }

        .chemical-item.disabled {
            opacity: 0.35;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        .chemical-item .bottle {
            width: 30px;
            height: 40px;
            border-radius: 5px 5px 8px 8px;
            position: relative;
            z-index: 1;
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.35),
                inset 0 -8px 16px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(255, 255, 255, 0.2);
        }

        .chemical-item .bottle::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 14px;
            height: 10px;
            background: linear-gradient(180deg, #aaa 0%, #777 50%, #555 100%);
            border-radius: 3px 3px 0 0;
        }

        .chemical-item .bottle::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 8px;
            height: 60%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 100%);
            border-radius: 2px;
        }

        .chemical-item .name {
            font-family: 'Nunito', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Action Controls */
        .action-controls {
            flex: 1;
            overflow-y: auto;
        }

        .action-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .action-item label {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            appearance: none;
            cursor: pointer;
        }

        .action-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--gradient-accent);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .action-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.7);
        }

        .action-slider:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .action-slider:disabled::-webkit-slider-thumb {
            background: #666;
            box-shadow: none;
            cursor: not-allowed;
        }

        .action-btn {
            padding: 0.85rem 1.1rem;
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(15, 15, 35, 0.95) 0%, rgba(26, 26, 46, 0.9) 100%);
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.15), transparent);
            transition: left 0.4s ease;
        }

        .action-btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .action-btn:hover:not(:disabled) {
            border-color: rgba(0, 212, 255, 0.45);
            box-shadow:
                0 6px 20px rgba(0, 212, 255, 0.25),
                inset 0 0 15px rgba(0, 212, 255, 0.05);
            transform: translateY(-3px);
        }

        .action-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
            filter: grayscale(0.3);
        }

        .action-btn.active {
            background: var(--gradient-accent);
            color: white;
            border: none;
            box-shadow:
                0 6px 20px rgba(0, 212, 255, 0.4),
                0 0 30px rgba(0, 212, 255, 0.2);
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow:
                    0 6px 20px rgba(0, 212, 255, 0.4),
                    0 0 30px rgba(0, 212, 255, 0.2);
            }

            50% {
                box-shadow:
                    0 6px 25px rgba(0, 212, 255, 0.5),
                    0 0 40px rgba(0, 212, 255, 0.3);
            }
        }

        /* Observation Panel */
        .observation-panel {
            background: linear-gradient(180deg, rgba(26, 26, 46, 0.98) 0%, rgba(22, 33, 62, 0.95) 100%);
            border-top: 1px solid rgba(0, 212, 255, 0.1);
            border-left: 4px solid transparent;
            border-image: linear-gradient(180deg, #00d4ff, #7c3aed) 1;
            padding: 1.25rem 1.75rem;
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .observation-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 4px;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.4), transparent);
        }

        .observation-panel h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .observation-panel h3::before {
            content: '';
            font-size: 1.1rem;
            filter: drop-shadow(0 0 8px rgba(0, 212, 255, 0.5));
        }

        .observation-text {
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-primary);
            font-weight: 600;
        }

        .observation-text.hint {
            color: var(--text-secondary);
            font-style: italic;
            font-weight: 500;
        }

        .observation-text.success {
            color: var(--success);
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }

        /* Explanation Box */
        .explanation-box {
            margin-top: 1.25rem;
            padding: 1.35rem;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.08) 0%, rgba(124, 58, 237, 0.08) 100%);
            border-radius: 14px;
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-left: 4px solid;
            border-image: linear-gradient(180deg, #00d4ff, #7c3aed) 1;
            display: none;
            backdrop-filter: blur(12px);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.15),
                inset 0 0 30px rgba(0, 212, 255, 0.02);
        }

        .explanation-box.show {
            display: block;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .explanation-box h4 {
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.65rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .explanation-box h4::before {
            content: '';
            font-size: 1.1rem;
            -webkit-text-fill-color: initial;
            filter: drop-shadow(0 0 8px rgba(255, 200, 0, 0.5));
        }

        .explanation-box p {
            font-family: 'Nunito', sans-serif;
            font-size: 0.92rem;
            color: var(--text-primary);
            line-height: 1.7;
            font-weight: 600;
        }

        /* Lab Record Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 2rem;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4), 0 0 40px rgba(0, 212, 255, 0.1);
            border: 1px solid var(--border);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
            color: var(--danger);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .lab-record {
            font-size: 0.9rem;
        }

        .lab-record-section {
            margin-bottom: 1.25rem;
        }

        .lab-record-section h4 {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border);
        }

        .lab-record-section p,
        .lab-record-section ul {
            color: var(--text-primary);
            line-height: 1.6;
        }

        .lab-record-section ul {
            list-style: disc;
            padding-left: 1.25rem;
        }

        .lab-record-section li {
            margin-bottom: 0.35rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background: var(--bg-tertiary);
        }

        /* Responsive - Tablet */
        @media (max-width: 900px) {

            /* Override grid with flexbox for proper ordering */
            .lab-main {
                display: flex !important;
                flex-direction: column;
                overflow-y: auto;
            }

            .lab-bench-container {
                display: block;
                width: 100%;
                order: 1;
            }

            .side-panel {
                display: flex;
                flex-direction: row;
                width: 100%;
                border-left: none;
                border-top: 1px solid var(--border);
                overflow-x: auto;
                max-height: 180px;
                order: 2;
            }

            .observation-panel {
                width: 100%;
                border-top: 1px solid var(--border);
                order: 3;
            }

            .panel-section {
                min-width: 180px;
                border-bottom: none;
                border-right: 1px solid var(--border);
                padding: 0.75rem;
            }

            /* Enable scrolling for chemicals on tablet */
            .chemical-shelf {
                max-height: 120px;
                overflow-y: auto;
            }

            .bench-surface {
                height: 50%;
                min-height: 180px;
            }

            .lab-bench {
                height: 25vh;
                min-height: 160px;
                max-height: 200px;
            }
        }

        /* Responsive - Mobile */
        @media (max-width: 600px) {
            .home-header h1 {
                font-size: 1.5rem;
            }

            .home-header p {
                font-size: 0.9rem;
            }

            .class-btn {
                width: 100px;
                height: 100px;
                padding: 0.75rem;
                font-size: 0.9rem;
                /* Ensure touch targets are adequate */
                min-height: 44px;
                min-width: 44px;
            }

            .experiment-card {
                padding: 0.75rem 1rem;
            }

            .lab-header {
                padding: 0.25rem 0.5rem;
            }

            .lab-title {
                font-size: 1rem;
            }

            .header-btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.75rem;
            }

            .lab-bench {
                height: 32vh;
                padding: 0 0.5rem 0.5rem 0.5rem;
                /* Reduced top, added bottom */
            }

            .drop-zone {
                top: 2px;
                height: calc(100% - 10px);
                gap: 0.25rem;
                justify-content: center;
                /* Center content horizontally */
                align-items: center;
                /* Center content vertically */
            }

            .bench-surface {
                min-height: 160px;
                margin: 0 auto;
                /* Center the bench surface */
            }

            .side-panel {
                max-height: 140px;
            }

            .panel-section {
                min-width: 140px;
                padding: 0.5rem;
                flex: 0 0 auto;
            }

            .panel-section h3 {
                font-size: 0.65rem;
                margin-bottom: 0.5rem;
            }

            .apparatus-shelf {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.25rem;
            }

            .apparatus-item {
                padding: 0.25rem;
                font-size: 0.65rem;
            }

            .apparatus-item .icon {
                font-size: 1.25rem;
            }

            .chemical-item {
                padding: 0.35rem 0.5rem;
                gap: 0.35rem;
                min-height: 32px;
                align-items: flex-start;
            }

            /* Enable scrolling for chemicals on mobile */
            .chemical-shelf {
                max-height: none;
                overflow-y: auto;
            }

            .chemical-item .bottle {
                width: 16px;
                height: 22px;
                flex-shrink: 0;
                margin-top: 2px;
            }

            .chemical-item .name {
                font-family: 'Inter', sans-serif;
                font-size: 0.58rem;
                font-weight: 600;
                line-height: 1.25;
                word-wrap: break-word;
                flex: 1;
            }

            .action-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }

            .observation-panel {
                padding: 0.75rem 1rem;
            }

            .observation-panel h3 {
                font-size: 0.7rem;
            }

            .observation-text {
                font-size: 0.85rem;
            }

            #procedureSteps {
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
            }

            .explanation-box {
                padding: 0.75rem;
                margin-top: 0.5rem;
            }

            .explanation-box h4 {
                font-size: 0.75rem;
            }

            .explanation-box p {
                font-size: 0.8rem;
            }

            .beaker-label {
                font-size: 0.65rem !important;
            }

            /* Mobile layout: proper stacking with full width */
            /* Using flexbox with order to reorder: bench -> side-panel -> observation */
            .lab-main {
                display: flex !important;
                flex-direction: column;
                overflow-y: auto;
            }

            .lab-bench-container {
                display: block;
                width: 100%;
                order: 1;
            }

            /* On mobile, lab-bench stays inside container */
            .lab-bench {
                width: 100%;
                height: 30vh;
                min-height: 180px;
                max-height: 220px;
                overflow: visible;
            }

            .side-panel {
                display: flex;
                flex-direction: row;
                width: 100%;
                position: static;
                max-height: none;
                overflow-x: auto;
                border-top: 1px solid var(--border);
                order: 2;
            }

            /* Observation panel appears last on mobile */
            .observation-panel {
                width: 100%;
                border-top: 1px solid var(--border);
                background: var(--bg-secondary);
                padding: 0.75rem 1rem;
                order: 3;
            }
        }

        /* Hide actions section for experiments that don't need it (mobile/tablet only) */
        @media (max-width: 900px) {
            body.hide-actions .action-controls {
                display: none !important;
            }
        }


        /* Weebly Embed Compatibility */
        .chemistry-lab-container {
            all: initial;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            box-sizing: border-box;
        }

        .chemistry-lab-container *,
        .chemistry-lab-container *::before,
        .chemistry-lab-container *::after {
            box-sizing: inherit;
        }

        /* When embedded in iframe or custom HTML block */
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            /* Allow scrolling on home screen, only hide when in lab */
            overflow: auto;
        }

        /* Hide overflow only when lab screen is active to prevent scroll issues */
        body:has(.lab-screen.active) {
            overflow: hidden;
        }

        /* Fallback for browsers that don't support :has() - hide scroll in lab mode via JS class */
        body.lab-mode {
            overflow: hidden;
        }

        /* Ensure proper height in embed */
        .lab-screen.active {
            height: 100vh;
            max-height: 100%;
        }

        /* Hide elements */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- HOME SCREEN -->
    <div class="home-screen" id="homeScreen">
        <header class="home-header">
            <h1>Virtual Chemistry Lab</h1>
            <p>NCERT Curriculum  Classes 6-8</p>
        </header>

        <div class="class-selector">
            <button class="class-btn active" data-class="6">
                <span class="number">6</span>
                <span class="label">Class VI</span>
            </button>
            <button class="class-btn" data-class="7">
                <span class="number">7</span>
                <span class="label">Class VII</span>
            </button>
            <button class="class-btn" data-class="8">
                <span class="number">8</span>
                <span class="label">Class VIII</span>
            </button>
        </div>

        <div class="experiment-list" id="experimentList">
            <h2>Chapter Experiments</h2>
            <!-- Experiments loaded dynamically -->
        </div>
    </div>

    <!-- LAB SCREEN -->
    <div class="lab-screen" id="labScreen">
        <header class="lab-header">
            <button class="back-btn" id="backBtn">Back</button>
            <h1 id="labTitle">Experiment Title</h1>
            <div class="header-actions">
                <button class="header-btn" id="resetBtn">Reset</button>
                <button class="header-btn primary" id="labRecordBtn">Lab Record</button>
            </div>
        </header>

        <main class="lab-main">
            <div class="lab-bench-container">
                <div class="lab-bench">
                    <div class="bench-surface">
                        <div class="drop-zone" id="dropZone">
                            <span class="drop-zone-hint">Tap apparatus from the shelf to add</span>
                        </div>
                        <div class="burner-container" id="burnerContainer">
                            <div class="burner-visual">
                                <div class="burner-flame" id="burnerFlame">
                                    <div class="flame-outer"></div>
                                    <div class="flame-inner"></div>
                                </div>
                                <div class="burner-tube"></div>
                                <div class="burner-base"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Observation panel moved outside lab-bench-container for mobile reordering -->
            <div class="observation-panel">
                <h3>Observation</h3>
                <p class="observation-text hint" id="observationText">
                    Start by tapping apparatus to add them to the lab bench.
                </p>
                <div class="procedure-steps" id="procedureSteps"
                    style="display:none; margin-top:12px; padding:14px 16px; background: linear-gradient(135deg, rgba(0, 212, 255, 0.08) 0%, rgba(124, 58, 237, 0.06) 100%); border-radius:12px; border: 1px solid rgba(0, 212, 255, 0.15); backdrop-filter: blur(8px);">
                    <strong
                        style="font-family: 'Poppins', sans-serif; color:#00d4ff; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px;">
                        Steps:</strong>
                    <ol id="stepsList"
                        style="font-family: 'Nunito', sans-serif; margin:10px 0 0 18px; padding:0; color:#e0e0e0; font-size: 0.9rem; font-weight: 600; line-height: 1.8;">
                    </ol>
                </div>
                <div class="explanation-box" id="explanationBox">
                    <h4>What happened?</h4>
                    <p id="explanationText"></p>
                </div>
            </div>

            <aside class="side-panel">
                <div class="panel-section">
                    <h3>Apparatus</h3>
                    <div class="apparatus-shelf" id="apparatusShelf">
                        <!-- Loaded dynamically -->
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Chemicals</h3>
                    <div class="chemical-shelf" id="chemicalShelf">
                        <!-- Loaded dynamically -->
                    </div>
                </div>

                <div class="panel-section action-controls">
                    <h3>Actions</h3>
                    <div class="action-item">
                        <label>Heat Intensity</label>
                        <input type="range" class="action-slider" id="heatSlider" min="0" max="100" value="0" disabled>
                    </div>
                    <button class="action-btn" id="pourBtn" disabled>Pour</button>
                    <button class="action-btn" id="stirBtn" disabled>Stir</button>
                    <button class="action-btn" id="filterBtn" disabled>Filter</button>
                    <button class="action-btn" id="evaporateBtn" disabled>Evaporate</button>
                </div>
            </aside>
        </main>
    </div>

    <!-- EXPERIMENT COMPLETION POPUP -->
    <div class="completion-popup-overlay" id="completionPopup">
        <div class="completion-popup" id="completionPopupContent">
            <div class="trophy-icon"></div>
            <h2 id="completionTitle">Experiment Complete!</h2>
            <p id="completionMessage">Great job! You've successfully completed this experiment.</p>
            <button class="btn-continue" id="completionContinueBtn">Continue</button>
        </div>
    </div>

    <!-- LAB RECORD MODAL -->
    <div class="modal-overlay" id="labRecordModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Laboratory Record</h2>
                <button class="modal-close" id="modalClose"></button>
            </div>
            <div class="modal-body">
                <div class="lab-record" id="labRecordContent">
                    <!-- Generated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="header-btn" id="closeRecordBtn">Close</button>
                <button class="header-btn primary" id="exportPdfBtn">Export PDF</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA ====================
        const experimentsData = {
            6: [
                {
                    id: 'salt-dissolution',
                    title: 'Dissolving Salt vs Sand in Water',
                    chapter: 'Separation of Substances',
                    aim: 'To study the solubility of salt and sand in water.',
                    apparatus: ['beaker', 'glass-rod'],
                    chemicals: [
                        { id: 'water', name: 'Water', color: '#a8d4ff' },
                        { id: 'salt', name: 'Common Salt', color: '#f0f0f0' },
                        { id: 'sand', name: 'Sand', color: '#d4a574' }
                    ],
                    reactions: {
                        'water+salt+stir': {
                            observation: 'The salt crystals gradually disappear as you stir. The water remains clear and transparent.',
                            explanation: 'Salt (sodium chloride) is soluble in water. Water molecules surround the salt ions (Na and Cl) and pull them apart, distributing them evenly throughout the solution. This is called dissolution.',
                            visual: { liquidColor: '#e8f4ff', particles: false },
                            success: true
                        },
                        'water+sand+stir': {
                            observation: 'The sand particles swirl around but settle at the bottom when stirring stops. The water becomes slightly cloudy.',
                            explanation: 'Sand (silicon dioxide) is insoluble in water. The water molecules cannot break apart the strong bonds in sand particles. Sand is denser than water, so it sinks and settles at the bottom.',
                            visual: { liquidColor: '#d4c4a8', particles: true, settled: true },
                            success: true
                        },
                        'water+salt': {
                            observation: 'Salt crystals are sitting in the water. Nothing much is happening yet.',
                            explanation: 'Try stirring the mixture to help the salt dissolve faster. Stirring increases the contact between water molecules and salt crystals.',
                            visual: { liquidColor: '#a8d4ff', particles: true },
                            success: false
                        },
                        'water+sand': {
                            observation: 'Sand has sunk to the bottom of the beaker. The water above is clear.',
                            explanation: 'Sand is denser than water and insoluble, so it naturally settles at the bottom.',
                            visual: { liquidColor: '#a8d4ff', particles: true, settled: true },
                            success: false
                        }
                    },
                    conclusion: 'Salt is soluble in water and forms a clear solution. Sand is insoluble in water and settles at the bottom. This difference in solubility can be used to separate mixtures of salt and sand.'
                },
                {
                    id: 'filtration',
                    title: 'Separation by Filtration',
                    chapter: 'Separation of Substances',
                    aim: 'To separate insoluble impurities from water using filtration.',
                    apparatus: ['beaker', 'funnel', 'filter-paper'],
                    chemicals: [
                        { id: 'muddy-water', name: 'Muddy Water', color: '#8b7355' }
                    ],
                    reactions: {
                        'muddy-water': {
                            observation: 'Muddy water is in the beaker. The water appears brown and cloudy with suspended mud particles. Set up the filtration apparatus and pour the water through it.',
                            explanation: 'Muddy water is a mixture of water and insoluble mud particles. To separate them, you need to set up a filtration apparatus (funnel + filter paper) and pour the muddy water through it.',
                            visual: { liquidColor: '#8b7355', particles: true },
                            success: false
                        },
                        'muddy-water+pour': {
                            observation: 'You are pouring the muddy water into the funnel... Watch as the filter paper separates the mud from the water!',
                            explanation: 'The muddy water passes through the filter paper. Water molecules are small enough to pass through the tiny pores, but mud particles are too large and get trapped.',
                            visual: { pouring: true },
                            success: false
                        },
                        'muddy-water+pour+filter': {
                            observation: 'Filtration complete! Clear water has collected in the beaker below. The brown mud residue is trapped on the filter paper.',
                            explanation: 'Filtration separates insoluble solid particles from a liquid. The filter paper acts as a barrier - it allows water molecules to pass through but traps the larger mud particles. This is a physical method of separation used to purify water.',
                            visual: { liquidColor: '#c8e0ff', particles: false, filtered: true },
                            success: true
                        }
                    },
                    conclusion: 'Filtration is used to separate insoluble solids from liquids. The filter paper traps solid particles while allowing the liquid to pass through. This method is used to purify drinking water and in many industrial processes.'
                },
                {
                    id: 'evaporation',
                    title: 'Separation by Evaporation',
                    chapter: 'Separation of Substances',
                    aim: 'To obtain salt from salt solution by evaporation.',
                    apparatus: ['china-dish', 'tripod-stand', 'burner'],
                    chemicals: [
                        { id: 'salt-solution', name: 'Salt Solution', color: '#e8f4ff' }
                    ],
                    reactions: {
                        'salt-solution': {
                            observation: 'Clear salt solution is in the china dish. The solution looks like plain water but contains dissolved salt.',
                            explanation: 'Salt solution is a homogeneous mixture where salt is completely dissolved in water. To recover the salt, you need to evaporate the water.',
                            visual: { liquidColor: '#e8f4ff', particles: false },
                            success: false
                        },
                        'salt-solution+heat': {
                            observation: 'As you heat the solution, you can see steam rising. The water level is decreasing gradually.',
                            explanation: 'Heat provides energy for water molecules to escape as water vapor (steam). Keep heating to evaporate all the water.',
                            visual: { liquidColor: '#e8f4ff', steam: true },
                            success: false
                        },
                        'salt-solution+heat+evaporate': {
                            observation: 'All the water has evaporated! White salt crystals are left behind at the bottom of the china dish.',
                            explanation: 'When water evaporates, the dissolved salt cannot escape with it because salt has a much higher boiling point. The salt crystallizes and remains in the dish. This is how sea salt is obtained from sea water!',
                            visual: { liquidColor: 'transparent', crystals: true },
                            success: true
                        }
                    },
                    conclusion: 'Evaporation is used to separate a dissolved solid from a liquid. When the liquid evaporates, the solid is left behind. This method is used to obtain salt from sea water and in sugar production.'
                },
                {
                    id: 'physical-chemical',
                    title: 'Physical vs Chemical Change',
                    chapter: 'Changes Around Us',
                    aim: 'To distinguish between physical and chemical changes.',
                    apparatus: ['burner', 'tripod-stand', 'beaker', 'tongs'],
                    chemicals: [
                        { id: 'ice', name: 'Ice Cubes', color: '#e0f4ff' },
                        { id: 'paper', name: 'Paper Strip', color: '#f5f5dc' },
                        { id: 'magnesium', name: 'Magnesium Ribbon', color: '#d4d4d4' }
                    ],
                    reactions: {
                        'ice+heat': {
                            observation: 'The ice is melting! It is turning into liquid water. If you cool it again, it will become ice.',
                            explanation: 'Melting of ice is a PHYSICAL CHANGE. Only the state changes (solid to liquid), but the substance remains water (HO). This change is reversible.',
                            visual: { liquidColor: '#e0f4ff', melting: true },
                            success: true
                        },
                        'paper+heat': {
                            observation: 'The paper catches fire and burns! It turns into ash and smoke. You cannot get the paper back from ash.',
                            explanation: 'Burning of paper is a CHEMICAL CHANGE. The paper reacts with oxygen to form new substances (ash, carbon dioxide, water vapor). This change is irreversible.',
                            visual: { burning: true, ash: true },
                            success: true
                        },
                        'magnesium+heat': {
                            observation: 'The magnesium ribbon burns with a bright white flame! A white powder (magnesium oxide) is formed.',
                            explanation: 'Burning of magnesium is a CHEMICAL CHANGE. Magnesium reacts with oxygen: 2Mg + O  2MgO. The white powder formed is magnesium oxide, a completely new substance.',
                            visual: { burning: true, brightFlame: true },
                            success: true
                        }
                    },
                    conclusion: 'Physical changes are reversible and do not form new substances (melting, freezing, dissolving). Chemical changes are usually irreversible and form new substances (burning, rusting, cooking).'
                }
            ],
            7: [
                {
                    id: 'acids-bases',
                    title: 'Testing Acids and Bases',
                    chapter: 'Acids, Bases and Salts',
                    aim: 'To test the nature of substances using litmus indicators and observe color changes.',
                    apparatus: ['test-tube-stand', 'test-tube', 'dropper'],
                    chemicals: [
                        { id: 'vinegar', name: 'Vinegar (Acid)', color: '#fff8e0' },
                        { id: 'lemon-juice', name: 'Lemon Juice (Acid)', color: '#fffacd' },
                        { id: 'soap-solution', name: 'Soap Solution (Base)', color: '#e8f0ff' },
                        { id: 'baking-soda', name: 'Baking Soda Soln (Base)', color: '#f8f8ff' },
                        { id: 'blue-litmus', name: 'Blue Litmus', color: '#4169e1' },
                        { id: 'red-litmus', name: 'Red Litmus', color: '#dc143c' }
                    ],
                    reactions: {
                        'vinegar': {
                            observation: 'Vinegar (acetic acid) is in the test tube. It has a sour smell and is a weak acid. Add a litmus indicator to test its nature.',
                            explanation: 'Vinegar contains acetic acid (CHCOOH). To confirm it is an acid, you can test it with litmus indicators.',
                            visual: { liquidColor: '#fff8e0' },
                            success: false
                        },
                        'lemon-juice': {
                            observation: 'Lemon juice is in the test tube. It is sour and contains citric acid. Add a litmus indicator to test its nature.',
                            explanation: 'Lemon juice contains citric acid. To confirm it is an acid, you can test it with litmus indicators.',
                            visual: { liquidColor: '#fffacd' },
                            success: false
                        },
                        'soap-solution': {
                            observation: 'Soap solution is in the test tube. It feels slippery and is a base. Add a litmus indicator to test its nature.',
                            explanation: 'Soap solution is basic (alkaline) in nature. To confirm it is a base, you can test it with litmus indicators.',
                            visual: { liquidColor: '#e8f0ff' },
                            success: false
                        },
                        'baking-soda': {
                            observation: 'Baking soda solution is in the test tube. It is a mild base. Add a litmus indicator to test its nature.',
                            explanation: 'Baking soda (sodium bicarbonate, NaHCO) is a weak base. To confirm it is a base, you can test it with litmus indicators.',
                            visual: { liquidColor: '#f8f8ff' },
                            success: false
                        },
                        'vinegar+blue-litmus': {
                            observation: ' The BLUE litmus turned RED! This confirms vinegar is an ACID.',
                            explanation: 'Acids turn blue litmus paper/solution RED. Vinegar contains acetic acid which releases H ions in water. These hydrogen ions react with the blue litmus indicator and change its color to red.',
                            visual: { liquidColor: '#ff6b6b', indicatorChange: true },
                            success: true,
                            resultType: 'acid'
                        },
                        'vinegar+red-litmus': {
                            observation: 'The red litmus remains RED. No color change with red litmus in acid.',
                            explanation: 'Red litmus does not change color in acidic solutions. To identify an acid, you need to test with blue litmus (which will turn red).',
                            visual: { liquidColor: '#ffb3b3' },
                            success: true,
                            resultType: 'acid-no-change'
                        },
                        'lemon-juice+blue-litmus': {
                            observation: ' The BLUE litmus turned RED! This confirms lemon juice is an ACID.',
                            explanation: 'Lemon juice contains citric acid. Like all acids, it releases H ions which turn blue litmus red. Citric acid gives lemons their sour taste.',
                            visual: { liquidColor: '#ff7777', indicatorChange: true },
                            success: true,
                            resultType: 'acid'
                        },
                        'lemon-juice+red-litmus': {
                            observation: 'The red litmus remains RED. No color change with red litmus in acid.',
                            explanation: 'Red litmus does not change color in acidic solutions. Lemon juice is acidic, so red litmus stays red.',
                            visual: { liquidColor: '#ffb3b3' },
                            success: true,
                            resultType: 'acid-no-change'
                        },
                        'soap-solution+blue-litmus': {
                            observation: 'The blue litmus remains BLUE. No color change with blue litmus in base.',
                            explanation: 'Blue litmus does not change color in basic solutions. Soap solution is basic, so blue litmus stays blue.',
                            visual: { liquidColor: '#87ceeb' },
                            success: true,
                            resultType: 'base-no-change'
                        },
                        'soap-solution+red-litmus': {
                            observation: ' The RED litmus turned BLUE! This confirms soap solution is a BASE.',
                            explanation: 'Bases turn red litmus paper/solution BLUE. Soap solution releases OH (hydroxide) ions in water. These hydroxide ions react with the red litmus indicator and change its color to blue.',
                            visual: { liquidColor: '#6495ed', indicatorChange: true },
                            success: true,
                            resultType: 'base'
                        },
                        'baking-soda+blue-litmus': {
                            observation: 'The blue litmus remains BLUE. No color change with blue litmus in base.',
                            explanation: 'Blue litmus does not change color in basic solutions. Baking soda solution is basic, so blue litmus stays blue.',
                            visual: { liquidColor: '#b0c4de' },
                            success: true,
                            resultType: 'base-no-change'
                        },
                        'baking-soda+red-litmus': {
                            observation: ' The RED litmus turned BLUE! This confirms baking soda solution is a BASE.',
                            explanation: 'Baking soda (NaHCO) is a weak base that releases OH ions in water. These hydroxide ions turn red litmus blue, confirming its basic nature.',
                            visual: { liquidColor: '#6495ed', indicatorChange: true },
                            success: true,
                            resultType: 'base'
                        }
                    },
                    conclusion: 'Acids turn blue litmus red (due to H ions). Bases turn red litmus blue (due to OH ions). This is a simple way to identify whether a substance is acidic or basic. Common acids: vinegar, lemon juice, orange juice. Common bases: soap, baking soda, lime water.'
                }
            ],
            8: [
                {
                    id: 'neutralization',
                    title: 'Neutralization Reaction',
                    chapter: 'Acids, Bases and Salts',
                    aim: 'To study the reaction between an acid and a base using phenolphthalein indicator.',
                    apparatus: ['beaker', 'dropper'],
                    chemicals: [
                        { id: 'naoh', name: 'NaOH Solution', color: '#e0e0ff' },
                        { id: 'phenolphthalein', name: 'Phenolphthalein', color: '#ffb6c1' },
                        { id: 'hcl', name: 'Dilute HCl', color: '#ffe0e0' }
                    ],
                    reactions: {
                        'naoh': {
                            observation: 'Sodium hydroxide (NaOH) solution is in the beaker. It is a clear, colorless basic solution. Add phenolphthalein indicator to test.',
                            explanation: 'NaOH is a strong base that completely dissociates in water to form Na and OH ions. The solution is alkaline with high pH.',
                            visual: { liquidColor: '#e8e8ff' },
                            success: false
                        },
                        'naoh+phenolphthalein': {
                            observation: ' The solution turned PINK! Phenolphthalein indicates the presence of a base. Now add HCl using the dropper to neutralize.',
                            explanation: 'Phenolphthalein is colorless in acidic/neutral solutions but turns pink/magenta in basic solutions (pH > 8.2). The pink color confirms NaOH is basic.',
                            visual: { liquidColor: '#ff69b4', indicatorAdded: true },
                            success: true
                        },
                        'naoh+phenolphthalein+hcl': {
                            observation: ' NEUTRALIZATION COMPLETE! The solution is now colorless - the acid has neutralized the base!',
                            explanation: 'Complete neutralization: HCl + NaOH  NaCl + HO. The phenolphthalein turned colorless because the solution is no longer basic. Salt (NaCl) and water are formed.',
                            visual: { liquidColor: '#f5f5f5', neutralized: true },
                            success: true
                        }
                    },
                    conclusion: 'When an acid (HCl) reacts with a base (NaOH), they neutralize each other to form salt (NaCl) and water. This is called a neutralization reaction. Phenolphthalein indicator helps visualize this: it is pink in base and becomes colorless when neutralized. The reaction: HCl + NaOH  NaCl + H2O'
                }
            ]
        };

        const apparatusIcons = {
            'beaker': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><path d="M6 3h12v2l-2 14H8L6 5V3z"/><path d="M6 3h12" stroke-linecap="round"/><ellipse cx="12" cy="15" rx="3" ry="1.5" fill="#a8d4ff" stroke="none"/></svg>',
            'test-tube': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><path d="M9 3h6v1L13 20a2 2 0 01-2 0L9 4V3z"/><path d="M9 3h6" stroke-linecap="round"/><ellipse cx="12" cy="16" rx="1.5" ry="3" fill="#a8d4ff" stroke="none"/></svg>',
            'test-tube-stand': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8B4513" stroke-width="2"><rect x="4" y="20" width="16" height="2" rx="1"/><rect x="5" y="4" width="14" height="2" rx="1"/><path d="M6 6v14M18 6v14"/><circle cx="10" cy="5" r="1.5" fill="#654321"/><circle cx="14" cy="5" r="1.5" fill="#654321"/></svg>',
            'glass-rod': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><line x1="6" y1="20" x2="18" y2="4" stroke-linecap="round"/></svg>',
            'spatula': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><path d="M4 12h8a4 4 0 004-4V6" stroke-linecap="round"/><rect x="16" y="4" width="4" height="6" rx="1" fill="#ddd"/></svg>',
            'funnel': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><path d="M5 4h14l-5 10v6h-4v-6L5 4z"/><path d="M5 4h14" stroke-linecap="round"/></svg>',
            'filter-paper': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><circle cx="12" cy="12" r="8" fill="#f5f5f5"/><path d="M12 4v16M6 8l12 8M6 16l12-8" stroke="#ddd"/></svg>',
            'stand': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><rect x="10" y="2" width="4" height="18"/><rect x="4" y="18" width="16" height="4" rx="1"/></svg>',
            'china-dish': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><ellipse cx="12" cy="16" rx="8" ry="4"/><path d="M4 16c0-4 3.5-8 8-8s8 4 8 8" fill="#fff"/></svg>',
            'tripod-stand': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><circle cx="12" cy="6" r="4" fill="none"/><path d="M8 10l-4 12M16 10l4 12M12 10v12"/></svg>',
            'burner': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none"><rect x="8" y="14" width="8" height="8" rx="1" fill="#333"/><rect x="6" y="20" width="12" height="2" rx="1" fill="#555"/><path d="M12 4c-2 2-2 4 0 6 2-2 2-4 0-6z" fill="#ff6600"/><path d="M12 6c-1 1-1 2 0 3 1-1 1-2 0-3z" fill="#ffcc00"/></svg>',
            'dropper': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><ellipse cx="12" cy="5" rx="4" ry="3" fill="#333" stroke="none"/><rect x="10" y="7" width="4" height="12" rx="1" fill="#e0f0ff"/><ellipse cx="12" cy="20" rx="2" ry="1" fill="#4169e1" stroke="none"/></svg>',
            'tongs': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><path d="M8 4c0 8-4 12-4 16M16 4c0 8 4 12 4 16"/><path d="M8 4h8" stroke-linecap="round"/></svg>'
        };

        // ==================== STATE ====================
        let state = {
            currentClass: 6,
            currentExperiment: null,
            placedApparatus: [],
            addedChemicals: [],
            actions: [],
            heatLevel: 0,
            stirCount: 0,
            observationHistory: [],
            isEvaporating: false,
            litmusDropCount: 0,
            litmusAnimating: false,
            // For salt-dissolution experiment: track both tests across resets
            saltTested: false,
            sandTested: false,
            resetAfterSaltTest: false, // Tracks if user clicked Reset after salt test
            saltTestHistory: [], // Stores first test's history for lab report
            // For physical-chemical experiment: track all 3 materials tested
            iceTested: false,
            paperTested: false,
            magnesiumTested: false,
            physicalChemicalTestHistory: [], // Stores all test histories
            currentPhysicalChemicalRound: 1, // 1=ice, 2=paper, 3=magnesium
            // For acids-bases experiment: track all 4 substances tested (each needs both litmus)
            // Vinegar tests
            vinegarBlueLitmusTested: false,
            vinegarRedLitmusTested: false,
            // Lemon juice tests
            lemonJuiceBlueLitmusTested: false,
            lemonJuiceRedLitmusTested: false,
            // Soap solution tests
            soapSolutionBlueLitmusTested: false,
            soapSolutionRedLitmusTested: false,
            // Baking soda tests
            bakingSodaBlueLitmusTested: false,
            bakingSodaRedLitmusTested: false,
            acidsBasesTestHistory: [], // Stores all test histories
            currentAcidsBasesSubstance: null, // Current substance being tested
            // For neutralization experiment: track HCl drop animation
            neutralizationDropCount: 0,
            neutralizationAnimating: false,
            lastNeutralizationDropTime: null,
            // Track completed experiments across the app
            completedExperiments: JSON.parse(localStorage.getItem('completedExperiments') || '[]')
        };

        // ==================== DOM ELEMENTS ====================
        const homeScreen = document.getElementById('homeScreen');
        const labScreen = document.getElementById('labScreen');
        const experimentList = document.getElementById('experimentList');
        const labTitle = document.getElementById('labTitle');
        const dropZone = document.getElementById('dropZone');
        const apparatusShelf = document.getElementById('apparatusShelf');
        const chemicalShelf = document.getElementById('chemicalShelf');
        const observationText = document.getElementById('observationText');
        const explanationBox = document.getElementById('explanationBox');
        const explanationText = document.getElementById('explanationText');
        const heatSlider = document.getElementById('heatSlider');
        const stirBtn = document.getElementById('stirBtn');
        const burnerContainer = document.getElementById('burnerContainer');
        const burnerFlame = document.getElementById('burnerFlame');
        const labRecordModal = document.getElementById('labRecordModal');
        const labRecordContent = document.getElementById('labRecordContent');

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            renderExperimentList();
            setupEventListeners();
        });

        // Helper function to handle class selection
        function handleClassSelect(btn) {
            if (!btn || !btn.dataset || !btn.dataset.class) return;
            document.querySelectorAll('.class-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.currentClass = parseInt(btn.dataset.class);
            renderExperimentList();
        }

        // Helper functions for acids-bases experiment: check if substance is fully tested (both litmus)
        function isVinegarTested() {
            return state.vinegarBlueLitmusTested && state.vinegarRedLitmusTested;
        }
        function isLemonJuiceTested() {
            return state.lemonJuiceBlueLitmusTested && state.lemonJuiceRedLitmusTested;
        }
        function isSoapSolutionTested() {
            return state.soapSolutionBlueLitmusTested && state.soapSolutionRedLitmusTested;
        }
        function isBakingSodaTested() {
            return state.bakingSodaBlueLitmusTested && state.bakingSodaRedLitmusTested;
        }
        function areAllAcidsBasesTested() {
            return isVinegarTested() && isLemonJuiceTested() && isSoapSolutionTested() && isBakingSodaTested();
        }

        // ==================== COMPLETION POPUP FUNCTIONS ====================
        function showCompletionPopup(experimentTitle, isAllComplete = false) {
            const overlay = document.getElementById('completionPopup');
            const popup = document.getElementById('completionPopupContent');

            if (isAllComplete) {
                // Grand celebration for completing all experiments
                popup.classList.add('all-complete');
                popup.innerHTML = `
                    <div class="stars"><svg class="star-icon" viewBox="0 0 24 24" width="24" height="24"><path fill="#ffd700" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg><svg class="star-icon" viewBox="0 0 24 24" width="24" height="24"><path fill="#ffd700" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg><svg class="star-icon" viewBox="0 0 24 24" width="24" height="24"><path fill="#ffd700" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div>
                    <div class="trophy-icon"><svg viewBox="0 0 24 24" width="64" height="64"><path fill="#ffd700" d="M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.63 4.39 4.94.63 1.5 1.98 2.63 3.61 2.96V19H7v2h10v-2h-4v-3.1c1.63-.33 2.98-1.46 3.61-2.96C19.08 12.63 21 10.55 21 8V7c0-1.1-.9-2-2-2zM5 8V7h2v3.82C5.84 10.4 5 9.3 5 8zm14 0c0 1.3-.84 2.4-2 2.82V7h2v1z"/></svg></div>
                    <h2 id="completionTitle">CONGRATULATIONS!</h2>
                    <p id="completionMessage">Amazing! You've completed ALL experiments in the Virtual Chemistry Lab! You're now a certified young scientist!</p>
                    <button class="btn-certificate" id="downloadCertificateBtn"><svg viewBox="0 0 24 24" width="18" height="18" style="vertical-align:middle;margin-right:6px;"><path fill="currentColor" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg> Download Certificate</button>
                    <div class="secondary-actions" style="margin-top:12px;">
                        <button class="btn-secondary" id="viewLabReportBtn"><svg viewBox="0 0 24 24" width="16" height="16" style="vertical-align:middle;margin-right:4px;"><path fill="currentColor" d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg> Lab Report</button>
                        <button class="btn-secondary" id="completionContinueBtn">Close</button>
                    </div>
                `;
                createConfetti(overlay);
            } else {
                popup.classList.remove('all-complete');
                const nextExp = getNextExperiment();
                // Check if they are eligible for certificate (all done) even if we aren't showing the celebration
                // Only show this button if they have completed ALL experiments across ALL classes
                const canDownloadCertificate = checkIfAllComplete();

                popup.innerHTML = `
                    <div class="trophy-icon"><svg viewBox="0 0 24 24" width="48" height="48"><path fill="#ffd700" d="M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.63 4.39 4.94.63 1.5 1.98 2.63 3.61 2.96V19H7v2h10v-2h-4v-3.1c1.63-.33 2.98-1.46 3.61-2.96C19.08 12.63 21 10.55 21 8V7c0-1.1-.9-2-2-2zM5 8V7h2v3.82C5.84 10.4 5 9.3 5 8zm14 0c0 1.3-.84 2.4-2 2.82V7h2v1z"/></svg></div>
                    <h2 id="completionTitle">Experiment Complete!</h2>
                    <p id="completionMessage">Great job! You've successfully completed "${experimentTitle}"</p>
                    <button class="btn-primary" id="viewLabReportBtn"><svg viewBox="0 0 24 24" width="16" height="16" style="vertical-align:middle;margin-right:4px;"><path fill="currentColor" d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg> View Lab Report</button>
                    <div class="secondary-actions">
                        <button class="btn-secondary" id="rerunBtn"><svg viewBox="0 0 24 24" width="16" height="16" style="vertical-align:middle;margin-right:4px;"><path fill="currentColor" d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg> Rerun</button>
                        ${canDownloadCertificate ? `<button class="btn-secondary" id="downloadCertSmallBtn" title="Download Certificate"><svg viewBox="0 0 24 24" width="16" height="16" style="vertical-align:middle;"><path fill="currentColor" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg></button>` : ''}
                        ${nextExp ? `<button class="btn-secondary" id="nextExpBtn"><svg viewBox="0 0 24 24" width="16" height="16" style="vertical-align:middle;margin-right:4px;"><path fill="currentColor" d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg> Next Experiment</button>` : ''}
                    </div>
                `;
            }

            overlay.classList.add('active');

            // Attach event listeners
            document.getElementById('viewLabReportBtn')?.addEventListener('click', () => {
                overlay.classList.remove('active');
                overlay.querySelectorAll('.confetti').forEach(c => c.remove());
                document.getElementById('labRecordBtn').click(); // Open lab record
            });

            document.getElementById('downloadCertificateBtn')?.addEventListener('click', () => {
                // Prompt for student name
                const studentName = prompt('Enter your name for the certificate:', 'Young Scientist');
                if (studentName && studentName.trim()) {
                    generateCertificate(studentName.trim());
                }
            });

            // Handle small cert button click
            document.getElementById('downloadCertSmallBtn')?.addEventListener('click', () => {
                // Prompt for student name
                const studentName = prompt('Enter your name for the certificate:', 'Young Scientist');
                if (studentName && studentName.trim()) {
                    generateCertificate(studentName.trim());
                }
            });

            document.getElementById('completionContinueBtn')?.addEventListener('click', () => {
                overlay.classList.remove('active');
                overlay.querySelectorAll('.confetti').forEach(c => c.remove());
            });

            document.getElementById('rerunBtn')?.addEventListener('click', () => {
                overlay.classList.remove('active');
                overlay.querySelectorAll('.confetti').forEach(c => c.remove());
                document.getElementById('resetBtn').click(); // Reset to rerun
            });

            document.getElementById('nextExpBtn')?.addEventListener('click', () => {
                overlay.classList.remove('active');
                overlay.querySelectorAll('.confetti').forEach(c => c.remove());
                goToNextExperiment();
            });
        }

        function getNextExperiment() {
            // Get all experiments for current class
            const experiments = experimentsData[state.currentClass];
            if (!experiments || !state.currentExperiment) return null;

            const currentIndex = experiments.findIndex(e => e.id === state.currentExperiment.id);
            if (currentIndex < experiments.length - 1) {
                return experiments[currentIndex + 1];
            }
            return null;
        }

        function goToNextExperiment() {
            const nextExp = getNextExperiment();
            if (nextExp) {
                openExperiment(nextExp.id);
            }
        }

        function createConfetti(container) {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffd700', '#ff6600'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                container.appendChild(confetti);
            }
        }

        // Track which popups have been shown this session (to avoid repeating)
        const shownPopupsThisSession = new Set();

        function markExperimentComplete(experimentId) {
            let wasNewCompletion = false;

            // Save to persistent storage if not already saved
            if (!state.completedExperiments.includes(experimentId)) {
                state.completedExperiments.push(experimentId);
                localStorage.setItem('completedExperiments', JSON.stringify(state.completedExperiments));
                wasNewCompletion = true;
            }

            // Show popup if not shown this session
            if (!shownPopupsThisSession.has(experimentId)) {
                shownPopupsThisSession.add(experimentId);

                // Show completion popup after a delay to let user see results
                const exp = state.currentExperiment;
                setTimeout(() => {
                    // Only show "All Complete" celebration if this specific valid run was the one that achieved it
                    // i.e. it was a NEW completion and now everything is done. 
                    // If we just re-ran an old experiment, wasNewCompletion is false, so we show standard popup.
                    if (checkIfAllComplete() && wasNewCompletion) {
                        showCompletionPopup(exp.title, true);
                    } else {
                        showCompletionPopup(exp.title, false);
                    }
                }, 2500);
            }
        }

        function checkIfAllComplete() {
            // Get all experiment IDs from all classes
            const allExperimentIds = [];
            for (const classNum in experimentsData) {
                experimentsData[classNum].forEach(exp => {
                    allExperimentIds.push(exp.id);
                });
            }

            // Check if all are completed
            return allExperimentIds.every(id => state.completedExperiments.includes(id));
        }

        function getTotalExperimentCount() {
            let count = 0;
            for (const classNum in experimentsData) {
                count += experimentsData[classNum].length;
            }
            return count;
        }

        function setupEventListeners() {
            // Class selector - support both click and touch for mobile/Weebly compatibility
            document.querySelectorAll('.class-btn').forEach(btn => {
                // Click event
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleClassSelect(btn);
                });

                // Touch event for mobile (handles cases where click doesn't fire properly)
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    handleClassSelect(btn);
                }, { passive: false });
            });

            // Back button
            document.getElementById('backBtn').addEventListener('click', goHome);

            // Reset button
            document.getElementById('resetBtn').addEventListener('click', resetExperiment);

            // Lab record button
            document.getElementById('labRecordBtn').addEventListener('click', showLabRecord);
            document.getElementById('modalClose').addEventListener('click', hideLabRecord);
            document.getElementById('closeRecordBtn').addEventListener('click', hideLabRecord);
            document.getElementById('exportPdfBtn').addEventListener('click', exportLabRecordPdf);

            // Drop zone
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
            dropZone.addEventListener('dragleave', handleDragLeave);

            // Heat slider
            heatSlider.addEventListener('input', handleHeatChange);

            // Action buttons
            document.getElementById('pourBtn').addEventListener('click', handlePour);
            stirBtn.addEventListener('click', handleStir);
            document.getElementById('filterBtn').addEventListener('click', handleFilter);
            document.getElementById('evaporateBtn').addEventListener('click', handleEvaporate);
        }

        // ==================== RENDERING ====================
        function renderExperimentList() {
            const experiments = experimentsData[state.currentClass] || [];
            experimentList.innerHTML = `
                <h2>Class ${state.currentClass} Experiments</h2>
                ${experiments.map(exp => `
                    <div class="experiment-card" data-id="${exp.id}">
                        <div class="icon">Exp</div>
                        <div class="info">
                            <h3>${exp.title}</h3>
                            <p>${exp.chapter}</p>
                        </div>
                        <span class="arrow"></span>
                    </div>
                `).join('')}
            `;

            // Add click handlers
            experimentList.querySelectorAll('.experiment-card').forEach(card => {
                card.addEventListener('click', () => openExperiment(card.dataset.id));
            });
        }

        function renderApparatusShelf() {
            const exp = state.currentExperiment;
            const expId = exp ? exp.id : '';

            // For physical-chemical experiment: determine which apparatus is needed for current round
            let disabledApparatus = [];
            if (expId === 'physical-chemical') {
                // Round 1 (ice): needs burner, tripod-stand, beaker
                // Round 2 (paper) & Round 3 (magnesium): need burner, tongs only
                if (state.iceTested) {
                    // After ice is tested, disable beaker and tripod-stand
                    disabledApparatus = ['beaker', 'tripod-stand'];
                } else {
                    // Before ice is tested, disable tongs (not needed for ice)
                    disabledApparatus = ['tongs'];
                }
            }

            apparatusShelf.innerHTML = exp.apparatus.map(id => {
                const isPlaced = state.placedApparatus.includes(id);
                const isDisabledForRound = disabledApparatus.includes(id);

                // For acids-bases experiment: disable dropper until a substance is added
                let isDisabledForAcidsBases = false;
                if (expId === 'acids-bases' && id === 'dropper') {
                    // Dropper should only be enabled after a substance (vinegar, lemon-juice, soap-solution, baking-soda) is in the test tube
                    const acidsBasesSubstances = ['vinegar', 'lemon-juice', 'soap-solution', 'baking-soda'];
                    const hasSubstance = state.addedChemicals.some(c => acidsBasesSubstances.includes(c));
                    isDisabledForAcidsBases = !hasSubstance;
                }

                // For neutralization experiment: disable dropper until phenolphthalein is added
                let isDisabledForNeutralization = false;
                if (expId === 'neutralization' && id === 'dropper') {
                    // Dropper should only be enabled after phenolphthalein is added (for adding HCl drops)
                    const hasPhenolphthalein = state.addedChemicals.includes('phenolphthalein');
                    isDisabledForNeutralization = !hasPhenolphthalein;
                }

                const isDisabled = isPlaced || isDisabledForRound || isDisabledForAcidsBases || isDisabledForNeutralization;

                return `
                <div class="apparatus-item ${isDisabled ? 'disabled' : ''}" 
                     draggable="${!isDisabled}" 
                     data-type="apparatus" 
                     data-id="${id}">
                    <span class="icon">${apparatusIcons[id] || '[?]'}</span>
                    <span class="name">${id.replace('-', ' ')}</span>
                </div>
            `}).join('');

            // Add drag handlers for desktop
            apparatusShelf.querySelectorAll('.apparatus-item:not(.disabled)').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);

                // Add tap/click handler for mobile
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleApparatusDrop(item.dataset.id);
                });
                item.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    handleApparatusDrop(item.dataset.id);
                }, { passive: false });
            });
        }

        function renderChemicalShelf() {
            const exp = state.currentExperiment;
            const expId = exp ? exp.id : '';

            // Different dragging rules for physical-chemical experiment
            const hasContainer = state.placedApparatus.includes('beaker') ||
                state.placedApparatus.includes('funnel') ||
                state.placedApparatus.includes('china-dish');
            const hasTongs = state.placedApparatus.includes('tongs');
            const hasTestTube = state.placedApparatus.includes('test-tube');

            // For acids-bases: check what substances/indicators we already have
            const acidsBasesSubstances = ['vinegar', 'lemon-juice', 'soap-solution', 'baking-soda'];
            const indicators = ['blue-litmus', 'red-litmus'];
            const hasSubstance = state.addedChemicals.some(c => acidsBasesSubstances.includes(c));
            const hasIndicator = state.addedChemicals.some(c => indicators.includes(c));

            chemicalShelf.innerHTML = exp.chemicals.map(chem => {
                let canDrag = false;
                if (state.addedChemicals.includes(chem.id)) {
                    canDrag = false; // Already added
                } else if (expId === 'physical-chemical') {
                    // Strict round order for physical-chemical experiment
                    // Round 1: Only ice allowed (needs beaker)
                    // Round 2: Only paper allowed (needs tongs, after ice tested + reset)
                    // Round 3: Only magnesium allowed (needs tongs, after paper tested + reset)

                    if (chem.id === 'ice') {
                        // Ice only enabled in Round 1 (before ice tested), needs beaker
                        canDrag = !state.iceTested && hasContainer;
                    } else if (chem.id === 'paper') {
                        // Paper only enabled in Round 2 (after ice tested, before paper tested)
                        // Must have reset (no ice in current session), needs tongs
                        const hasReset = !state.addedChemicals.includes('ice');
                        canDrag = state.iceTested && !state.paperTested && hasReset && hasTongs;
                    } else if (chem.id === 'magnesium') {
                        // Magnesium only enabled in Round 3 (after paper tested, before magnesium tested)
                        // Must have reset (no paper in current session), needs tongs
                        const hasReset = !state.addedChemicals.includes('paper');
                        canDrag = state.iceTested && state.paperTested && !state.magnesiumTested && hasReset && hasTongs;
                    }
                } else if (expId === 'acids-bases') {
                    // Substances (acids/bases) need test tube
                    // Indicators need test tube + dropper + substance already added
                    const hasDropper = state.placedApparatus.includes('dropper');
                    const hasBlueLitmus = state.addedChemicals.includes('blue-litmus');
                    const hasRedLitmus = state.addedChemicals.includes('red-litmus');

                    // Strict order for acids-bases: vinegar  lemon-juice  soap-solution  baking-soda
                    // Each substance must be tested with BOTH litmus and reset before the next is available
                    if (acidsBasesSubstances.includes(chem.id)) {
                        if (chem.id === 'vinegar') {
                            // Vinegar is first, available if not fully tested yet
                            canDrag = hasTestTube && !isVinegarTested() && !hasSubstance;
                        } else if (chem.id === 'lemon-juice') {
                            // Lemon juice available after vinegar fully tested + reset
                            const hasReset = !state.addedChemicals.includes('vinegar');
                            canDrag = hasTestTube && isVinegarTested() && !isLemonJuiceTested() && !hasSubstance && hasReset;
                        } else if (chem.id === 'soap-solution') {
                            // Soap available after lemon fully tested + reset
                            const hasReset = !state.addedChemicals.includes('lemon-juice');
                            canDrag = hasTestTube && isVinegarTested() && isLemonJuiceTested() && !isSoapSolutionTested() && !hasSubstance && hasReset;
                        } else if (chem.id === 'baking-soda') {
                            // Baking soda available after soap fully tested + reset
                            const hasReset = !state.addedChemicals.includes('soap-solution');
                            canDrag = hasTestTube && isVinegarTested() && isLemonJuiceTested() && isSoapSolutionTested() && !isBakingSodaTested() && !hasSubstance && hasReset;
                        }
                    } else if (indicators.includes(chem.id)) {
                        // Allow litmus if not yet tested with current substance
                        // Check which substance is currently in the test tube
                        const currentSubstance = state.addedChemicals.find(c => acidsBasesSubstances.includes(c));
                        let canAddThisLitmus = false;

                        // Only allow one litmus per session - must reset before adding the second
                        const hasAnyLitmusInSession = hasBlueLitmus || hasRedLitmus;

                        if (currentSubstance && hasDropper && !hasAnyLitmusInSession) {
                            if (chem.id === 'blue-litmus') {
                                // Check if blue litmus already tested for current substance
                                if (currentSubstance === 'vinegar' && !state.vinegarBlueLitmusTested) canAddThisLitmus = true;
                                if (currentSubstance === 'lemon-juice' && !state.lemonJuiceBlueLitmusTested) canAddThisLitmus = true;
                                if (currentSubstance === 'soap-solution' && !state.soapSolutionBlueLitmusTested) canAddThisLitmus = true;
                                if (currentSubstance === 'baking-soda' && !state.bakingSodaBlueLitmusTested) canAddThisLitmus = true;
                            } else if (chem.id === 'red-litmus') {
                                // Check if red litmus already tested for current substance
                                if (currentSubstance === 'vinegar' && !state.vinegarRedLitmusTested) canAddThisLitmus = true;
                                if (currentSubstance === 'lemon-juice' && !state.lemonJuiceRedLitmusTested) canAddThisLitmus = true;
                                if (currentSubstance === 'soap-solution' && !state.soapSolutionRedLitmusTested) canAddThisLitmus = true;
                                if (currentSubstance === 'baking-soda' && !state.bakingSodaRedLitmusTested) canAddThisLitmus = true;
                            }
                        }
                        canDrag = hasTestTube && canAddThisLitmus;
                    }
                } else if (expId === 'salt-dissolution') {
                    // Salt-dissolution experiment: strict order - salt first, then sand after reset
                    // Water is always available when container present
                    // Salt available when water is added and salt not yet tested
                    // Sand available only after salt tested + reset
                    if (chem.id === 'water') {
                        canDrag = hasContainer;
                    } else if (chem.id === 'salt') {
                        // Salt only enabled if water is present, salt not tested yet, and no substance already added
                        const hasWater = state.addedChemicals.includes('water');
                        const hasSubstanceAlready = state.addedChemicals.includes('salt') || state.addedChemicals.includes('sand');
                        canDrag = hasContainer && hasWater && !state.saltTested && !hasSubstanceAlready;
                    } else if (chem.id === 'sand') {
                        // Sand only enabled after salt tested + reset
                        const hasWater = state.addedChemicals.includes('water');
                        const hasSubstanceAlready = state.addedChemicals.includes('salt') || state.addedChemicals.includes('sand');
                        // Must have reset (no salt in current session)
                        const hasReset = !state.addedChemicals.includes('salt') && state.resetAfterSaltTest;
                        canDrag = hasContainer && hasWater && state.saltTested && !state.sandTested && !hasSubstanceAlready && hasReset;
                    }
                } else if (expId === 'neutralization') {
                    // Strict order: NaOH first, then phenolphthalein, then HCl
                    const hasNaOH = state.addedChemicals.includes('naoh');
                    const hasPhenolphthalein = state.addedChemicals.includes('phenolphthalein');

                    if (chem.id === 'naoh') {
                        // NaOH is first - needs beaker
                        canDrag = hasContainer && !hasNaOH;
                    } else if (chem.id === 'phenolphthalein') {
                        // Phenolphthalein needs NaOH already added
                        canDrag = hasContainer && hasNaOH && !hasPhenolphthalein;
                    } else if (chem.id === 'hcl') {
                        // HCl needs NaOH, phenolphthalein, AND dropper placed
                        const hasDropper = state.placedApparatus.includes('dropper');
                        canDrag = hasContainer && hasNaOH && hasPhenolphthalein && hasDropper;
                    }
                } else {
                    canDrag = hasContainer;
                }

                const isDisabled = state.addedChemicals.includes(chem.id) || !canDrag;

                return `
                <div class="chemical-item ${isDisabled ? 'disabled' : ''}" 
                     draggable="${canDrag ? 'true' : 'false'}" 
                     data-type="chemical" 
                     data-id="${chem.id}">
                    <div class="bottle" style="background: ${chem.color}"></div>
                    <span class="name">${chem.name}</span>
                </div>
            `}).join('');

            // Add drag handlers for desktop
            chemicalShelf.querySelectorAll('.chemical-item:not(.disabled)').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);

                // Add tap/click handler for mobile
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleChemicalDrop(item.dataset.id);
                });
                item.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    handleChemicalDrop(item.dataset.id);
                }, { passive: false });
            });
        }

        function renderDropZone() {
            dropZone.innerHTML = '';
            const exp = state.currentExperiment;

            if (state.placedApparatus.length === 0) {
                dropZone.innerHTML = '<span class="drop-zone-hint">Tap or drag apparatus from the shelf </span>';
                return;
            }

            // Determine experiment type and render accordingly
            if (exp.id === 'filtration') {
                renderFiltrationSetup();
            } else if (exp.id === 'evaporation') {
                renderEvaporationSetup();
            } else if (exp.id === 'physical-chemical') {
                renderPhysicalChemicalSetup();
            } else if (exp.id === 'acids-bases') {
                renderAcidsBasesSetup();
            } else if (exp.id === 'neutralization') {
                renderNeutralizationSetup();
            } else {
                // Default: Salt dissolution experiment with beaker
                renderBeakerSetup();
            }
        }

        function renderBeakerSetup() {
            if (!state.placedApparatus.includes('beaker')) return;

            const hasGlassRod = state.placedApparatus.includes('glass-rod');
            const isStirring = state.lastStirTime && Date.now() - state.lastStirTime < 700;
            const stirClass = isStirring ? 'stir-animation' : '';
            const hasLiquid = state.addedChemicals.length > 0;

            const bubbles = isStirring && hasLiquid ? `
                <circle cx="25" cy="90" r="3" fill="rgba(255,255,255,0.6)" class="bubble" style="animation-delay: 0s"/>
                <circle cx="45" cy="95" r="2" fill="rgba(255,255,255,0.5)" class="bubble" style="animation-delay: 0.1s"/>
                <circle cx="65" cy="92" r="2.5" fill="rgba(255,255,255,0.55)" class="bubble" style="animation-delay: 0.2s"/>
            ` : '';

            // Determine if reset banner should be shown (after one test is complete but not both)
            // Only show if there's a completed test in the CURRENT session (chemicals present + stir done)
            // AND we're not currently testing the second substance
            let showResetBanner = false;
            let resetBannerText = 'Click RESET to Continue ';

            const bothTested = state.saltTested && state.sandTested;
            const hasCompletedCurrentTest = state.actions.includes('stir') && state.addedChemicals.length > 0;

            // Check what we're currently testing
            const currentlyTestingSalt = state.addedChemicals.includes('salt');
            const currentlyTestingSand = state.addedChemicals.includes('sand');

            // Only show banner if we've completed the FIRST test (salt/sand) and are still looking at it
            // Don't show if we're already testing the second substance
            if (!bothTested && hasCompletedCurrentTest) {
                if (state.saltTested && !state.sandTested && currentlyTestingSalt) {
                    // Just finished testing salt, prompt to test sand
                    showResetBanner = true;
                    resetBannerText = 'RESET - Now test SAND in water';
                } else if (state.sandTested && !state.saltTested && currentlyTestingSand) {
                    // Just finished testing sand, prompt to test salt
                    showResetBanner = true;
                    resetBannerText = 'RESET - Now test SALT in water';
                }
            }

            // SVG icons for reset banner
            const refreshIcon = '<svg viewBox="0 0 24 24" width="16" height="16" style="vertical-align:middle;margin-right:4px;"><path fill="currentColor" d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>';
            const arrowUpIcon = '<svg viewBox="0 0 24 24" width="18" height="18" style="vertical-align:middle;margin-right:6px;"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>';

            const beakerEl = document.createElement('div');
            beakerEl.className = 'placed-apparatus';
            beakerEl.innerHTML = `
                <div class="apparatus-visual" style="width:120px;height:160px;position:relative;">
                    ${showResetBanner ? `<div class="reset-banner" onclick="document.getElementById('resetBtn').click()">${arrowUpIcon}${refreshIcon}${resetBannerText}</div>` : ''}
                    <svg viewBox="0 0 100 140" class="beaker-svg" style="width:100%;height:100%;">
                        <defs>
                            <linearGradient id="liquidGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:${getLiquidColor()};stop-opacity:0.75"/>
                                <stop offset="100%" style="stop-color:${getLiquidColor()};stop-opacity:0.95"/>
                            </linearGradient>
                        </defs>
                        <rect x="10" y="${140 - getLiquidLevel() - 10}" width="80" height="${getLiquidLevel()}" rx="4" fill="url(#liquidGrad)"/>
                        ${bubbles}
                        ${renderParticles()}
                        ${hasGlassRod ? `
                            <g class="${stirClass}" style="transform-origin: 50px 10px;">
                                <rect x="47" y="5" width="6" height="105" rx="3" fill="rgba(200,220,250,0.5)" stroke="rgba(150,180,220,0.6)" stroke-width="1.5"/>
                                <ellipse cx="50" cy="108" rx="4" ry="2.5" fill="rgba(180,200,230,0.7)"/>
                            </g>
                        ` : ''}
                        <path d="M8 15 L8 125 Q8 135 18 135 L82 135 Q92 135 92 125 L92 15" fill="rgba(200,220,255,0.06)" stroke="rgba(150,180,220,0.5)" stroke-width="2.5"/>
                        <rect x="6" y="10" width="88" height="10" rx="2" fill="rgba(200,220,255,0.12)" stroke="rgba(150,180,220,0.4)" stroke-width="1"/>
                    </svg>
                </div>
                <span class="beaker-label">Beaker${hasGlassRod ? ' + Glass Rod' : ''}</span>
            `;
            dropZone.appendChild(beakerEl);
        }

        function renderFiltrationSetup() {
            const hasBeaker = state.placedApparatus.includes('beaker');
            const hasFunnel = state.placedApparatus.includes('funnel');
            const hasFilterPaper = state.placedApparatus.includes('filter-paper');
            const hasLiquid = state.addedChemicals.includes('muddy-water');
            const hasPoured = state.actions.includes('pour');
            const hasFiltered = state.actions.includes('filter');

            // Animation states - these determine which CSS classes to apply
            const isPouringAnim = hasPoured && !hasFiltered;

            const setupEl = document.createElement('div');
            setupEl.className = 'placed-apparatus filtration-setup';
            setupEl.innerHTML = `
                <div class="apparatus-visual" style="width:240px;height:180px;position:relative;">
                    <svg viewBox="0 0 240 180" style="width:100%;height:100%;">
                        <defs>
                            <linearGradient id="muddyGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#9b8365;stop-opacity:0.85"/>
                                <stop offset="100%" style="stop-color:#6b5344;stop-opacity:0.95"/>
                            </linearGradient>
                            <linearGradient id="clearGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#c8e0ff;stop-opacity:0.7"/>
                                <stop offset="100%" style="stop-color:#a8d0ff;stop-opacity:0.9"/>
                            </linearGradient>
                        </defs>
                        
                        <!-- LEFT: Source beaker - tilts when pouring -->
                        ${hasBeaker ? `
                            <g class="${isPouringAnim ? 'beaker-tilt' : ''}" style="transform-origin: 55px 115px;">
                                <!-- Muddy water - uses CSS animation to drain -->
                                ${hasLiquid && !hasFiltered ? `
                                    <rect class="${isPouringAnim ? 'liquid-drain' : ''}" 
                                          x="10" y="55" width="50" height="${hasFiltered ? 0 : 50}" rx="3" fill="url(#muddyGrad)"/>
                                    <circle cx="22" cy="85" r="4" fill="#5a4535" class="${isPouringAnim ? 'liquid-drain' : ''}"/>
                                    <circle cx="38" cy="90" r="3" fill="#6b5344" class="${isPouringAnim ? 'liquid-drain' : ''}"/>
                                ` : ''}
                                <!-- Beaker glass -->
                                <path d="M6 30 L6 105 Q6 115 16 115 L54 115 Q64 115 64 105 L64 30" 
                                      fill="rgba(200,220,255,0.08)" stroke="rgba(150,180,220,0.5)" stroke-width="2"/>
                                <rect x="4" y="25" width="62" height="8" rx="2" fill="rgba(200,220,255,0.12)"/>
                                <path d="M62 30 L72 25 L72 38 L62 33" fill="rgba(200,220,255,0.1)" stroke="rgba(150,180,220,0.4)"/>
                            </g>
                            <text x="35" y="${isPouringAnim ? 145 : 135}" text-anchor="middle" font-size="10" fill="rgba(255,255,255,0.8)">Source</text>
                        ` : ''}
                        
                        <!-- Pouring stream - shows during pour animation -->
                        ${isPouringAnim ? `
                            <g class="pour-stream-group">
                                <path d="M72 45 Q110 25 145 45 Q155 55 160 65" 
                                      fill="none" stroke="#8b7355" stroke-width="6" 
                                      class="pour-stream" stroke-linecap="round"/>
                                <ellipse cx="160" cy="68" rx="5" ry="3" fill="#8b7355" opacity="0.8"/>
                            </g>
                        ` : ''}
                        
                        <!-- Collection beaker - shows as soon as beaker is placed -->
                        ${hasBeaker ? `
                            <g transform="translate(120, 60)">
                                <!-- Clear water - fills up during/after pour -->
                                ${hasPoured ? `
                                    <rect class="${isPouringAnim ? 'liquid-fill' : ''}" 
                                          x="12" y="${hasFiltered ? 35 : 55}" 
                                          width="56" height="${hasFiltered ? 45 : 25}" rx="3" fill="url(#clearGrad)"/>
                                ` : ''}
                                <!-- Beaker glass -->
                                <path d="M8 5 L8 75 Q8 85 18 85 L62 85 Q72 85 72 75 L72 5" 
                                      fill="rgba(200,220,255,0.08)" stroke="rgba(150,180,220,0.5)" stroke-width="2"/>
                                <rect x="6" y="0" width="68" height="8" rx="2" fill="rgba(200,220,255,0.12)"/>
                            </g>
                            <text x="160" y="165" text-anchor="middle" font-size="10" fill="rgba(255,255,255,0.8)">Collection</text>
                        ` : ''}
                        
                        <!-- Funnel with filter paper -->
                        ${hasFunnel ? `
                            <g transform="translate(120, 12)">
                                <!-- Muddy water accumulating in funnel -->
                                ${isPouringAnim ? `
                                    <path d="M12 35 L40 55 L68 35 Z" fill="url(#muddyGrad)" class="funnel-fill"/>
                                    <circle cx="28" cy="42" r="3" fill="#5a4535"/>
                                    <circle cx="52" cy="40" r="2.5" fill="#6b5344"/>
                                ` : ''}
                                
                                <!-- Mud residue after filtering -->
                                ${hasFiltered ? `
                                    <path d="M18 28 L40 48 L62 28" fill="#6b5344"/>
                                ` : ''}
                                
                                <!-- Filter paper -->
                                ${hasFilterPaper ? `
                                    <path d="M5 18 L40 56 L75 18" 
                                          fill="${hasPoured ? 'rgba(170,150,120,0.9)' : 'rgba(255,252,245,0.92)'}" 
                                          stroke="rgba(200,190,170,0.8)" stroke-width="1.5"/>
                                ` : ''}
                                
                                <!-- Funnel glass -->
                                <path d="M2 15 L40 60 L78 15" fill="none" stroke="rgba(150,180,220,0.7)" stroke-width="2.5"/>
                                <rect x="36" y="55" width="8" height="18" fill="rgba(150,180,220,0.3)" stroke="rgba(150,180,220,0.6)" stroke-width="1.5" rx="1"/>
                            </g>
                        ` : ''}
                        
                        <!-- Dripping droplets - continuous during pour -->
                        ${isPouringAnim && hasFunnel ? `
                            <circle cx="160" cy="88" r="3" fill="#c8e0ff" class="drip-drop"/>
                            <circle cx="160" cy="88" r="2.5" fill="#c8e0ff" class="drip-drop" style="animation-delay: 0.25s"/>
                            <circle cx="160" cy="88" r="2" fill="#c8e0ff" class="drip-drop" style="animation-delay: 0.5s"/>
                        ` : ''}
                        
                    </svg>
                </div>
                <span class="beaker-label">${getFilterLabel()}</span>
            `;
            dropZone.appendChild(setupEl);
            // NO re-render loop - CSS handles all animations
        }

        function getFilterLabel() {
            const parts = [];
            if (state.placedApparatus.includes('beaker')) parts.push('Beaker');
            if (state.placedApparatus.includes('funnel')) parts.push('Funnel');
            if (state.placedApparatus.includes('filter-paper')) parts.push('Filter Paper');
            return parts.join(' + ') || 'Drop apparatus';
        }

        function renderEvaporationSetup() {
            const hasDish = state.placedApparatus.includes('china-dish');
            const hasTripod = state.placedApparatus.includes('tripod-stand');
            const hasBurner = state.placedApparatus.includes('burner');
            const hasLiquid = state.addedChemicals.includes('salt-solution');
            const isHeating = state.heatLevel > 30;
            const isEvaporating = state.isEvaporating;
            const isEvaporated = state.actions.includes('evaporate');

            // Steam animation
            const steamAnimation = (isHeating || isEvaporating) && hasLiquid && !isEvaporated ? `
                <g class="steam-group">
                    <path d="M70 20 Q75 10 70 0 Q65 -10 70 -20" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="3" class="steam"/>
                    <path d="M82 25 Q87 13 82 3 Q77 -7 82 -17" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="2" class="steam" style="animation-delay: 0.3s"/>
                    <path d="M58 25 Q53 13 58 3 Q63 -7 58 -17" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="2" class="steam" style="animation-delay: 0.5s"/>
                </g>
            ` : '';

            // Crystals - light blue tint for visibility
            let crystalsSvg = '';
            if (isEvaporating || isEvaporated) {
                const animClass = isEvaporating ? 'crystals-during-evaporation' : 'crystals-forming';
                crystalsSvg = `
                    <g class="${animClass}">
                        <rect x="50" y="42" width="5" height="4" fill="#cce0f0" stroke="#99b8d0" stroke-width="0.5" rx="1"/>
                        <rect x="58" y="40" width="7" height="6" fill="#d4e8f8" stroke="#a8c8e0" stroke-width="0.5" rx="1"/>
                        <rect x="68" y="41" width="6" height="5" fill="#c8dcf0" stroke="#98b8d0" stroke-width="0.5" rx="1"/>
                        <rect x="77" y="42" width="5" height="4" fill="#d0e4f4" stroke="#a0c0d8" stroke-width="0.5" rx="1"/>
                        <rect x="63" y="44" width="4" height="3" fill="#d8ecf8" stroke="#b0d0e8" stroke-width="0.5" rx="1"/>
                    </g>
                `;
            }

            // Liquid
            let liquidSvg = '';
            if (hasLiquid && !isEvaporated) {
                const animClass = isEvaporating ? 'class="liquid-evaporating"' : '';
                liquidSvg = `<ellipse cx="70" cy="44" rx="28" ry="8" fill="url(#solutionGrad)" ${animClass}/>`;
            }

            // Flame - positioned to rise from below tripod ring
            const flameAnimation = (isHeating || isEvaporating) ? `
                <g class="flame-group">
                    <!-- Blue Bunsen flame -->
                    <ellipse cx="70" cy="85" rx="8" ry="5" fill="#3b82f6" opacity="0.3"/>
                    <ellipse cx="70" cy="78" rx="6" ry="10" fill="#60a5fa" opacity="0.5"/>
                    <ellipse cx="70" cy="72" rx="4" ry="7" fill="#93c5fd" opacity="0.7"/>
                    <ellipse cx="70" cy="68" rx="2" ry="4" fill="#dbeafe" opacity="0.85"/>
                </g>
            ` : '';

            const setupEl = document.createElement('div');
            setupEl.className = 'placed-apparatus evaporation-setup';
            setupEl.innerHTML = `
                <div class="apparatus-visual" style="width:180px;height:180px;position:relative;">
                    <svg viewBox="0 0 140 160" style="width:100%;height:100%;">
                        <defs>
                            <linearGradient id="solutionGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#e8f4ff;stop-opacity:0.7"/>
                                <stop offset="100%" style="stop-color:#d0e8ff;stop-opacity:0.9"/>
                            </linearGradient>
                            <linearGradient id="metalGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#555"/>
                                <stop offset="50%" style="stop-color:#777"/>
                                <stop offset="100%" style="stop-color:#444"/>
                            </linearGradient>
                            <linearGradient id="burnerBodyGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#404040"/>
                                <stop offset="50%" style="stop-color:#555"/>
                                <stop offset="100%" style="stop-color:#353535"/>
                            </linearGradient>
                        </defs>
                        
                        <!-- Steam rising from dish -->
                        ${steamAnimation}
                        
                        <!-- China dish at top -->
                        ${hasDish ? `
                            <ellipse cx="70" cy="50" rx="38" ry="12" fill="#eae8e0" stroke="#c8c0b8" stroke-width="1.5"/>
                            <ellipse cx="70" cy="46" rx="33" ry="9" fill="#f5f4f0"/>
                            <ellipse cx="70" cy="44" rx="30" ry="7" fill="#fafaf8"/>
                            ${liquidSvg}
                            ${crystalsSvg}
                        ` : ''}
                        
                        <!-- Tripod Stand - 3 legs splaying outward, NO center leg -->
                        ${hasTripod ? `
                            <!-- Wire ring at top -->
                            <ellipse cx="70" cy="60" rx="32" ry="7" fill="none" stroke="#666" stroke-width="2.5"/>
                            <!-- Three legs splaying outward to ground -->
                            <line x1="42" y1="62" x2="25" y2="145" stroke="url(#metalGrad)" stroke-width="4" stroke-linecap="round"/>
                            <line x1="98" y1="62" x2="115" y2="145" stroke="url(#metalGrad)" stroke-width="4" stroke-linecap="round"/>
                            <line x1="70" y1="67" x2="70" y2="148" stroke="url(#metalGrad)" stroke-width="4" stroke-linecap="round"/>
                        ` : ''}
                        
                        <!-- Bunsen Burner - centered below tripod -->
                        ${hasBurner ? `
                            <!-- Flame rises through tripod center -->
                            ${flameAnimation}
                            <!-- Burner tube -->
                            <rect x="64" y="92" width="12" height="35" rx="2" fill="url(#burnerBodyGrad)"/>
                            <!-- Collar at top -->
                            <rect x="62" y="90" width="16" height="4" rx="1" fill="#505050"/>
                            <!-- Nozzle opening -->
                            <ellipse cx="70" cy="90" rx="4" ry="1.5" fill="#1a1a1a"/>
                            <!-- Air holes -->
                            <ellipse cx="66" cy="115" rx="1" ry="2.5" fill="#222"/>
                            <ellipse cx="74" cy="115" rx="1" ry="2.5" fill="#222"/>
                            <!-- Base -->
                            <rect x="58" y="127" width="24" height="8" rx="2" fill="url(#burnerBodyGrad)"/>
                            <rect x="55" y="133" width="30" height="5" rx="2" fill="#353535"/>
                            <!-- Gas tube going to side -->
                            <path d="M64 135 Q45 138 30 140" stroke="#444" stroke-width="4" fill="none" stroke-linecap="round"/>
                        ` : ''}
                        
                    </svg>
                </div>
                <span class="beaker-label">${getEvaporationLabel()}</span>
            `;
            dropZone.appendChild(setupEl);
        }

        function getEvaporationLabel() {
            const parts = [];
            if (state.placedApparatus.includes('china-dish')) parts.push('China Dish');
            if (state.placedApparatus.includes('tripod-stand')) parts.push('Tripod Stand');
            if (state.placedApparatus.includes('burner')) parts.push('Burner');
            return parts.join(' + ') || 'Drop apparatus';
        }

        function renderPhysicalChemicalSetup() {
            const hasBeaker = state.placedApparatus.includes('beaker');
            const hasBurner = state.placedApparatus.includes('burner');
            const hasTongs = state.placedApparatus.includes('tongs');
            const hasTripodStand = state.placedApparatus.includes('tripod-stand');
            const isHeating = state.heatLevel > 30;

            const substance = state.addedChemicals[0];
            const reactionKey = getReactionKey();
            const reaction = state.currentExperiment.reactions[reactionKey];

            // Determine if the substance has reacted - once reacted, it stays reacted
            // Use the tracked test states to make changes permanent (don't reverse when heat is reduced)
            let hasReacted = false;
            if (substance === 'ice' && (state.iceTested || (reaction && isHeating))) {
                hasReacted = true;
            } else if (substance === 'paper' && (state.paperTested || (reaction && isHeating))) {
                hasReacted = true;
            } else if (substance === 'magnesium' && (state.magnesiumTested || (reaction && isHeating))) {
                hasReacted = true;
            }

            // Build content based on substance
            let contentSvg = '';
            let effectsSvg = '';

            if (substance === 'ice') {
                if (hasReacted) {
                    // Melted ice = water with steam
                    contentSvg = `
                        <ellipse cx="70" cy="85" rx="30" ry="15" fill="#b8e0ff" opacity="0.7"/>
                        <ellipse cx="70" cy="82" rx="25" ry="12" fill="#c8ecff" opacity="0.6"/>
                    `;
                    effectsSvg = `
                        <g class="steam-group">
                            <path d="M60 60 Q65 50 60 40" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2" class="steam"/>
                            <path d="M80 60 Q75 50 80 40" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2" class="steam" style="animation-delay:0.3s"/>
                        </g>
                    `;
                } else if (substance) {
                    // Ice cubes - 3D look
                    contentSvg = `
                        <g>
                            <!-- Ice cube 1 -->
                            <rect x="45" y="65" width="18" height="20" fill="#d8f4ff" stroke="#a0d8f0" rx="2"/>
                            <rect x="45" y="65" width="18" height="5" fill="#e8faff" rx="2"/>
                            <!-- Ice cube 2 -->
                            <rect x="68" y="68" width="16" height="18" fill="#d0f0ff" stroke="#98d0e8" rx="2"/>
                            <rect x="68" y="68" width="16" height="4" fill="#e4f8ff" rx="2"/>
                            <!-- Ice cube 3 -->
                            <rect x="55" y="78" width="14" height="15" fill="#dcf6ff" stroke="#a8daf0" rx="2"/>
                            <rect x="55" y="78" width="14" height="3" fill="#ecfcff" rx="2"/>
                        </g>
                    `;
                }
            } else if (substance === 'paper') {
                if (hasReacted) {
                    // Burnt paper ash - show flames/smoke only if actively heating
                    const showFlames = isHeating && reaction;
                    contentSvg = `
                        <!-- Tongs holding the burnt paper ash -->
                        ${hasTongs && !hasBeaker ? `
                            <line x1="20" y1="100" x2="55" y2="80" stroke="#666" stroke-width="4" stroke-linecap="round"/>
                            <line x1="20" y1="110" x2="55" y2="110" stroke="#666" stroke-width="4" stroke-linecap="round"/>
                            <circle cx="20" cy="105" r="5" fill="#555"/>
                            <!-- Realistic flaky ash structure held in tongs -->
                            <!-- Main ash body - irregular, crumbly shape -->
                            <path d="M55 82 L58 78 L65 80 L72 77 L78 80 L80 85 L82 92 L80 100 L78 107 L72 110 L65 108 L58 110 L55 105 L54 95 Z" 
                                  fill="${showFlames ? '#2a2a2a' : '#1f1f1f'}" stroke="#1a1a1a" stroke-width="0.5"/>
                            <!-- Flaky ash layers -->
                            <path d="M57 84 L62 82 L68 84 L73 81 L77 84" fill="none" stroke="${showFlames ? '#404040' : '#353535'}" stroke-width="1.5"/>
                            <path d="M56 90 L60 88 L66 91 L72 88 L78 90" fill="none" stroke="${showFlames ? '#383838' : '#2e2e2e'}" stroke-width="1"/>
                            <path d="M58 96 L63 94 L69 97 L75 94 L79 96" fill="none" stroke="${showFlames ? '#454545' : '#3a3a3a'}" stroke-width="1"/>
                            <path d="M57 102 L61 100 L67 103 L73 100 L77 102" fill="none" stroke="${showFlames ? '#3a3a3a' : '#303030'}" stroke-width="1"/>
                            <!-- Charred edges and cracks -->
                            <line x1="60" y1="85" x2="62" y2="95" stroke="#1a1a1a" stroke-width="0.5"/>
                            <line x1="70" y1="83" x2="68" y2="98" stroke="#1a1a1a" stroke-width="0.5"/>
                            <line x1="75" y1="86" x2="76" y2="100" stroke="#1a1a1a" stroke-width="0.5"/>
                            <!-- Glowing embers on edges - only when actively heating -->
                            ${showFlames ? `
                                <ellipse cx="80" cy="88" rx="2" ry="3" fill="#ff4500" opacity="0.7"/>
                                <ellipse cx="55" cy="95" rx="1.5" ry="2" fill="#ff6b35" opacity="0.5"/>
                                <ellipse cx="78" cy="105" rx="1" ry="1.5" fill="#ff8c00" opacity="0.4"/>
                            ` : `
                                <!-- Cooled ash - no embers, slight gray dust -->
                                <ellipse cx="68" cy="112" rx="8" ry="2" fill="#2a2a2a" opacity="0.3"/>
                            `}
                        ` : ''}
                    `;
                    // Flames and smoke only when actively heating
                    effectsSvg = showFlames ? `
                        <!-- Fire flames above the tongs position -->
                        <g class="fire-group">
                            <ellipse cx="68" cy="70" rx="10" ry="15" fill="#ff4500" opacity="0.8" class="steam"/>
                            <ellipse cx="68" cy="62" rx="7" ry="10" fill="#ff6b35" opacity="0.9" class="steam" style="animation-delay:0.1s"/>
                            <ellipse cx="68" cy="55" rx="4" ry="7" fill="#ffcc00" opacity="0.85" class="steam" style="animation-delay:0.2s"/>
                            <ellipse cx="68" cy="50" rx="2" ry="4" fill="#fff" opacity="0.6" class="steam" style="animation-delay:0.3s"/>
                        </g>
                        <!-- Smoke rising from burnt paper -->
                        <g class="steam-group">
                            <path d="M68 42 Q73 32 68 22" fill="none" stroke="rgba(80,80,80,0.5)" stroke-width="4" class="steam"/>
                            <path d="M62 48 Q57 38 62 28" fill="none" stroke="rgba(60,60,60,0.4)" stroke-width="3" class="steam" style="animation-delay:0.2s"/>
                        </g>
                    ` : `
                        <!-- Light wisps of residual smoke when cooled -->
                        <g class="steam-group" opacity="0.3">
                            <path d="M68 72 Q71 65 68 58" fill="none" stroke="rgba(60,60,60,0.3)" stroke-width="2" class="steam"/>
                        </g>
                    `;
                } else if (substance) {
                    // Paper strip with tongs - position depends on if beaker is present
                    if (hasBeaker) {
                        // Inside beaker
                        contentSvg = `
                            <rect x="50" y="50" width="35" height="45" fill="#f8f8dc" stroke="#e0d8b0" stroke-width="1" rx="2"/>
                            <line x1="55" y1="60" x2="80" y2="60" stroke="#ddd8c0" stroke-width="1"/>
                            <line x1="55" y1="70" x2="80" y2="70" stroke="#ddd8c0" stroke-width="1"/>
                            <line x1="55" y1="80" x2="75" y2="80" stroke="#ddd8c0" stroke-width="1"/>
                        `;
                    } else if (hasTongs) {
                        // Held by tongs over flame (closer to flame)
                        contentSvg = `
                            <!-- Tongs holding paper over flame -->
                            <line x1="20" y1="100" x2="55" y2="80" stroke="#666" stroke-width="4" stroke-linecap="round"/>
                            <line x1="20" y1="110" x2="55" y2="110" stroke="#666" stroke-width="4" stroke-linecap="round"/>
                            <circle cx="20" cy="105" r="5" fill="#555"/>
                            <!-- Paper strip positioned over flame -->
                            <rect x="55" y="75" width="30" height="40" fill="#f8f8dc" stroke="#e0d8b0" stroke-width="1" rx="2"/>
                            <line x1="60" y1="85" x2="80" y2="85" stroke="#ddd8c0" stroke-width="1"/>
                            <line x1="60" y1="95" x2="80" y2="95" stroke="#ddd8c0" stroke-width="1"/>
                        `;
                    }
                }
            } else if (substance === 'magnesium') {
                if (hasReacted) {
                    // MgO powder - show brilliant flame only if actively heating
                    const showBrightFlame = isHeating && reaction;
                    // When cooled, MgO becomes slightly grayer
                    const powderColor = showBrightFlame ? '#fff' : '#f0f0f0';
                    const powderColorLight = showBrightFlame ? '#fafafa' : '#e8e8e8';
                    const powderColorDark = showBrightFlame ? '#f8f8f8' : '#e0e0e0';
                    contentSvg = `
                        <!-- Tongs holding white MgO powder -->
                        ${hasTongs && !hasBeaker ? `
                            <line x1="25" y1="100" x2="55" y2="90" stroke="#666" stroke-width="4" stroke-linecap="round"/>
                            <line x1="25" y1="110" x2="55" y2="100" stroke="#666" stroke-width="4" stroke-linecap="round"/>
                            <circle cx="25" cy="105" r="5" fill="#555"/>
                            <!-- Fine white MgO powder held in tongs -->
                            <!-- Main powder mass -->
                            <ellipse cx="70" cy="92" rx="18" ry="8" fill="${powderColorLight}" stroke="#e8e8e8" stroke-width="0.5"/>
                            <ellipse cx="70" cy="90" rx="15" ry="6" fill="${powderColor}"/>
                            <!-- Powder particle texture -->
                            <circle cx="58" cy="90" r="2" fill="${powderColor}"/>
                            <circle cx="62" cy="88" r="1.5" fill="${powderColorDark}"/>
                            <circle cx="66" cy="91" r="2" fill="${powderColor}"/>
                            <circle cx="70" cy="87" r="1.8" fill="${powderColorLight}"/>
                            <circle cx="74" cy="90" r="2" fill="${powderColor}"/>
                            <circle cx="78" cy="88" r="1.5" fill="${powderColorDark}"/>
                            <circle cx="82" cy="91" r="2" fill="${powderColor}"/>
                            <!-- Scattered powder particles -->
                            <circle cx="60" cy="95" r="1" fill="${powderColor}"/>
                            <circle cx="68" cy="96" r="1.2" fill="${powderColorLight}"/>
                            <circle cx="75" cy="94" r="1" fill="${powderColor}"/>
                            <circle cx="80" cy="95" r="0.8" fill="${powderColorDark}"/>
                            <!-- Powder highlight shimmer - brighter when hot -->
                            <ellipse cx="68" cy="88" rx="6" ry="2" fill="${powderColor}" opacity="${showBrightFlame ? '0.8' : '0.4'}"/>
                            ${!showBrightFlame ? `
                                <!-- Cooled powder - slight shadow underneath -->
                                <ellipse cx="70" cy="98" rx="12" ry="3" fill="#d0d0d0" opacity="0.3"/>
                            ` : ''}
                        ` : ''}
                    `;
                    // Brilliant white flame only when actively heating
                    effectsSvg = showBrightFlame ? `
                        <!-- Brilliant white flame (characteristic of Mg burning) above tongs -->
                        <g class="bright-flame">
                            <ellipse cx="70" cy="70" rx="22" ry="28" fill="#fff" opacity="0.95" class="steam"/>
                            <ellipse cx="70" cy="62" rx="16" ry="20" fill="#ffffee" opacity="0.9" class="steam" style="animation-delay:0.1s"/>
                            <ellipse cx="70" cy="55" rx="10" ry="14" fill="#fffff0" opacity="0.85"/>
                        </g>
                    ` : `
                        <!-- Light heat shimmer when cooled but still warm -->
                        <g class="steam-group" opacity="0.2">
                            <ellipse cx="70" cy="78" rx="10" ry="4" fill="#fff" opacity="0.3"/>
                        </g>
                    `;
                } else if (substance) {
                    // Magnesium ribbon with tongs - position depends on if beaker is present
                    if (hasBeaker) {
                        // Inside or near beaker
                        contentSvg = `
                            <!-- Magnesium ribbon (shiny silver) -->
                            <rect x="55" y="60" width="35" height="8" fill="url(#mgRibbonGrad)" stroke="#aaa" stroke-width="0.5" rx="1"/>
                            <rect x="57" y="62" width="31" height="2" fill="#fff" opacity="0.4" rx="1"/>
                        `;
                    } else if (hasTongs) {
                        // Held by tongs over flame
                        contentSvg = `
                            <!-- Tongs holding magnesium over flame -->
                            <line x1="25" y1="100" x2="55" y2="90" stroke="#666" stroke-width="4" stroke-linecap="round"/>
                            <line x1="25" y1="110" x2="55" y2="100" stroke="#666" stroke-width="4" stroke-linecap="round"/>
                            <circle cx="25" cy="105" r="5" fill="#555"/>
                            <!-- Magnesium ribbon positioned over flame -->
                            <rect x="55" y="85" width="35" height="8" fill="url(#mgRibbonGrad)" stroke="#aaa" stroke-width="0.5" rx="1"/>
                            <rect x="57" y="87" width="31" height="2" fill="#fff" opacity="0.4" rx="1"/>
                        `;
                    }
                }
            }

            // Show idle tongs when placed but no chemical added yet
            if (!substance && hasTongs && !hasBeaker) {
                contentSvg = `
                    <!-- Idle tongs waiting for substance -->
                    <line x1="25" y1="90" x2="60" y2="75" stroke="#666" stroke-width="4" stroke-linecap="round"/>
                    <line x1="25" y1="100" x2="60" y2="95" stroke="#666" stroke-width="4" stroke-linecap="round"/>
                    <circle cx="25" cy="95" r="5" fill="#555"/>
                    <text x="70" y="85" font-size="10" fill="#888" text-anchor="middle">Ready</text>
                `;
            }

            // Bunsen burner flame (blue) - positioned between tripod and burner nozzle
            const flameSvg = isHeating && hasBurner ? `
                <g class="flame-group">
                    <ellipse cx="70" cy="148" rx="7" ry="4" fill="#3b82f6" opacity="0.3"/>
                    <ellipse cx="70" cy="142" rx="5" ry="8" fill="#60a5fa" opacity="0.5"/>
                    <ellipse cx="70" cy="136" rx="3" ry="6" fill="#93c5fd" opacity="0.7"/>
                    <ellipse cx="70" cy="132" rx="2" ry="3" fill="#dbeafe" opacity="0.85"/>
                </g>
            ` : '';

            // Determine if reset banner should be shown (after a test is complete but not all tests done)
            let showResetBanner = false;
            const resetSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: text-bottom; margin-right: 4px;"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>';
            const arrowSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: text-bottom;"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>';
            let resetBannerText = `Click RESET to Continue ${arrowSvg}`;

            const allMaterialsTested = state.iceTested && state.paperTested && state.magnesiumTested;

            if (hasReacted && !allMaterialsTested) {
                showResetBanner = true;

                // Customize message based on what's next
                if (substance === 'ice' && state.iceTested && !state.paperTested) {
                    resetBannerText = `${resetSvg} RESET  Test Paper (chemical change) next`;
                } else if (substance === 'paper' && state.paperTested && !state.magnesiumTested) {
                    resetBannerText = `${resetSvg} RESET  Test Magnesium next`;
                } else if (substance === 'ice' && !state.iceTested) {
                    // Currently heating ice - will show banner once it's tested
                    showResetBanner = false;
                } else if (substance === 'paper' && !state.paperTested) {
                    showResetBanner = false;
                } else if (substance === 'magnesium' && !state.magnesiumTested) {
                    showResetBanner = false;
                }
            }

            const setupEl = document.createElement('div');
            setupEl.className = 'placed-apparatus physical-chemical-setup';
            setupEl.innerHTML = `
                <div class="apparatus-visual" style="width:180px;height:200px;position:relative;">
                    ${showResetBanner ? `<div class="reset-banner" onclick="document.getElementById('resetBtn').click()"><span class="arrow-icon">${arrowSvg}</span>${resetBannerText}</div>` : ''}
                    <svg viewBox="0 0 140 185" style="width:100%;height:100%;">
                        <defs>
                            <linearGradient id="mgRibbonGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#e8e8e8"/>
                                <stop offset="50%" style="stop-color:#d0d0d0"/>
                                <stop offset="100%" style="stop-color:#c0c0c0"/>
                            </linearGradient>
                            <linearGradient id="burnerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#404040"/>
                                <stop offset="50%" style="stop-color:#555"/>
                                <stop offset="100%" style="stop-color:#353535"/>
                            </linearGradient>
                        </defs>
                        
                        <!-- Effects (fire, steam) -->
                        ${effectsSvg}
                        
                        <!-- Beaker (only for ice) -->
                        ${hasBeaker ? `
                            <path d="M35 35 L35 100 Q35 110 45 110 L95 110 Q105 110 105 100 L105 35" 
                                  fill="rgba(200,220,255,0.1)" stroke="rgba(150,180,220,0.6)" stroke-width="2"/>
                            <rect x="33" y="30" width="74" height="7" rx="2" fill="rgba(200,220,255,0.15)"/>
                            <!-- Beaker graduations -->
                            <line x1="37" y1="50" x2="43" y2="50" stroke="rgba(150,180,220,0.4)" stroke-width="1"/>
                            <line x1="37" y1="70" x2="43" y2="70" stroke="rgba(150,180,220,0.4)" stroke-width="1"/>
                            <line x1="37" y1="90" x2="43" y2="90" stroke="rgba(150,180,220,0.4)" stroke-width="1"/>
                        ` : ''}
                        
                        <!-- Content (substance) -->
                        ${contentSvg}
                        
                        <!-- Tripod Stand - shows when tripod-stand is placed -->
                        ${hasTripodStand ? `
                            <!-- Wire gauze ring -->
                            <ellipse cx="70" cy="115" rx="28" ry="6" fill="none" stroke="#666" stroke-width="2"/>
                            <!-- Three legs - extended to bottom -->
                            <line x1="45" y1="118" x2="25" y2="180" stroke="#666" stroke-width="3" stroke-linecap="round"/>
                            <line x1="95" y1="118" x2="115" y2="180" stroke="#666" stroke-width="3" stroke-linecap="round"/>
                            <line x1="70" y1="121" x2="70" y2="180" stroke="#666" stroke-width="3" stroke-linecap="round"/>
                        ` : ''}
                        
                        <!-- Bunsen Burner -->
                        ${hasBurner ? `
                            <!-- Flame -->
                            ${flameSvg}
                            <!-- Burner tube -->
                            <rect x="65" y="155" width="10" height="20" rx="2" fill="url(#burnerGrad)"/>
                            <!-- Collar -->
                            <rect x="63" y="153" width="14" height="3" rx="1" fill="#505050"/>
                            <!-- Nozzle -->
                            <ellipse cx="70" cy="153" rx="3" ry="1" fill="#1a1a1a"/>
                            <!-- Base -->
                            <rect x="60" y="173" width="20" height="5" rx="2" fill="url(#burnerGrad)"/>
                            <!-- Gas tube -->
                            <path d="M65 176 Q50 178 35 178" stroke="#444" stroke-width="3" fill="none" stroke-linecap="round"/>
                        ` : ''}
                        
                    </svg>
                </div>
                <span class="beaker-label">${getPhysicalChemicalLabel(substance, hasReacted)}</span>
            `;
            dropZone.appendChild(setupEl);
        }

        function getPhysicalChemicalLabel(substance, hasReacted) {
            if (!substance) return 'Add a substance';
            const names = {
                'ice': hasReacted ? 'Water (melted ice)' : 'Ice Cubes',
                'paper': hasReacted ? 'Ash (burnt paper)' : 'Paper Strip',
                'magnesium': hasReacted ? 'MgO (magnesium oxide)' : 'Magnesium Ribbon'
            };
            return names[substance] || substance;
        }

        function renderAcidsBasesSetup() {
            const hasTestTube = state.placedApparatus.includes('test-tube');
            const hasStand = state.placedApparatus.includes('test-tube-stand');
            const hasDropper = state.placedApparatus.includes('dropper');

            // Get the substance (acid or base) and indicator
            const substances = ['vinegar', 'lemon-juice', 'soap-solution', 'baking-soda'];
            const indicators = ['blue-litmus', 'red-litmus'];

            const substance = state.addedChemicals.find(c => substances.includes(c));
            const indicator = state.addedChemicals.find(c => indicators.includes(c));

            // Get reaction result
            const reactionKey = getReactionKey();
            const exp = state.currentExperiment;
            const reaction = exp.reactions[reactionKey];
            const hasReaction = reaction && reaction.visual;

            // Determine liquid color - with gradual transition during animation
            let liquidColor = '#fff8e0'; // default
            let originalColor = '#fff8e0';
            let finalColor = '#fff8e0';

            // Get the original substance color
            if (substance) {
                const chemData = exp.chemicals.find(c => c.id === substance);
                if (chemData) {
                    originalColor = chemData.color;
                    liquidColor = chemData.color;
                }
            }

            // Get the final reaction color
            if (hasReaction && reaction.visual.liquidColor) {
                finalColor = reaction.visual.liquidColor;
            } else {
                finalColor = originalColor;
            }

            // During animation, interpolate between original and final color
            if (state.litmusAnimating && indicator) {
                const progress = state.litmusDropCount / 4; // 4 total drops
                liquidColor = interpolateColor(originalColor, finalColor, progress);
            } else if (hasReaction && reaction.visual.liquidColor) {
                liquidColor = reaction.visual.liquidColor;
            }

            // Indicator color for the dropper
            let indicatorColor = indicator === 'blue-litmus' ? '#4169e1' : (indicator === 'red-litmus' ? '#dc143c' : '');

            // Check if a drop is currently falling (within 400ms of last drop)
            const isDropFalling = state.litmusAnimating && state.lastDropTime && (Date.now() - state.lastDropTime < 400);

            // Determine result badge - only show when animation is complete
            let resultBadge = '';
            if (!state.litmusAnimating && reaction && reaction.resultType === 'acid') {
                resultBadge = '<span style="background:#ff4444;color:#fff;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:bold;">ACID </span>';
            } else if (!state.litmusAnimating && reaction && reaction.resultType === 'base') {
                resultBadge = '<span style="background:#4444ff;color:#fff;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:bold;">BASE </span>';
            }

            // Determine if reset banner should be shown (after a test is complete but not all tests done)
            let showResetBanner = false;
            const resetSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: text-bottom; margin-right: 4px;"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>';
            const arrowSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: text-bottom;"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>';
            let resetBannerText = `Click RESET to Continue ${arrowSvg}`;

            if (!state.litmusAnimating && reaction && reaction.success && !areAllAcidsBasesTested()) {
                showResetBanner = true;

                // Customize message based on what's next
                if (substance === 'vinegar') {
                    if (!state.vinegarRedLitmusTested && indicator === 'blue-litmus') {
                        resetBannerText = `${resetSvg} RESET  Test with Red Litmus`;
                    } else if (!isLemonJuiceTested()) {
                        resetBannerText = `${resetSvg} RESET  Test Lemon Juice next`;
                    }
                } else if (substance === 'lemon-juice') {
                    if (!state.lemonJuiceRedLitmusTested && indicator === 'blue-litmus') {
                        resetBannerText = `${resetSvg} RESET  Test with Red Litmus`;
                    } else if (!isSoapSolutionTested()) {
                        resetBannerText = `${resetSvg} RESET  Test Soap Solution next`;
                    }
                } else if (substance === 'soap-solution') {
                    if (!state.soapSolutionBlueLitmusTested && indicator === 'red-litmus') {
                        resetBannerText = `${resetSvg} RESET  Test with Blue Litmus`;
                    } else if (!isBakingSodaTested()) {
                        resetBannerText = `${resetSvg} RESET  Test Baking Soda next`;
                    }
                } else if (substance === 'baking-soda') {
                    if (!state.bakingSodaBlueLitmusTested && indicator === 'red-litmus') {
                        resetBannerText = `${resetSvg} RESET  Test with Blue Litmus`;
                    }
                }
            }

            // Create SVG for test tube setup
            const setupEl = document.createElement('div');
            setupEl.className = 'placed-apparatus acids-bases-setup';
            setupEl.innerHTML = `
                <div class="apparatus-visual" style="width:200px;height:180px;position:relative;">
                    <svg viewBox="0 -5 180 185" style="width:100%;height:100%;">
                        <defs>
                            <linearGradient id="testTubeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:rgba(200,220,255,0.2)"/>
                                <stop offset="50%" style="stop-color:rgba(220,235,255,0.15)"/>
                                <stop offset="100%" style="stop-color:rgba(200,220,255,0.25)"/>
                            </linearGradient>
                            <linearGradient id="liquidGrad2" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:${liquidColor};stop-opacity:0.85"/>
                                <stop offset="100%" style="stop-color:${liquidColor};stop-opacity:0.95"/>
                            </linearGradient>
                            <linearGradient id="standGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#666"/>
                                <stop offset="50%" style="stop-color:#888"/>
                                <stop offset="100%" style="stop-color:#555"/>
                            </linearGradient>
                        </defs>
                        
                        <!-- Test tube stand (wooden) -->
                        ${hasStand ? `
                            <!-- Base -->
                            <rect x="30" y="155" width="120" height="8" rx="2" fill="#8B4513"/>
                            <rect x="30" y="153" width="120" height="4" rx="1" fill="#A0522D"/>
                            <!-- Vertical supports -->
                            <rect x="35" y="50" width="6" height="105" rx="2" fill="#8B4513"/>
                            <rect x="139" y="50" width="6" height="105" rx="2" fill="#8B4513"/>
                            <!-- Top bar with holes -->
                            <rect x="32" y="48" width="116" height="10" rx="2" fill="#A0522D"/>
                            <!-- Holes for test tubes -->
                            <ellipse cx="60" cy="53" rx="10" ry="4" fill="#654321"/>
                            <ellipse cx="90" cy="53" rx="10" ry="4" fill="#654321"/>
                            <ellipse cx="120" cy="53" rx="10" ry="4" fill="#654321"/>
                        ` : ''}
                        
                        <!-- Test tube in stand -->
                        ${hasTestTube ? `
                            <!-- Test tube glass -->
                            <path d="M80 55 L80 130 Q80 145 90 145 Q100 145 100 130 L100 55" 
                                  fill="url(#testTubeGrad)" stroke="rgba(150,180,220,0.6)" stroke-width="2"/>
                            <!-- Test tube rim -->
                            <ellipse cx="90" cy="55" rx="12" ry="4" fill="rgba(200,220,255,0.3)" stroke="rgba(150,180,220,0.5)" stroke-width="1.5"/>
                            
                            <!-- Liquid in test tube -->
                            ${substance ? `
                                <path d="M82 75 L82 128 Q82 140 90 140 Q98 140 98 128 L98 75" 
                                      fill="url(#liquidGrad2)"/>
                                <ellipse cx="90" cy="75" rx="8" ry="3" fill="${liquidColor}" opacity="0.7"/>
                                
                                <!-- Bubbles/reaction effect when indicator added -->
                                ${hasReaction && reaction.visual.indicatorChange ? `
                                    <circle cx="85" cy="100" r="2" fill="rgba(255,255,255,0.5)" class="bubble"/>
                                    <circle cx="92" cy="110" r="1.5" fill="rgba(255,255,255,0.4)" class="bubble" style="animation-delay:0.2s"/>
                                    <circle cx="88" cy="120" r="2" fill="rgba(255,255,255,0.5)" class="bubble" style="animation-delay:0.4s"/>
                                ` : ''}
                            ` : `
                                <text x="90" y="105" text-anchor="middle" font-size="9" fill="#888">Empty</text>
                            `}
                        ` : ''}
                        
                        <!-- Dropper with indicator -->
                        ${hasDropper && indicator ? `
                            <g class="dropper-group ${state.litmusAnimating ? 'dropper-bob' : ''}">
                                <!-- Rubber bulb - squeezes when dropping -->
                                <ellipse cx="90" cy="25" rx="8" ry="${isDropFalling ? '8' : '10'}" fill="#333" class="${isDropFalling ? 'dropper-squeeze' : ''}"/>
                                <!-- Glass tube -->
                                <rect x="87" y="32" width="6" height="25" fill="rgba(200,220,255,0.3)" stroke="rgba(150,180,220,0.5)" stroke-width="1"/>
                                <!-- Indicator liquid in dropper -->
                                <rect x="88" y="35" width="4" height="${state.litmusAnimating ? 18 - (state.litmusDropCount * 3) : 18}" fill="${indicatorColor}" opacity="0.8"/>
                                <!-- Drop count indicator -->
                                ${state.litmusAnimating ? `
                                    <text x="115" y="40" font-size="9" fill="#666">${state.litmusDropCount}/4 drops</text>
                                ` : ''}
                            </g>
                            <!-- Drop falling during animation - OUTSIDE the dropper group so it falls straight -->
                            ${isDropFalling ? `
                                <ellipse cx="90" cy="62" rx="3" ry="4" fill="${indicatorColor}" class="litmus-drop-falling"/>
                            ` : ''}
                            <!-- Ripple effect when drop enters liquid -->
                            ${isDropFalling && substance ? `
                                <ellipse cx="90" cy="75" rx="6" ry="2" fill="none" stroke="${indicatorColor}" stroke-width="1" opacity="0.6" class="ripple-effect"/>
                            ` : ''}
                        ` : ''}
                        
                        <!-- Dropper without indicator (waiting) -->
                        ${hasDropper && !indicator && substance ? `
                            <g class="add-indicator-prompt">
                                <ellipse cx="90" cy="25" rx="8" ry="10" fill="#333"/>
                                <rect x="87" y="32" width="6" height="25" fill="rgba(200,220,255,0.3)" stroke="rgba(150,180,220,0.5)" stroke-width="1"/>
                                <!-- Prominent Add Indicator banner -->
                                <rect x="40" y="2" width="100" height="18" rx="4" fill="#2563eb" opacity="0.9"/>
                                <text x="90" y="14" text-anchor="middle" font-size="10" fill="#fff" font-weight="bold"> Add Litmus </text>
                                <!-- Pulsing arrow -->
                                <polygon points="90,58 85,52 95,52" fill="#2563eb" opacity="0.8">
                                    <animate attributeName="opacity" values="0.5;1;0.5" dur="1s" repeatCount="indefinite"/>
                                </polygon>
                            </g>
                        ` : ''}
                        
                    </svg>
                    ${resultBadge ? `<div style="position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);">${resultBadge}</div>` : ''}
                    ${showResetBanner ? `<div class="reset-banner" onclick="document.getElementById('resetBtn').click()"><span class="arrow-icon">${arrowSvg}</span>${resetBannerText}</div>` : ''}
                </div>
                <span class="beaker-label">${getAcidsBasesLabel(substance, indicator, hasReaction)}</span>
            `;
            dropZone.appendChild(setupEl);
        }

        function getAcidsBasesLabel(substance, indicator, hasReaction) {
            const parts = [];
            if (substance) {
                const names = {
                    'vinegar': 'Vinegar',
                    'lemon-juice': 'Lemon Juice',
                    'soap-solution': 'Soap Solution',
                    'baking-soda': 'Baking Soda'
                };
                parts.push(names[substance] || substance);
            }
            if (indicator) {
                const indicatorNames = {
                    'blue-litmus': 'Blue Litmus',
                    'red-litmus': 'Red Litmus'
                };
                parts.push(indicatorNames[indicator] || indicator);
            }
            if (parts.length === 0) return 'Add a substance';
            return parts.join(' + ');
        }

        function renderNeutralizationSetup() {
            if (!state.placedApparatus.includes('beaker')) return;

            const hasDropper = state.placedApparatus.includes('dropper');

            // Check what's been added
            const hasNaOH = state.addedChemicals.includes('naoh');
            const hasPhenolphthalein = state.addedChemicals.includes('phenolphthalein');
            const hasHCl = state.addedChemicals.includes('hcl');

            // Get reaction state
            const reactionKey = getReactionKey();
            const exp = state.currentExperiment;
            const reaction = exp.reactions[reactionKey];

            // Determine liquid color based on experiment stage and animation progress
            let liquidColor = '#e8e8ff'; // NaOH - slight bluish tint
            let originalColor = '#ff69b4'; // Pink from phenolphthalein
            let finalColor = '#f5f5f5'; // Neutralized - colorless
            let label = 'Beaker';

            if (hasNaOH && hasPhenolphthalein && hasHCl) {
                // During HCl drop animation, interpolate color based on drop count
                if (state.neutralizationAnimating) {
                    const progress = state.neutralizationDropCount / 5; // 5 drops total
                    liquidColor = interpolateColor(originalColor, finalColor, progress);
                    label = 'Neutralizing...';
                } else {
                    // Animation complete - neutralized
                    liquidColor = '#f5f5f5';
                    label = 'NaCl + HO (Neutralized)';
                }
            } else if (hasNaOH && hasPhenolphthalein) {
                // Pink from phenolphthalein in base
                liquidColor = '#ff69b4';
                label = 'NaOH + Phenolphthalein (Pink)';
            } else if (hasNaOH) {
                // Just NaOH
                liquidColor = '#e8e8ff';
                label = 'NaOH Solution';
            }

            // HCl dropper color - colorless (clear liquid)
            const hclColor = '#e8f4fc';

            // Check if a drop is currently falling (within 400ms of last drop)
            const isDropFalling = state.neutralizationAnimating && state.lastNeutralizationDropTime &&
                (Date.now() - state.lastNeutralizationDropTime < 400);

            // Show dropper with HCl drops if animation is in progress or waiting for HCl
            let dropperSvg = '';
            if (hasDropper && hasPhenolphthalein && hasHCl && state.neutralizationAnimating) {
                // Dropper with HCl being added drop by drop
                dropperSvg = `
                    <g class="dropper-group ${state.neutralizationAnimating ? 'dropper-bob' : ''}">
                        <!-- Rubber bulb - squeezes when dropping -->
                        <ellipse cx="50" cy="15" rx="8" ry="${isDropFalling ? '8' : '10'}" fill="#333" class="${isDropFalling ? 'dropper-squeeze' : ''}"/>
                        <!-- Glass tube -->
                        <rect x="47" y="22" width="6" height="25" fill="rgba(200,220,255,0.3)" stroke="rgba(150,180,220,0.5)" stroke-width="1"/>
                        <!-- HCl liquid in dropper -->
                        <rect x="48" y="25" width="4" height="${state.neutralizationAnimating ? 18 - (state.neutralizationDropCount * 3) : 18}" fill="${hclColor}" opacity="0.8"/>
                        <!-- Drop count indicator -->
                        ${state.neutralizationAnimating ? `
                            <text x="75" y="30" font-size="8" fill="#666">${state.neutralizationDropCount}/5 drops</text>
                        ` : ''}
                    </g>
                    <!-- Drop falling during animation -->
                    ${isDropFalling ? `
                        <ellipse cx="50" cy="52" rx="3" ry="4" fill="${hclColor}" class="litmus-drop-falling"/>
                    ` : ''}
                    <!-- Ripple effect when drop enters liquid -->
                    ${isDropFalling && hasNaOH ? `
                        <ellipse cx="50" cy="60" rx="6" ry="2" fill="none" stroke="${hclColor}" stroke-width="1" opacity="0.6" class="ripple-effect"/>
                    ` : ''}
                `;
            } else if (hasDropper && hasPhenolphthalein && !hasHCl) {
                // Dropper waiting for HCl - show prompt with clear liquid
                dropperSvg = `
                    <g class="add-indicator-prompt">
                        <ellipse cx="50" cy="15" rx="8" ry="10" fill="#333"/>
                        <rect x="47" y="22" width="6" height="25" fill="rgba(200,220,255,0.3)" stroke="rgba(150,180,220,0.5)" stroke-width="1"/>
                        <!-- Clear HCl liquid in dropper -->
                        <rect x="48" y="25" width="4" height="18" fill="#e8f4fc" opacity="0.6"/>
                        <!-- Prominent Add HCl banner - blue instead of red to avoid confusion -->
                        <rect x="5" y="0" width="90" height="14" rx="3" fill="#2563eb" opacity="0.9"/>
                        <text x="50" y="10" text-anchor="middle" font-size="9" fill="#fff" font-weight="bold"> Add HCl Drops </text>
                        <!-- Pulsing arrow - blue -->
                        <polygon points="50,50 45,44 55,44" fill="#2563eb" opacity="0.8">
                            <animate attributeName="opacity" values="0.5;1;0.5" dur="1s" repeatCount="indefinite"/>
                        </polygon>
                    </g>
                `;
            }

            const setupEl = document.createElement('div');
            setupEl.className = 'placed-apparatus';
            setupEl.innerHTML = `
                <div class="apparatus-visual" style="width:120px;height:160px;position:relative;">
                    <svg viewBox="0 0 100 140" class="beaker-svg" style="width:100%;height:100%;">
                        <defs>
                            <linearGradient id="neutralLiquidGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:${liquidColor};stop-opacity:0.75"/>
                                <stop offset="100%" style="stop-color:${liquidColor};stop-opacity:0.95"/>
                            </linearGradient>
                        </defs>
                        
                        ${dropperSvg}
                        
                        <!-- Liquid inside beaker -->
                        ${hasNaOH ? `<rect x="10" y="60" width="80" height="70" rx="4" fill="url(#neutralLiquidGrad)"/>` : ''}
                        
                        <!-- Bubbles during neutralization -->
                        ${state.neutralizationAnimating && isDropFalling ? `
                            <circle cx="30" cy="100" r="2" fill="rgba(255,255,255,0.5)" class="bubble"/>
                            <circle cx="50" cy="105" r="1.5" fill="rgba(255,255,255,0.4)" class="bubble" style="animation-delay:0.1s"/>
                            <circle cx="70" cy="95" r="2" fill="rgba(255,255,255,0.5)" class="bubble" style="animation-delay:0.2s"/>
                        ` : ''}
                        
                        <!-- Beaker outline -->
                        <path d="M8 15 L8 125 Q8 135 18 135 L82 135 Q92 135 92 125 L92 15" fill="rgba(200,220,255,0.06)" stroke="rgba(150,180,220,0.5)" stroke-width="2.5"/>
                        <rect x="6" y="10" width="88" height="10" rx="2" fill="rgba(200,220,255,0.12)" stroke="rgba(150,180,220,0.4)" stroke-width="1"/>
                        
                        <!-- Graduation marks -->
                        <line x1="10" y1="50" x2="18" y2="50" stroke="rgba(150,180,220,0.4)" stroke-width="1"/>
                        <line x1="10" y1="70" x2="18" y2="70" stroke="rgba(150,180,220,0.4)" stroke-width="1"/>
                        <line x1="10" y1="90" x2="18" y2="90" stroke="rgba(150,180,220,0.4)" stroke-width="1"/>
                        <line x1="10" y1="110" x2="18" y2="110" stroke="rgba(150,180,220,0.4)" stroke-width="1"/>
                    </svg>
                </div>
                <span class="beaker-label">${label}</span>
            `;
            dropZone.appendChild(setupEl);
        }

        function getLiquidColor() {
            const chemicals = state.addedChemicals;
            const exp = state.currentExperiment;

            // Check for reaction result
            const reactionKey = getReactionKey();
            if (exp.reactions[reactionKey] && exp.reactions[reactionKey].visual) {
                return exp.reactions[reactionKey].visual.liquidColor;
            }

            // Default: show last added chemical color
            if (chemicals.length > 0) {
                const lastChem = exp.chemicals.find(c => c.id === chemicals[chemicals.length - 1]);
                return lastChem ? lastChem.color : '#a8d4ff';
            }
            return '#a8d4ff';
        }

        function getLiquidLevel() {
            let level = 10; // Empty
            if (state.addedChemicals.includes('water')) level = 70;
            if (state.addedChemicals.includes('salt') || state.addedChemicals.includes('sand')) level = 75;
            return level;
        }

        function renderParticles() {
            const exp = state.currentExperiment;
            const reactionKey = getReactionKey();
            const isStirring = state.lastStirTime && Date.now() - state.lastStirTime < 600;

            // Sand particles - always visible, larger and more obvious
            if (state.addedChemicals.includes('sand')) {
                const swirlClass = isStirring ? 'particles-swirl' : '';
                return `
                    <g class="${swirlClass}" style="transform-origin: 50px 115px;">
                        <circle cx="20" cy="122" r="5" fill="#d4a574"/>
                        <circle cx="32" cy="125" r="6" fill="#c49464"/>
                        <circle cx="45" cy="123" r="5" fill="#b8845a"/>
                        <circle cx="58" cy="126" r="6" fill="#d4a574"/>
                        <circle cx="70" cy="124" r="5" fill="#c49464"/>
                        <circle cx="82" cy="125" r="5" fill="#b8845a"/>
                        <circle cx="38" cy="118" r="4" fill="#d4a574"/>
                        <circle cx="62" cy="119" r="4" fill="#c49464"/>
                    </g>
                `;
            }

            // Salt particles - show before stirring, disappear after
            if (state.addedChemicals.includes('salt') && !state.actions.includes('stir')) {
                return `
                    <g>
                        <rect x="25" y="115" width="5" height="5" fill="#ffffff" opacity="0.9" rx="1"/>
                        <rect x="42" y="118" width="6" height="6" fill="#f8f8f8" opacity="0.85" rx="1"/>
                        <rect x="58" y="112" width="5" height="5" fill="#ffffff" opacity="0.9" rx="1"/>
                        <rect x="35" y="120" width="4" height="4" fill="#f8f8f8" opacity="0.85" rx="1"/>
                        <rect x="70" y="116" width="5" height="5" fill="#ffffff" opacity="0.8" rx="1"/>
                    </g>
                `;
            }

            return '';
        }

        // ==================== EXPERIMENT LOGIC ====================
        function openExperiment(id) {
            const experiments = experimentsData[state.currentClass];
            state.currentExperiment = experiments.find(e => e.id === id);

            if (!state.currentExperiment) return;

            // Reset experiment-specific tracking for salt-dissolution
            state.saltTested = false;
            state.sandTested = false;
            state.resetAfterSaltTest = false;
            state.saltTestHistory = [];

            // Reset experiment-specific tracking for physical-chemical
            state.iceTested = false;
            state.paperTested = false;
            state.magnesiumTested = false;
            state.physicalChemicalTestHistory = [];

            // Reset experiment-specific tracking for acids-bases (each substance needs both litmus)
            state.vinegarBlueLitmusTested = false;
            state.vinegarRedLitmusTested = false;
            state.lemonJuiceBlueLitmusTested = false;
            state.lemonJuiceRedLitmusTested = false;
            state.soapSolutionBlueLitmusTested = false;
            state.soapSolutionRedLitmusTested = false;
            state.bakingSodaBlueLitmusTested = false;
            state.bakingSodaRedLitmusTested = false;
            state.acidsBasesTestHistory = [];
            state.currentAcidsBasesSubstance = null;

            resetExperiment();
            labTitle.textContent = state.currentExperiment.title;

            homeScreen.classList.add('hidden');
            labScreen.classList.add('active');
            // Add lab-mode class for browsers that don't support :has()
            document.body.classList.add('lab-mode');

            // Hide actions panel for experiments that don't need it (acids-bases)
            if (id === 'acids-bases') {
                document.body.classList.add('hide-actions');
            } else {
                document.body.classList.remove('hide-actions');
            }

            renderApparatusShelf();
            renderChemicalShelf();
        }

        function resetExperiment() {
            // For salt-dissolution: save first test's history before reset
            const expId = state.currentExperiment ? state.currentExperiment.id : '';
            if (expId === 'salt-dissolution' && state.observationHistory.length > 0) {
                // If this is the first test, save its history
                if ((state.saltTested && !state.sandTested) || (state.sandTested && !state.saltTested)) {
                    state.saltTestHistory = [...state.observationHistory];
                }
            }

            // Track when Reset is clicked after salt test (for step tracking)
            if (expId === 'salt-dissolution' && state.saltTested && !state.sandTested) {
                state.resetAfterSaltTest = true;
            }

            // For salt-dissolution: if both tests are complete, reset flags to allow rerunning
            if (expId === 'salt-dissolution' && state.saltTested && state.sandTested) {
                state.saltTested = false;
                state.sandTested = false;
                state.resetAfterSaltTest = false;
                state.saltTestHistory = [];
                shownPopupsThisSession.delete('salt-dissolution'); // Allow popup to show again
            }

            // For physical-chemical experiment: save test history before reset
            if (expId === 'physical-chemical' && state.observationHistory.length > 0) {
                // Append current observation history to the cumulative history
                state.physicalChemicalTestHistory = [...state.physicalChemicalTestHistory, ...state.observationHistory];
            }

            // For physical-chemical: if all tests are complete, reset flags to allow rerunning
            if (expId === 'physical-chemical' && state.iceTested && state.paperTested && state.magnesiumTested) {
                state.iceTested = false;
                state.paperTested = false;
                state.magnesiumTested = false;
                state.physicalChemicalTestHistory = [];
                shownPopupsThisSession.delete('physical-chemical'); // Allow popup to show again
            }

            // For acids-bases experiment: save test history before reset
            if (expId === 'acids-bases' && state.observationHistory.length > 0) {
                // Append current observation history to the cumulative history
                state.acidsBasesTestHistory = [...state.acidsBasesTestHistory, ...state.observationHistory];
                // Clear current substance so next one can be selected
                state.currentAcidsBasesSubstance = null;
            }

            // For acids-bases: if all tests complete, reset to allow rerunning
            if (expId === 'acids-bases' && areAllAcidsBasesTested()) {
                state.vinegarBlueLitmusTested = false;
                state.vinegarRedLitmusTested = false;
                state.lemonJuiceBlueLitmusTested = false;
                state.lemonJuiceRedLitmusTested = false;
                state.soapSolutionBlueLitmusTested = false;
                state.soapSolutionRedLitmusTested = false;
                state.bakingSodaBlueLitmusTested = false;
                state.bakingSodaRedLitmusTested = false;
                state.acidsBasesTestHistory = [];
                shownPopupsThisSession.delete('acids-bases'); // Allow popup to show again
            }

            // For filtration/evaporation: allow popup to show again on reset
            if (expId === 'filtration') {
                shownPopupsThisSession.delete('filtration');
            }
            if (expId === 'evaporation') {
                shownPopupsThisSession.delete('evaporation');
            }

            state.placedApparatus = [];
            state.addedChemicals = [];
            state.actions = [];
            state.heatLevel = 0;
            state.stirCount = 0;
            state.observationHistory = [];
            state.isEvaporating = false;
            state.litmusDropCount = 0;
            state.litmusAnimating = false;
            state.litmusIndicator = null;
            state.lastDropTime = null;
            state.neutralizationDropCount = 0;
            state.neutralizationAnimating = false;
            state.lastNeutralizationDropTime = null;

            heatSlider.value = 0;
            heatSlider.disabled = true;
            stirBtn.disabled = true;
            document.getElementById('pourBtn').disabled = true;
            document.getElementById('filterBtn').disabled = true;
            document.getElementById('evaporateBtn').disabled = true;
            burnerFlame.classList.remove('on');
            burnerContainer.classList.remove('active');

            explanationBox.classList.remove('show');

            if (state.currentExperiment) {
                updateProcedureSteps();
                renderApparatusShelf();
                renderChemicalShelf();
                renderDropZone();
            }
        }

        function updateProcedureSteps() {
            const exp = state.currentExperiment;
            if (!exp) return;

            const procedureBox = document.getElementById('procedureSteps');
            const stepsList = document.getElementById('stepsList');

            // Define steps for each experiment
            const experimentSteps = {
                'acids-bases': [
                    { text: 'Place Test Tube Stand', done: state.placedApparatus.includes('test-tube-stand') },
                    { text: 'Place Test Tube in stand', done: state.placedApparatus.includes('test-tube') },
                    { text: 'Add a substance (acid/base)', done: state.addedChemicals.some(c => ['vinegar', 'lemon-juice', 'soap-solution', 'baking-soda'].includes(c)) },
                    { text: 'Place Dropper', done: state.placedApparatus.includes('dropper') },
                    { text: 'Add Litmus indicator', done: state.addedChemicals.some(c => ['blue-litmus', 'red-litmus'].includes(c)) }
                ],
                'salt-dissolution': (() => {
                    // Round 2 starts ONLY when Reset has been clicked after salt test
                    const inRound2 = state.resetAfterSaltTest && !state.sandTested;
                    const round2Complete = state.sandTested;

                    return [
                        // Round 1 - Test Salt
                        { text: 'Place Beaker', done: state.placedApparatus.includes('beaker') || state.saltTested },
                        { text: 'Place Glass Rod', done: state.placedApparatus.includes('glass-rod') || state.saltTested },
                        { text: 'Add Water', done: state.addedChemicals.includes('water') || state.saltTested },
                        { text: 'Add SALT', done: state.addedChemicals.includes('salt') || state.saltTested },
                        { text: 'Stir  Salt dissolves ', done: state.saltTested },
                        // Round 2 - Test Sand (only show progress after Reset is clicked)
                        { text: 'Click RESET button', done: state.resetAfterSaltTest || round2Complete },
                        { text: 'Repeat setup (Beaker + Rod + Water)', done: inRound2 && state.addedChemicals.includes('water') || round2Complete },
                        { text: 'Add SAND', done: state.addedChemicals.includes('sand') || round2Complete },
                        { text: 'Stir  Sand settles ', done: round2Complete }
                    ];
                })(),
                'filtration': [
                    { text: 'Place Beaker', done: state.placedApparatus.includes('beaker') },
                    { text: 'Place Funnel', done: state.placedApparatus.includes('funnel') },
                    { text: 'Add Filter Paper', done: state.placedApparatus.includes('filter-paper') },
                    { text: 'Add Muddy Water', done: state.addedChemicals.includes('muddy-water') },
                    { text: 'Pour into funnel', done: state.actions.includes('pour') },
                    { text: 'Wait for filtration', done: state.actions.includes('filter') }
                ],
                'evaporation': [
                    { text: 'Place Tripod Stand', done: state.placedApparatus.includes('tripod-stand') },
                    { text: 'Place China Dish', done: state.placedApparatus.includes('china-dish') },
                    { text: 'Place Burner', done: state.placedApparatus.includes('burner') },
                    { text: 'Add Salt Solution', done: state.addedChemicals.includes('salt-solution') },
                    { text: 'Heat and Evaporate', done: state.actions.includes('evaporate') }
                ],
                'physical-chemical': (() => {
                    // Determine current round based on tested materials
                    const inRound2 = state.iceTested && !state.paperTested;
                    const inRound3 = state.iceTested && state.paperTested && !state.magnesiumTested;
                    const allComplete = state.iceTested && state.paperTested && state.magnesiumTested;

                    // Check current apparatus placement
                    const hasBurner = state.placedApparatus.includes('burner');
                    const hasTripod = state.placedApparatus.includes('tripod-stand');
                    const hasBeaker = state.placedApparatus.includes('beaker');
                    const hasTongs = state.placedApparatus.includes('tongs');
                    const hasIce = state.addedChemicals.includes('ice');
                    const hasPaper = state.addedChemicals.includes('paper');
                    const hasMagnesium = state.addedChemicals.includes('magnesium');
                    const isHeating = state.heatLevel > 30;

                    return [
                        // Round 1 - Test Ice (Physical Change)
                        { text: ' ROUND 1: Ice (Physical)', done: state.iceTested, header: true },
                        { text: 'Place Burner', done: hasBurner || state.iceTested },
                        { text: 'Place Tripod Stand', done: hasTripod || state.iceTested },
                        { text: 'Place Beaker', done: hasBeaker || state.iceTested },
                        { text: 'Add Ice Cubes', done: hasIce || state.iceTested },
                        { text: 'Heat  Ice melts to water ', done: state.iceTested },
                        // Round 2 - Test Paper (Chemical Change)
                        { text: ' ROUND 2: Paper (Chemical)', done: state.paperTested, header: true },
                        { text: 'Click RESET', done: inRound2 || state.paperTested },
                        { text: 'Place Burner', done: (inRound2 && hasBurner) || state.paperTested },
                        { text: 'Place Tongs', done: (inRound2 && hasTongs) || state.paperTested },
                        { text: 'Add Paper Strip', done: hasPaper || state.paperTested },
                        { text: 'Heat  Paper burns to ash ', done: state.paperTested },
                        // Round 3 - Test Magnesium (Chemical Change)
                        { text: ' ROUND 3: Magnesium (Chemical)', done: state.magnesiumTested, header: true },
                        { text: 'Click RESET', done: inRound3 || state.magnesiumTested },
                        { text: 'Place Burner', done: (inRound3 && hasBurner) || state.magnesiumTested },
                        { text: 'Place Tongs', done: (inRound3 && hasTongs) || state.magnesiumTested },
                        { text: 'Add Magnesium Ribbon', done: hasMagnesium || state.magnesiumTested },
                        { text: 'Heat  Bright white flame, MgO powder ', done: state.magnesiumTested }
                    ];
                })(),
                'acids-bases': (() => {
                    // Determine current round based on tested substances (both litmus needed for each)
                    const inRound2 = isVinegarTested() && !isLemonJuiceTested();
                    const inRound3 = isVinegarTested() && isLemonJuiceTested() && !isSoapSolutionTested();
                    const inRound4 = isVinegarTested() && isLemonJuiceTested() && isSoapSolutionTested() && !isBakingSodaTested();

                    // Check current apparatus/chemical state
                    const hasStand = state.placedApparatus.includes('test-tube-stand');
                    const hasTube = state.placedApparatus.includes('test-tube');
                    const hasDropper = state.placedApparatus.includes('dropper');
                    const hasVinegar = state.addedChemicals.includes('vinegar');
                    const hasLemon = state.addedChemicals.includes('lemon-juice');
                    const hasSoap = state.addedChemicals.includes('soap-solution');
                    const hasBakingSoda = state.addedChemicals.includes('baking-soda');

                    return [
                        // Round 1 - Test Vinegar (Acid) with both litmus (reset between each)
                        { text: ' ROUND 1: Vinegar (Acid)', done: isVinegarTested(), header: true },
                        { text: 'Setup: Stand + Test Tube + Dropper', done: hasStand && hasTube && hasDropper || state.vinegarBlueLitmusTested },
                        { text: 'Add Vinegar + Blue Litmus  RED', done: state.vinegarBlueLitmusTested },
                        { text: 'RESET  Add Vinegar + Red Litmus  stays', done: state.vinegarRedLitmusTested },
                        // Round 2 - Test Lemon Juice (Acid)
                        { text: ' ROUND 2: Lemon Juice (Acid)', done: isLemonJuiceTested(), header: true },
                        { text: 'RESET  Add Lemon + Blue Litmus  RED', done: state.lemonJuiceBlueLitmusTested },
                        { text: 'RESET  Add Lemon + Red Litmus  stays', done: state.lemonJuiceRedLitmusTested },
                        // Round 3 - Test Soap Solution (Base)
                        { text: ' ROUND 3: Soap Solution (Base)', done: isSoapSolutionTested(), header: true },
                        { text: 'RESET  Add Soap + Red Litmus  BLUE', done: state.soapSolutionRedLitmusTested },
                        { text: 'RESET  Add Soap + Blue Litmus  stays', done: state.soapSolutionBlueLitmusTested },
                        // Round 4 - Test Baking Soda (Base)
                        { text: ' ROUND 4: Baking Soda (Base)', done: isBakingSodaTested(), header: true },
                        { text: 'RESET  Add Baking Soda + Red Litmus  BLUE', done: state.bakingSodaRedLitmusTested },
                        { text: 'RESET  Add Baking Soda + Blue Litmus  stays', done: state.bakingSodaBlueLitmusTested }
                    ];
                })(),
                'neutralization': (() => {
                    const hasBeaker = state.placedApparatus.includes('beaker');
                    const hasDropper = state.placedApparatus.includes('dropper');
                    const hasNaOH = state.addedChemicals.includes('naoh');
                    const hasPhenolphthalein = state.addedChemicals.includes('phenolphthalein');
                    const hasHCl = state.addedChemicals.includes('hcl');
                    const isNeutralized = hasHCl && !state.neutralizationAnimating;

                    return [
                        { text: 'Place Beaker', done: hasBeaker },
                        { text: 'Add NaOH Solution (base)', done: hasNaOH },
                        { text: 'Add Phenolphthalein  turns PINK', done: hasPhenolphthalein },
                        { text: 'Place Dropper (now enabled)', done: hasDropper && hasPhenolphthalein },
                        { text: 'Add HCl drops  NEUTRALIZED (colorless)', done: isNeutralized }
                    ];
                })()
            };

            const steps = experimentSteps[exp.id];
            if (!steps) {
                procedureBox.style.display = 'none';
                return;
            }

            procedureBox.style.display = 'block';

            // Find current step
            let currentStep = steps.findIndex(s => !s.done);
            if (currentStep === -1) currentStep = steps.length; // All done

            stepsList.innerHTML = steps.map((step, i) => {
                let style = 'margin: 3px 0;';
                let icon = '';

                // Header items (round labels) get special styling
                if (step.header) {
                    style = 'margin: 8px 0 4px 0; list-style: none; font-weight: bold;';
                    if (step.done) {
                        style += 'color:#16a34a;';
                    } else {
                        style += 'color:#00d4ff;';
                    }
                    return `<li style="${style}">${step.text}</li>`;
                }

                if (step.done) {
                    style += 'color:#16a34a; text-decoration:line-through;';
                    icon = ' ';
                } else if (i === currentStep) {
                    style += 'color:#2563eb; font-weight:bold;';
                    icon = ' ';
                } else {
                    style += 'color:#888;';
                }
                return `<li style="${style}">${icon}${step.text}</li>`;
            }).join('');

            // Update observation text based on current step
            if (currentStep < steps.length && !state.litmusAnimating && !state.neutralizationAnimating) {
                const currentStepText = steps[currentStep].text;
                observationText.textContent = `Next: ${currentStepText}`;
                observationText.className = 'observation-text hint';
            } else if (currentStep >= steps.length) {
                observationText.textContent = 'Experiment complete! Check the observation above.';
                observationText.className = 'observation-text success';
            }
        }

        function goHome() {
            labScreen.classList.remove('active');
            homeScreen.classList.remove('hidden');
            // Remove lab-mode class to re-enable scrolling on home screen
            document.body.classList.remove('lab-mode');
            resetExperiment();
            document.getElementById('procedureSteps').style.display = 'none';
        }

        function getReactionKey() {
            const parts = [];
            const exp = state.currentExperiment;

            // Add all chemicals in order they were added
            state.addedChemicals.forEach(chem => {
                parts.push(chem);
            });

            // Add actions
            if (state.actions.includes('stir')) parts.push('stir');
            if (state.actions.includes('pour')) parts.push('pour');
            if (state.actions.includes('filter')) parts.push('filter');
            if (state.actions.includes('heat') || state.heatLevel > 30) parts.push('heat');
            if (state.actions.includes('evaporate')) parts.push('evaporate');

            return parts.join('+');
        }

        function checkReaction() {
            const exp = state.currentExperiment;
            const reactionKey = getReactionKey();

            if (exp.reactions[reactionKey]) {
                const reaction = exp.reactions[reactionKey];

                // For filtration experiment: complete when filter action is done
                if (exp.id === 'filtration' && reaction.success && reactionKey.includes('filter')) {
                    markExperimentComplete('filtration');
                }

                // For evaporation experiment: complete when evaporate action is done
                if (exp.id === 'evaporation' && reaction.success && reactionKey.includes('evaporate')) {
                    markExperimentComplete('evaporation');
                }

                // For salt-dissolution experiment: track which substances have been tested
                if (exp.id === 'salt-dissolution' && reaction.success) {
                    if (reactionKey.includes('salt') && reactionKey.includes('stir')) {
                        state.saltTested = true;
                    }
                    if (reactionKey.includes('sand') && reactionKey.includes('stir')) {
                        state.sandTested = true;
                    }
                    // Check if experiment is complete (both tested)
                    if (state.saltTested && state.sandTested) {
                        markExperimentComplete('salt-dissolution');
                    }
                }

                // For physical-chemical experiment: track which materials have been tested
                if (exp.id === 'physical-chemical' && reaction.success) {
                    if (reactionKey.includes('ice') && reactionKey.includes('heat')) {
                        state.iceTested = true;
                    }
                    if (reactionKey.includes('paper') && reactionKey.includes('heat')) {
                        state.paperTested = true;
                    }
                    if (reactionKey.includes('magnesium') && reactionKey.includes('heat')) {
                        state.magnesiumTested = true;
                    }
                    // Check if experiment is complete (all 3 tested)
                    if (state.iceTested && state.paperTested && state.magnesiumTested) {
                        markExperimentComplete('physical-chemical');
                    }
                }

                // For acids-bases experiment: track which litmus tests have been completed
                if (exp.id === 'acids-bases' && reaction.success) {
                    // Track specific litmus+substance combinations
                    if (reactionKey.includes('vinegar')) {
                        if (reactionKey.includes('blue-litmus')) state.vinegarBlueLitmusTested = true;
                        if (reactionKey.includes('red-litmus')) state.vinegarRedLitmusTested = true;
                    }
                    if (reactionKey.includes('lemon-juice')) {
                        if (reactionKey.includes('blue-litmus')) state.lemonJuiceBlueLitmusTested = true;
                        if (reactionKey.includes('red-litmus')) state.lemonJuiceRedLitmusTested = true;
                    }
                    if (reactionKey.includes('soap-solution')) {
                        if (reactionKey.includes('blue-litmus')) state.soapSolutionBlueLitmusTested = true;
                        if (reactionKey.includes('red-litmus')) state.soapSolutionRedLitmusTested = true;
                    }
                    if (reactionKey.includes('baking-soda')) {
                        if (reactionKey.includes('blue-litmus')) state.bakingSodaBlueLitmusTested = true;
                        if (reactionKey.includes('red-litmus')) state.bakingSodaRedLitmusTested = true;
                    }
                    // Check if experiment is complete (all 4 substances tested with both litmus)
                    if (areAllAcidsBasesTested()) {
                        markExperimentComplete('acids-bases');
                    }
                }

                // For neutralization experiment: complete when NaOH + phenolphthalein + HCl is done (after drop animation)
                if (exp.id === 'neutralization' && reaction.success) {
                    if (reactionKey.includes('naoh') && reactionKey.includes('phenolphthalein') &&
                        reactionKey.includes('hcl') && !state.neutralizationAnimating) {
                        markExperimentComplete('neutralization');
                    }
                }

                observationText.textContent = reaction.observation;
                observationText.className = reaction.success ? 'observation-text success' : 'observation-text';

                // For salt-dissolution: customize explanation based on progress
                if (exp.id === 'salt-dissolution' && reaction.success) {
                    let explanationMsg = reaction.explanation;

                    if (state.saltTested && state.sandTested) {
                        // Both tested - show full conclusion
                        explanationMsg += '\n\n Experiment Complete! You have tested both salt and sand. ' + exp.conclusion;
                    } else if (state.saltTested && !state.sandTested) {
                        explanationMsg += '\n\n Good job! Now click Reset and test SAND to compare and complete the experiment.';
                    } else if (state.sandTested && !state.saltTested) {
                        explanationMsg += '\n\n Good job! Now click Reset and test SALT to compare and complete the experiment.';
                    }

                    explanationText.textContent = explanationMsg;
                    // For physical-chemical: customize explanation based on progress
                } else if (exp.id === 'physical-chemical' && reaction.success) {
                    let explanationMsg = reaction.explanation;
                    let observationMsg = reaction.observation;

                    if (state.iceTested && state.paperTested && state.magnesiumTested) {
                        explanationMsg += '\n\n Experiment Complete! You have tested all 3 materials. ' + exp.conclusion;
                    } else if (state.iceTested && !state.paperTested) {
                        observationMsg += '\n\n Click the RESET button above to proceed to Paper test!';
                        explanationMsg += '\n\n Ice test complete! Now click the RESET button (top right) and test PAPER to observe a chemical change (burning).';
                    } else if (state.iceTested && state.paperTested && !state.magnesiumTested) {
                        observationMsg += '\n\n Click the RESET button above to proceed to Magnesium test!';
                        explanationMsg += '\n\n Paper test complete! Now click the RESET button (top right) and test MAGNESIUM to complete the experiment.';
                    }

                    observationText.textContent = observationMsg;
                    explanationText.textContent = explanationMsg;
                    // For acids-bases: customize explanation based on progress
                } else if (exp.id === 'acids-bases' && reaction.success) {
                    let explanationMsg = reaction.explanation;
                    let observationMsg = reaction.observation;

                    // Check if all 4 substances are fully tested (both litmus each)
                    if (areAllAcidsBasesTested()) {
                        explanationMsg += '\n\n Experiment Complete! You have tested all 4 substances with both litmus papers. ' + exp.conclusion;
                    } else {
                        // Determine current substance and what's needed next
                        const currentSubstance = state.addedChemicals.find(c => ['vinegar', 'lemon-juice', 'soap-solution', 'baking-soda'].includes(c));
                        const hasLitmusInSession = state.addedChemicals.includes('blue-litmus') || state.addedChemicals.includes('red-litmus');

                        if (currentSubstance === 'vinegar') {
                            if (!isVinegarTested()) {
                                const needBlue = !state.vinegarBlueLitmusTested;
                                const needRed = !state.vinegarRedLitmusTested;
                                // After one litmus, prompt to reset for the other
                                if (hasLitmusInSession) {
                                    if (needBlue) {
                                        observationMsg += '\n\n^ Click RESET, then add vinegar again and test with BLUE litmus.';
                                    } else if (needRed) {
                                        observationMsg += '\n\n^ Click RESET, then add vinegar again and test with RED litmus.';
                                    }
                                }
                            } else {
                                observationMsg += '\n\n^ Vinegar fully tested! Click RESET to test LEMON JUICE.';
                                explanationMsg += '\n\n-> Both litmus tested on vinegar! Click RESET and test LEMON JUICE next.';
                            }
                        } else if (currentSubstance === 'lemon-juice') {
                            if (!isLemonJuiceTested()) {
                                const needBlue = !state.lemonJuiceBlueLitmusTested;
                                const needRed = !state.lemonJuiceRedLitmusTested;
                                if (hasLitmusInSession) {
                                    if (needBlue) {
                                        observationMsg += '\n\n^ Click RESET, then add lemon juice again and test with BLUE litmus.';
                                    } else if (needRed) {
                                        observationMsg += '\n\n^ Click RESET, then add lemon juice again and test with RED litmus.';
                                    }
                                }
                            } else {
                                observationMsg += '\n\n^ Lemon juice fully tested! Click RESET to test SOAP SOLUTION.';
                                explanationMsg += '\n\n-> Both litmus tested on lemon juice! Click RESET and test SOAP SOLUTION next.';
                            }
                        } else if (currentSubstance === 'soap-solution') {
                            if (!isSoapSolutionTested()) {
                                const needBlue = !state.soapSolutionBlueLitmusTested;
                                const needRed = !state.soapSolutionRedLitmusTested;
                                if (hasLitmusInSession) {
                                    if (needBlue) {
                                        observationMsg += '\n\n^ Click RESET, then add soap solution again and test with BLUE litmus.';
                                    } else if (needRed) {
                                        observationMsg += '\n\n^ Click RESET, then add soap solution again and test with RED litmus.';
                                    }
                                }
                            } else {
                                observationMsg += '\n\n^ Soap solution fully tested! Click RESET to test BAKING SODA.';
                                explanationMsg += '\n\n-> Both litmus tested on soap solution! Click RESET and test BAKING SODA next.';
                            }
                        } else if (currentSubstance === 'baking-soda') {
                            if (!isBakingSodaTested()) {
                                const needBlue = !state.bakingSodaBlueLitmusTested;
                                const needRed = !state.bakingSodaRedLitmusTested;
                                if (hasLitmusInSession) {
                                    if (needBlue) {
                                        observationMsg += '\n\n^ Click RESET, then add baking soda again and test with BLUE litmus to complete!';
                                    } else if (needRed) {
                                        observationMsg += '\n\n^ Click RESET, then add baking soda again and test with RED litmus to complete!';
                                    }
                                }
                            }
                        }
                    }

                    observationText.textContent = observationMsg;
                    explanationText.textContent = explanationMsg;
                } else {
                    explanationText.textContent = reaction.explanation;
                }

                explanationBox.classList.add('show');

                // Only add to history if this is a new reaction to log
                // Avoid duplicates by checking if the reaction key is already in history
                const alreadyLogged = state.observationHistory.some(h =>
                    h.action === reactionKey || h.reactionKey === reactionKey
                );
                if (!alreadyLogged) {
                    state.observationHistory.push({
                        action: reactionKey.split('+').map(p => p.charAt(0).toUpperCase() + p.slice(1).replace(/-/g, ' ')).join(' + '),
                        reactionKey: reactionKey,
                        observation: reaction.observation
                    });
                }

                renderDropZone();
            }
        }

        // ==================== DRAG & DROP ====================
        function handleDragStart(e) {
            e.dataTransfer.setData('type', e.target.dataset.type);
            e.dataTransfer.setData('id', e.target.dataset.id);
            e.target.style.opacity = '0.5';
        }

        function handleDragOver(e) {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            dropZone.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            dropZone.classList.remove('drag-over');

            const type = e.dataTransfer.getData('type');
            const id = e.dataTransfer.getData('id');

            if (type === 'apparatus') {
                handleApparatusDrop(id);
            } else if (type === 'chemical') {
                handleChemicalDrop(id);
            }

            // Reset opacity
            document.querySelectorAll('[draggable]').forEach(el => el.style.opacity = '1');
        }

        function handleApparatusDrop(id) {
            if (state.placedApparatus.includes(id)) return;

            const expId = state.currentExperiment ? state.currentExperiment.id : '';

            // For acids-bases experiment: test-tube-stand must be placed before test-tube
            if (expId === 'acids-bases' && id === 'test-tube') {
                if (!state.placedApparatus.includes('test-tube-stand')) {
                    observationText.textContent = 'Place the test tube stand first to hold the test tube upright.';
                    observationText.className = 'observation-text hint';
                    return;
                }
            }

            // For filtration experiment: enforce proper order (beaker  funnel  filter paper)
            if (expId === 'filtration') {
                if (id === 'funnel' && !state.placedApparatus.includes('beaker')) {
                    observationText.textContent = ' Place the BEAKER first to collect the filtered water, then place the funnel on top.';
                    observationText.className = 'observation-text hint';
                    return;
                }
                if (id === 'filter-paper' && !state.placedApparatus.includes('funnel')) {
                    observationText.textContent = ' Place the FUNNEL first, then add the filter paper inside it.';
                    observationText.className = 'observation-text hint';
                    return;
                }
                if (id === 'filter-paper' && !state.placedApparatus.includes('beaker')) {
                    observationText.textContent = ' Place the BEAKER first, then the funnel, then the filter paper.';
                    observationText.className = 'observation-text hint';
                    return;
                }
            }

            // For evaporation experiment: enforce proper order (tripod-stand  china-dish  burner)
            if (expId === 'evaporation') {
                if (id === 'china-dish' && !state.placedApparatus.includes('tripod-stand')) {
                    observationText.textContent = ' Place the TRIPOD STAND first to support the china dish.';
                    observationText.className = 'observation-text hint';
                    return;
                }
                if (id === 'burner' && !state.placedApparatus.includes('tripod-stand')) {
                    observationText.textContent = ' Place the TRIPOD STAND first, then add the burner below it.';
                    observationText.className = 'observation-text hint';
                    return;
                }
            }

            // For physical-chemical experiment: enforce proper order and round-specific apparatus
            if (expId === 'physical-chemical') {
                // After ice is tested, only burner + tongs are allowed (for paper and magnesium)
                if (state.iceTested) {
                    if (id === 'beaker' || id === 'tripod-stand') {
                        observationText.textContent = ' Ice test done! For paper and magnesium, you only need BURNER + TONGS (no beaker).';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                } else {
                    // Before ice is tested, tongs are not allowed (ice needs beaker)
                    if (id === 'tongs') {
                        observationText.textContent = ' Test ICE first! Tongs are needed for paper and magnesium tests later.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                }

                // Enforce proper order for ice round (burner  tripod-stand  beaker)
                if (!state.iceTested) {
                    if (id === 'tripod-stand' && !state.placedApparatus.includes('burner')) {
                        observationText.textContent = ' Place the BURNER first, then the tripod stand on top.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    if (id === 'beaker' && !state.placedApparatus.includes('tripod-stand')) {
                        observationText.textContent = ' Place the TRIPOD STAND first to support the beaker (for heating ice).';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    if (id === 'beaker' && !state.placedApparatus.includes('burner')) {
                        observationText.textContent = ' Place the BURNER first, then tripod stand, then the beaker.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                }
            }

            state.placedApparatus.push(id);

            // Enable actions based on apparatus
            if (id === 'beaker' || id === 'china-dish') {
                observationText.textContent = `${id === 'beaker' ? 'Beaker' : 'China dish'} placed on the bench. Now add chemicals from the shelf.`;
                observationText.className = 'observation-text';

                // Enable Pour button only for filtration experiment
                const expId = state.currentExperiment ? state.currentExperiment.id : '';
                if (id === 'beaker' && expId === 'filtration') {
                    document.getElementById('pourBtn').disabled = false;
                }
            }

            if (id === 'glass-rod') {
                stirBtn.disabled = false;
            }

            // Enable filter button only after pouring (handled in handlePour)
            // Don't auto-enable here anymore

            // Enable heat slider when burner or tripod-stand is placed
            if (id === 'burner' || id === 'tripod-stand') {
                heatSlider.disabled = false;
                // Only enable evaporate button for the evaporation experiment
                const expId = state.currentExperiment ? state.currentExperiment.id : '';
                if (expId === 'evaporation') {
                    document.getElementById('evaporateBtn').disabled = false;
                }
                // Only show HTML burner for experiments that don't draw their own SVG burner
                if (expId !== 'evaporation' && expId !== 'physical-chemical') {
                    burnerContainer.classList.add('active');
                }
            }

            renderApparatusShelf();
            renderChemicalShelf();
            renderDropZone();
            updateProcedureSteps();
        }

        function handleChemicalDrop(id) {
            const expId = state.currentExperiment ? state.currentExperiment.id : '';

            // For salt-dissolution experiment: enforce strict order - salt first, sand after reset
            if (expId === 'salt-dissolution') {
                const hasSalt = state.addedChemicals.includes('salt');
                const hasSand = state.addedChemicals.includes('sand');

                // Round 1: Only salt allowed (sand disabled until salt test is complete)
                if (!state.saltTested) {
                    // Must add water first before salt
                    if (id === 'salt' && !state.addedChemicals.includes('water')) {
                        observationText.textContent = ' Add WATER to the beaker first, then add salt to test its solubility.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    if (id === 'sand') {
                        if (hasSalt) {
                            observationText.textContent = ' You already added salt. Complete the salt test by stirring, then Reset to test sand.';
                        } else {
                            observationText.textContent = ' Step 1: First test SALT to see it dissolves. Sand testing comes after you Reset.';
                        }
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    if (id === 'salt' && hasSalt) {
                        observationText.textContent = 'Salt already added. Now stir the mixture!';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                }

                // Round 2: Only sand allowed (after salt tested AND beaker reset - no salt in current session)
                if (state.saltTested && !state.sandTested) {
                    // Block salt - already tested
                    if (id === 'salt') {
                        observationText.textContent = ' You already tested salt! Now test SAND to compare and complete the experiment.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    // Block sand if salt is still in beaker (need to reset first)
                    if (id === 'sand' && hasSalt) {
                        observationText.textContent = ' Click RESET first to clear the beaker, then test sand in fresh water.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    // Must add water first before sand
                    if (id === 'sand' && !state.addedChemicals.includes('water')) {
                        observationText.textContent = ' Add WATER to the beaker first, then add sand to test its solubility.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    // Block sand if already added
                    if (id === 'sand' && hasSand) {
                        observationText.textContent = 'Sand already added. Now stir the mixture!';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                }

                // Both done - don't allow more additions
                if (state.saltTested && state.sandTested) {
                    if (id === 'salt' || id === 'sand') {
                        observationText.textContent = ' Experiment complete! Both salt and sand have been tested.';
                        observationText.className = 'observation-text success';
                        return;
                    }
                }
            }

            // For physical-chemical experiment: enforce strict order (ice  paper  magnesium)
            if (expId === 'physical-chemical') {
                // Check apparatus requirements
                if (id === 'ice' && !state.placedApparatus.includes('beaker')) {
                    observationText.textContent = ' Ice needs a beaker to catch the melted water.';
                    observationText.className = 'observation-text hint';
                    return;
                }
                if ((id === 'paper' || id === 'magnesium') && !state.placedApparatus.includes('tongs')) {
                    observationText.textContent = ' You need tongs to hold the ' + (id === 'paper' ? 'paper strip' : 'magnesium ribbon') + ' over the flame.';
                    observationText.className = 'observation-text hint';
                    return;
                }

                // Round 1: Only ice allowed
                if (!state.iceTested) {
                    if (id === 'paper' || id === 'magnesium') {
                        observationText.textContent = ' Step 1: First test ICE to observe a physical change (melting). Other materials come after Reset.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    if (id === 'ice' && state.addedChemicals.includes('ice')) {
                        observationText.textContent = 'Ice already added. Now increase the heat to melt it!';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                }

                // Round 2: Only paper allowed (after ice tested + must have reset - no ice in current session)
                if (state.iceTested && !state.paperTested) {
                    if (id === 'ice') {
                        observationText.textContent = ' You already tested ice! Now test PAPER to observe a chemical change (burning).';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    if (id === 'magnesium') {
                        observationText.textContent = ' Test PAPER first, then Reset and test magnesium last.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    // Block paper if ice is still in the beaker (need to reset first)
                    if (id === 'paper' && state.addedChemicals.includes('ice')) {
                        observationText.textContent = ' Click RESET first to clear the setup, then test paper with tongs.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    if (id === 'paper' && state.addedChemicals.includes('paper')) {
                        observationText.textContent = 'Paper already added. Now increase the heat to burn it!';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                }

                // Round 3: Only magnesium allowed (after paper tested + must have reset - no paper in current session)
                if (state.iceTested && state.paperTested && !state.magnesiumTested) {
                    if (id === 'ice' || id === 'paper') {
                        observationText.textContent = ' You already tested ice and paper! Now test MAGNESIUM to complete the experiment.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    // Block magnesium if paper is still in the session (need to reset first)
                    if (id === 'magnesium' && state.addedChemicals.includes('paper')) {
                        observationText.textContent = ' Click RESET first to clear the setup, then test magnesium with tongs.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    if (id === 'magnesium' && state.addedChemicals.includes('magnesium')) {
                        observationText.textContent = 'Magnesium already added. Now increase the heat to burn it!';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                }

                // All done - don't allow more additions
                if (state.iceTested && state.paperTested && state.magnesiumTested) {
                    observationText.textContent = ' Experiment complete! All 3 materials have been tested.';
                    observationText.className = 'observation-text success';
                    return;
                }
            } else if (expId === 'acids-bases') {
                // For acids-bases experiment: need test tube
                if (!state.placedApparatus.includes('test-tube')) {
                    observationText.textContent = 'You need to place a test tube first.';
                    observationText.className = 'observation-text hint';
                    return;
                }

                const acidsBasesSubstances = ['vinegar', 'lemon-juice', 'soap-solution', 'baking-soda'];
                const indicators = ['blue-litmus', 'red-litmus'];
                const hasSubstance = state.addedChemicals.some(c => acidsBasesSubstances.includes(c));
                const hasDropper = state.placedApparatus.includes('dropper');

                // Enforce strict order for substances: vinegar  lemon-juice  soap-solution  baking-soda
                // Each substance must be tested with BOTH litmus before moving to the next
                if (acidsBasesSubstances.includes(id)) {
                    // Round 1: Only vinegar allowed
                    if (!isVinegarTested()) {
                        if (id !== 'vinegar') {
                            observationText.textContent = ' Step 1: First test VINEGAR (an acid) with BOTH litmus papers. Other substances come after.';
                            observationText.className = 'observation-text hint';
                            return;
                        }
                        if (id === 'vinegar' && hasSubstance) {
                            const testedBlue = state.vinegarBlueLitmusTested ? ' Blue' : ' Blue';
                            const testedRed = state.vinegarRedLitmusTested ? ' Red' : ' Red';
                            observationText.textContent = `Vinegar already added. Test with litmus: ${testedBlue}, ${testedRed}`;
                            observationText.className = 'observation-text hint';
                            return;
                        }
                    }

                    // Round 2: Only lemon-juice allowed (after vinegar fully tested + reset)
                    if (isVinegarTested() && !isLemonJuiceTested()) {
                        if (id === 'vinegar') {
                            observationText.textContent = ' Vinegar fully tested! Now test LEMON JUICE with both litmus papers.';
                            observationText.className = 'observation-text hint';
                            return;
                        }
                        if (id !== 'lemon-juice' && id !== 'vinegar') {
                            observationText.textContent = ' Test LEMON JUICE next with both litmus, then Reset and test the bases.';
                            observationText.className = 'observation-text hint';
                            return;
                        }
                        // Block if vinegar still in session
                        if (id === 'lemon-juice' && state.addedChemicals.includes('vinegar')) {
                            observationText.textContent = ' Click RESET first to clear the test tube, then test lemon juice.';
                            observationText.className = 'observation-text hint';
                            return;
                        }
                        if (id === 'lemon-juice' && hasSubstance) {
                            const testedBlue = state.lemonJuiceBlueLitmusTested ? ' Blue' : ' Blue';
                            const testedRed = state.lemonJuiceRedLitmusTested ? ' Red' : ' Red';
                            observationText.textContent = `Lemon juice already added. Test with litmus: ${testedBlue}, ${testedRed}`;
                            observationText.className = 'observation-text hint';
                            return;
                        }
                    }

                    // Round 3: Only soap-solution allowed (after lemon fully tested + reset)
                    if (isVinegarTested() && isLemonJuiceTested() && !isSoapSolutionTested()) {
                        if (id === 'vinegar' || id === 'lemon-juice') {
                            observationText.textContent = ' Acids fully tested! Now test SOAP SOLUTION with both litmus papers.';
                            observationText.className = 'observation-text hint';
                            return;
                        }
                        if (id === 'baking-soda') {
                            observationText.textContent = ' Test SOAP SOLUTION first with both litmus, then Reset and test baking soda.';
                            observationText.className = 'observation-text hint';
                            return;
                        }
                        // Block if lemon-juice still in session
                        if (id === 'soap-solution' && state.addedChemicals.includes('lemon-juice')) {
                            observationText.textContent = ' Click RESET first to clear the test tube, then test soap solution.';
                            observationText.className = 'observation-text hint';
                            return;
                        }
                        if (id === 'soap-solution' && hasSubstance) {
                            const testedBlue = state.soapSolutionBlueLitmusTested ? ' Blue' : ' Blue';
                            const testedRed = state.soapSolutionRedLitmusTested ? ' Red' : ' Red';
                            observationText.textContent = `Soap solution already added. Test with litmus: ${testedBlue}, ${testedRed}`;
                            observationText.className = 'observation-text hint';
                            return;
                        }
                    }

                    // Round 4: Only baking-soda allowed (after soap fully tested + reset)
                    if (isVinegarTested() && isLemonJuiceTested() && isSoapSolutionTested() && !isBakingSodaTested()) {
                        if (id !== 'baking-soda') {
                            observationText.textContent = ' First 3 substances tested! Now test BAKING SODA with both litmus to complete.';
                            observationText.className = 'observation-text hint';
                            return;
                        }
                        // Block if soap-solution still in session
                        if (id === 'baking-soda' && state.addedChemicals.includes('soap-solution')) {
                            observationText.textContent = ' Click RESET first to clear the test tube, then test baking soda.';
                            observationText.className = 'observation-text hint';
                            return;
                        }
                        if (id === 'baking-soda' && hasSubstance) {
                            const testedBlue = state.bakingSodaBlueLitmusTested ? ' Blue' : ' Blue';
                            const testedRed = state.bakingSodaRedLitmusTested ? ' Red' : ' Red';
                            observationText.textContent = `Baking soda already added. Test with litmus: ${testedBlue}, ${testedRed}`;
                            observationText.className = 'observation-text hint';
                            return;
                        }
                    }

                    // All done - don't allow more substances
                    if (areAllAcidsBasesTested()) {
                        observationText.textContent = ' Experiment complete! All 4 substances have been tested with both litmus papers.';
                        observationText.className = 'observation-text success';
                        return;
                    }
                }

                // Check if trying to add indicator without dropper or substance
                if (indicators.includes(id)) {
                    if (!hasDropper) {
                        observationText.textContent = 'Place a dropper first to add the litmus indicator drops.';
                        observationText.className = 'observation-text hint';
                        return;
                    }
                    if (!hasSubstance) {
                        observationText.textContent = 'Add a substance (acid or base) to the test tube first, then use the dropper to add litmus.';
                        observationText.className = 'observation-text hint';
                        return;
                    }

                    // Start litmus drop animation - 4 drops with gradual color change
                    state.litmusDropCount = 0;
                    state.litmusAnimating = true;
                    state.litmusIndicator = id;

                    // Add the indicator to chemicals immediately (for tracking)
                    state.addedChemicals.push(id);

                    // Show dropping message
                    observationText.textContent = `Adding ${id === 'blue-litmus' ? 'Blue' : 'Red'} Litmus drops... watch the color change!`;
                    observationText.className = 'observation-text';

                    // Animate the drops
                    animateLitmusDrops();

                    renderChemicalShelf();
                    renderDropZone();
                    return; // Exit early - checkReaction will be called after animation
                }
            } else {
                // For other experiments, check for valid container
                const hasContainer = state.placedApparatus.includes('beaker') ||
                    state.placedApparatus.includes('funnel') ||
                    state.placedApparatus.includes('china-dish');

                if (!hasContainer) {
                    observationText.textContent = 'You need to place a container (beaker, funnel, or dish) first.';
                    observationText.className = 'observation-text hint';
                    return;
                }
            }

            if (state.addedChemicals.includes(id)) return;

            state.addedChemicals.push(id);
            const chem = state.currentExperiment.chemicals.find(c => c.id === id);
            const chemName = chem ? chem.name : id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            state.observationHistory.push({
                action: `Added ${chemName}`,
                observation: `${chemName} was added.`
            });

            observationText.textContent = `Added ${chemName}.`;
            observationText.className = 'observation-text';

            // For neutralization experiment: trigger HCl drop animation
            if (expId === 'neutralization' && id === 'hcl') {
                // Start HCl drop animation - 5 drops with gradual color change
                state.neutralizationDropCount = 0;
                state.neutralizationAnimating = true;

                // Show dropping message
                observationText.textContent = `Adding ${chemName} drop by drop... watch the pink color fade as the base is neutralized!`;
                observationText.className = 'observation-text';

                // Start the animation
                animateNeutralizationDrops();

                renderChemicalShelf();
                renderDropZone();
                return; // Exit early - checkReaction will be called after animation
            }

            renderChemicalShelf();
            renderApparatusShelf(); // Re-render apparatus shelf to enable dropper after substance is added
            renderDropZone();
            checkReaction();
            updateProcedureSteps();
        }

        // ==================== LITMUS DROP ANIMATION ====================
        function animateLitmusDrops() {
            const totalDrops = 4;
            const dropInterval = 600; // ms between drops

            function dropNext() {
                if (state.litmusDropCount >= totalDrops) {
                    // Animation complete - show final reaction
                    state.litmusAnimating = false;
                    checkReaction();
                    renderDropZone();

                    // Log the observation
                    state.observationHistory.push({
                        action: `Added ${state.litmusIndicator}`,
                        observation: `Litmus indicator was added drop by drop.`
                    });
                    return;
                }

                // Increment drop count and re-render
                state.litmusDropCount++;
                state.lastDropTime = Date.now();
                renderDropZone();

                // Schedule next drop
                setTimeout(dropNext, dropInterval);
            }

            // Start the first drop
            setTimeout(dropNext, 200);
        }

        // ==================== NEUTRALIZATION DROP ANIMATION ====================
        function animateNeutralizationDrops() {
            const totalDrops = 5;
            const dropInterval = 700; // ms between drops

            function dropNext() {
                if (state.neutralizationDropCount >= totalDrops) {
                    // Animation complete - show final reaction
                    state.neutralizationAnimating = false;
                    checkReaction();
                    renderDropZone();
                    updateProcedureSteps();

                    // Log the observation
                    state.observationHistory.push({
                        action: 'Added Dilute HCl',
                        observation: 'HCl was added drop by drop, neutralizing the basic solution.'
                    });
                    return;
                }

                // Increment drop count and re-render
                state.neutralizationDropCount++;
                state.lastNeutralizationDropTime = Date.now();
                renderDropZone();

                // Schedule next drop
                setTimeout(dropNext, dropInterval);
            }

            // Start the first drop
            setTimeout(dropNext, 300);
        }

        // Calculate interpolated color for gradual transition
        function interpolateColor(startColor, endColor, progress) {
            // Parse hex colors to RGB
            const parseHex = (hex) => {
                const h = hex.replace('#', '');
                return {
                    r: parseInt(h.substr(0, 2), 16),
                    g: parseInt(h.substr(2, 2), 16),
                    b: parseInt(h.substr(4, 2), 16)
                };
            };

            const start = parseHex(startColor);
            const end = parseHex(endColor);

            const r = Math.round(start.r + (end.r - start.r) * progress);
            const g = Math.round(start.g + (end.g - start.g) * progress);
            const b = Math.round(start.b + (end.b - start.b) * progress);

            return `rgb(${r},${g},${b})`;
        }

        // ==================== ACTIONS ====================
        function handleHeatChange(e) {
            const newHeatLevel = parseInt(e.target.value);
            const wasHeating = state.heatLevel > 30;
            const isNowHeating = newHeatLevel > 30;
            state.heatLevel = newHeatLevel;

            if (state.heatLevel > 0) {
                burnerFlame.classList.add('on');
                burnerFlame.style.height = (20 + state.heatLevel * 0.25) + 'px';
            } else {
                burnerFlame.classList.remove('on');
            }

            // Track when heating threshold is crossed for the first time
            if (!wasHeating && isNowHeating && !state.actions.includes('heat')) {
                state.actions.push('heat');
                state.observationHistory.push({
                    action: 'Started heating',
                    observation: 'Applied heat to the solution.'
                });
            }

            // Update visuals and check reaction when heating state changes
            if (wasHeating !== isNowHeating) {
                renderDropZone();
                checkReaction();
            }
        }

        function handleStir() {
            if (!state.placedApparatus.includes('glass-rod')) return;
            if (state.addedChemicals.length === 0) {
                observationText.textContent = 'There is nothing to stir. Add some chemicals first.';
                observationText.className = 'observation-text hint';
                return;
            }

            state.stirCount++;
            state.lastStirTime = Date.now();
            state.actions.push('stir');

            state.observationHistory.push({
                action: 'Stirred',
                observation: 'Stirred the mixture with glass rod.'
            });

            // Animate stir button
            stirBtn.classList.add('active');
            setTimeout(() => stirBtn.classList.remove('active'), 300);

            // Re-render immediately to show stirring animation (glass rod inside beaker)
            renderDropZone();

            // Check reaction after animation completes
            setTimeout(() => {
                renderDropZone();
                checkReaction();
                updateProcedureSteps();
            }, 600);
        }

        function handlePour() {
            // Check if we have liquid to pour
            if (state.addedChemicals.length === 0) {
                observationText.textContent = 'Add a liquid first before pouring.';
                observationText.className = 'observation-text hint';
                return;
            }

            // Check if filtration setup is ready for pouring
            if (!state.placedApparatus.includes('funnel') || !state.placedApparatus.includes('filter-paper')) {
                observationText.textContent = 'Set up the filtration apparatus first (funnel + filter paper).';
                observationText.className = 'observation-text hint';
                return;
            }

            state.lastPourTime = Date.now();
            state.actions.push('pour');
            state.observationHistory.push({
                action: 'Poured',
                observation: 'Poured the muddy water into the funnel. Filtration is starting...'
            });

            // Animate pour button
            const pourBtn = document.getElementById('pourBtn');
            pourBtn.classList.add('active');
            setTimeout(() => pourBtn.classList.remove('active'), 500);

            // Re-render to show pouring animation
            renderDropZone();
            updateProcedureSteps();
            checkReaction();

            // After pouring, filtration happens automatically (3 seconds to complete)
            setTimeout(() => {
                state.lastFilterTime = Date.now();
                state.actions.push('filter');
                state.observationHistory.push({
                    action: 'Filtered',
                    observation: 'The water has filtered through! Clear water collected in beaker, mud trapped on filter paper.'
                });
                renderDropZone();
                updateProcedureSteps();
                checkReaction();
            }, 3000);
        }

        function handleFilter() {
            // Check if filter apparatus is placed
            if (!state.placedApparatus.includes('funnel') || !state.placedApparatus.includes('filter-paper')) {
                observationText.textContent = 'You need to set up the filtration apparatus first. Place the funnel and filter paper.';
                observationText.className = 'observation-text hint';
                return;
            }

            if (state.addedChemicals.length === 0) {
                observationText.textContent = 'Add the liquid you want to filter first.';
                observationText.className = 'observation-text hint';
                return;
            }

            state.lastFilterTime = Date.now();
            state.actions.push('filter');
            state.observationHistory.push({
                action: 'Filtered',
                observation: 'Performed filtration through filter paper.'
            });

            // Animate filter button
            const filterBtn = document.getElementById('filterBtn');
            filterBtn.classList.add('active');
            setTimeout(() => filterBtn.classList.remove('active'), 500);

            renderDropZone();
            checkReaction();
        }

        function handleEvaporate() {
            if (state.heatLevel < 30) {
                observationText.textContent = 'You need to increase the heat first. Move the heat slider to the right.';
                observationText.className = 'observation-text hint';
                return;
            }

            if (state.addedChemicals.length === 0) {
                observationText.textContent = 'Add a solution first before trying to evaporate.';
                observationText.className = 'observation-text hint';
                return;
            }

            // Prevent double-clicking
            if (state.isEvaporating || state.actions.includes('evaporate')) {
                return;
            }

            // Start evaporation animation
            state.isEvaporating = true;
            observationText.textContent = 'The solution is boiling... Water is evaporating as steam. Watch the liquid level decrease!';
            observationText.className = 'observation-text';

            // Animate evaporate button
            const evaporateBtn = document.getElementById('evaporateBtn');
            evaporateBtn.classList.add('active');
            evaporateBtn.disabled = true;

            // Show evaporating animation
            renderDropZone();

            // After liquid evaporation animation completes (4s), show final state
            setTimeout(() => {
                state.isEvaporating = false;
                state.actions.push('evaporate');
                state.observationHistory.push({
                    action: 'Evaporated',
                    observation: 'Heated until the liquid evaporated. White salt crystals were left behind in the dish.'
                });

                evaporateBtn.classList.remove('active');

                renderDropZone();
                checkReaction();
            }, 4000);
        }

        // ==================== LAB RECORD ====================
        function showLabRecord() {
            const exp = state.currentExperiment;
            if (!exp) return;

            // For experiments with multiple rounds: combine all test histories
            let fullHistory = [];
            if (exp.id === 'salt-dissolution') {
                fullHistory = [...state.saltTestHistory, ...state.observationHistory];
            } else if (exp.id === 'physical-chemical') {
                fullHistory = [...state.physicalChemicalTestHistory, ...state.observationHistory];
            } else if (exp.id === 'acids-bases') {
                fullHistory = [...state.acidsBasesTestHistory, ...state.observationHistory];
            } else {
                fullHistory = state.observationHistory;
            }

            // Generate procedure based on experiment type
            let procedure = '';
            if (exp.id === 'acids-bases') {
                // Custom procedure for acids-bases showing all 8 steps (reset between each litmus)
                const steps = [];
                if (state.vinegarBlueLitmusTested) {
                    steps.push('Place test tube stand, test tube, and dropper. Add vinegar and blue litmus - observe blue turns RED (acid).');
                }
                if (state.vinegarRedLitmusTested) {
                    steps.push('Reset. Add vinegar and red litmus - observe red stays red (confirms acid).');
                }
                if (state.lemonJuiceBlueLitmusTested) {
                    steps.push('Reset. Add lemon juice and blue litmus - observe blue turns RED (acid).');
                }
                if (state.lemonJuiceRedLitmusTested) {
                    steps.push('Reset. Add lemon juice and red litmus - observe red stays red (confirms acid).');
                }
                if (state.soapSolutionRedLitmusTested) {
                    steps.push('Reset. Add soap solution and red litmus - observe red turns BLUE (base).');
                }
                if (state.soapSolutionBlueLitmusTested) {
                    steps.push('Reset. Add soap solution and blue litmus - observe blue stays blue (confirms base).');
                }
                if (state.bakingSodaRedLitmusTested) {
                    steps.push('Reset. Add baking soda solution and red litmus - observe red turns BLUE (base).');
                }
                if (state.bakingSodaBlueLitmusTested) {
                    steps.push('Reset. Add baking soda solution and blue litmus - observe blue stays blue (confirms base).');
                }
                procedure = steps.map((s, i) => `<li>${s}</li>`).join('');
            } else if (exp.id === 'neutralization') {
                // Custom procedure for neutralization
                const steps = [];
                if (state.addedChemicals.includes('naoh')) {
                    steps.push('Place beaker and dropper on the bench.');
                    steps.push('Add NaOH solution (sodium hydroxide) to the beaker - a colorless basic solution.');
                }
                if (state.addedChemicals.includes('phenolphthalein')) {
                    steps.push('Add phenolphthalein indicator - the solution turns PINK indicating a base.');
                }
                if (state.addedChemicals.includes('hcl') && !state.neutralizationAnimating) {
                    steps.push('Add dilute HCl (hydrochloric acid) drop by drop using the dropper.');
                    steps.push('Observe the pink color gradually fading as the acid neutralizes the base.');
                    steps.push('The solution becomes COLORLESS when neutralization is complete.');
                }
                procedure = steps.map((s, i) => `<li>${s}</li>`).join('');
            } else {
                procedure = fullHistory.map((h, i) =>
                    `<li>${h.action}</li>`
                ).join('');
            }

            // For multi-round experiments: determine if all tests are complete
            const lastReaction = exp.reactions[getReactionKey()];
            let observation = lastReaction ? lastReaction.observation : 'Experiment in progress...';
            let showConclusion = lastReaction && lastReaction.success;

            // For salt-dissolution: show both observations and only complete conclusion when both done
            if (exp.id === 'salt-dissolution') {
                const observations = [];
                if (state.saltTested) {
                    observations.push('Salt Test: Salt crystals gradually disappear - salt is SOLUBLE in water.');
                }
                if (state.sandTested) {
                    observations.push('Sand Test: Sand particles swirl but settle at bottom - sand is INSOLUBLE in water.');
                }
                if (observations.length > 0) {
                    observation = observations.join(' | ');
                }
                showConclusion = state.saltTested && state.sandTested;
            }

            // For physical-chemical: show all tested material observations
            if (exp.id === 'physical-chemical') {
                const observations = [];
                if (state.iceTested) {
                    observations.push('Ice Test (PHYSICAL): Ice melts into water - reversible, no new substance formed.');
                }
                if (state.paperTested) {
                    observations.push('Paper Test (CHEMICAL): Paper burns to ash - irreversible, new substances formed.');
                }
                if (state.magnesiumTested) {
                    observations.push('Magnesium Test (CHEMICAL): Burns with bright white flame, forms white MgO powder.');
                }
                if (observations.length > 0) {
                    observation = observations.join(' | ');
                }
                showConclusion = state.iceTested && state.paperTested && state.magnesiumTested;
            }

            // For acids-bases: show all tested substance observations
            if (exp.id === 'acids-bases') {
                const observations = [];
                if (isVinegarTested()) {
                    observations.push('Vinegar (ACID): Blue litmus turns RED, red litmus stays red.');
                }
                if (isLemonJuiceTested()) {
                    observations.push('Lemon Juice (ACID): Blue litmus turns RED, red litmus stays red.');
                }
                if (isSoapSolutionTested()) {
                    observations.push('Soap Solution (BASE): Red litmus turns BLUE, blue litmus stays blue.');
                }
                if (isBakingSodaTested()) {
                    observations.push('Baking Soda (BASE): Red litmus turns BLUE, blue litmus stays blue.');
                }
                if (observations.length > 0) {
                    observation = observations.join(' | ');
                }
                showConclusion = areAllAcidsBasesTested();
            }

            // For neutralization: show the complete observation
            if (exp.id === 'neutralization') {
                const hasHCl = state.addedChemicals.includes('hcl');
                const isNeutralized = hasHCl && !state.neutralizationAnimating;
                if (isNeutralized) {
                    observation = 'NEUTRALIZATION COMPLETE! The solution is now colorless - the acid has neutralized the base! HCl + NaOH produces NaCl + H2O.';
                    showConclusion = true;
                } else if (state.addedChemicals.includes('phenolphthalein')) {
                    observation = 'The solution turned PINK! Phenolphthalein indicates the presence of a base. Add HCl to neutralize.';
                } else if (state.addedChemicals.includes('naoh')) {
                    observation = 'NaOH solution is in the beaker. Add phenolphthalein indicator.';
                }
            }

            labRecordContent.innerHTML = `
                <div class="lab-record-section">
                    <h4>Aim</h4>
                    <p>${exp.aim}</p>
                </div>
                <div class="lab-record-section">
                    <h4>Apparatus Used</h4>
                    <ul>
                        ${state.placedApparatus.length > 0 ?
                    state.placedApparatus.map(a => {
                        const name = a.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        return `<li>${name}</li>`;
                    }).join('') :
                    '<li>No apparatus used yet.</li>'
                }
                    </ul>
                </div>
                <div class="lab-record-section">
                    <h4>Chemicals/Materials</h4>
                    <ul>
                        ${exp.id === 'salt-dissolution' ?
                    '<li>Water</li>' + (state.saltTested ? '<li>Common Salt</li>' : '') + (state.sandTested ? '<li>Sand</li>' : '') :
                    exp.id === 'physical-chemical' ?
                        (state.iceTested ? '<li>Ice Cubes</li>' : '') + (state.paperTested ? '<li>Paper Strip</li>' : '') + (state.magnesiumTested ? '<li>Magnesium Ribbon</li>' : '') :
                        exp.id === 'acids-bases' ?
                            (isVinegarTested() ? '<li>Vinegar (Acid)</li>' : '') + (isLemonJuiceTested() ? '<li>Lemon Juice (Acid)</li>' : '') + (isSoapSolutionTested() ? '<li>Soap Solution (Base)</li>' : '') + (isBakingSodaTested() ? '<li>Baking Soda Solution (Base)</li>' : '') + '<li>Litmus Indicators (Blue & Red)</li>' :
                            state.addedChemicals.map(c => {
                                const chem = exp.chemicals.find(ch => ch.id === c);
                                return `<li>${chem ? chem.name : c}</li>`;
                            }).join('')
                }
                    </ul>
                </div>
                <div class="lab-record-section">
                    <h4>Procedure</h4>
                    <ol>${procedure || '<li>No steps recorded yet.</li>'}</ol>
                </div>
                <div class="lab-record-section">
                    <h4>Observation</h4>
                    <p>${observation}</p>
                </div>
                <div class="lab-record-section">
                    <h4>Conclusion</h4>
                    <p>${showConclusion ? exp.conclusion : (exp.id === 'salt-dissolution' ? 'Complete both tests (salt AND sand) to see the conclusion.' : exp.id === 'physical-chemical' ? 'Complete all 3 tests (ice, paper, AND magnesium) to see the conclusion.' : exp.id === 'acids-bases' ? 'Complete all 8 litmus tests (2 per substance: vinegar, lemon juice, soap, AND baking soda) to see the conclusion.' : 'Complete the experiment to see the conclusion.')}</p>
                </div>
            `;

            labRecordModal.classList.add('active');
        }
        function hideLabRecord() {
            labRecordModal.classList.remove('active');
        }

        function exportLabRecordPdf() {
            const exp = state.currentExperiment;
            if (!exp) return;

            // Get jsPDF from the global scope
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            const contentWidth = pageWidth - 2 * margin;
            let y = 20;

            // Helper function to sanitize text for PDF (replace Unicode characters that don't render properly)
            function sanitizeForPdf(text) {
                if (!text) return text;
                return text
                    // Replace superscript plus/minus
                    .replace(//g, '+')
                    .replace(//g, '-')
                    // Replace subscript numbers
                    .replace(//g, '0')
                    .replace(//g, '1')
                    .replace(//g, '2')
                    .replace(//g, '3')
                    .replace(//g, '4')
                    .replace(//g, '5')
                    .replace(//g, '6')
                    .replace(//g, '7')
                    .replace(//g, '8')
                    .replace(//g, '9')
                    // Replace other common problematic characters
                    .replace(//g, '->')
                    .replace(//g, '<-')
                    .replace(//g, ' deg')
                    // Remove emojis that don't render
                    .replace(/[]/g, '')
                    // Clean up any double spaces
                    .replace(/\s+/g, ' ')
                    .trim();
            }

            // Helper function to add text with word wrap
            function addWrappedText(text, x, startY, maxWidth, lineHeight = 7) {
                // Sanitize text to replace problematic Unicode characters
                const sanitizedText = sanitizeForPdf(text);
                const lines = doc.splitTextToSize(sanitizedText, maxWidth);
                lines.forEach((line, i) => {
                    if (startY + (i * lineHeight) > 270) {
                        doc.addPage();
                        startY = 20;
                    }
                    doc.text(line, x, startY + (i * lineHeight));
                });
                return startY + (lines.length * lineHeight);
            }

            // Helper function for section headers
            function addSectionHeader(title, yPos) {
                if (yPos > 260) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.setFillColor(37, 99, 235);
                doc.rect(margin, yPos - 1, 3, 8, 'F');
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(30, 64, 175);
                doc.text(title.toUpperCase(), margin + 6, yPos + 5);
                return yPos + 12;
            }

            // Title
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(30, 64, 175);
            doc.text('LABORATORY RECORD', pageWidth / 2, y, { align: 'center' });
            y += 10;

            // Class and Chapter info
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`Class ${state.currentClass} | ${exp.chapter}`, pageWidth / 2, y, { align: 'center' });
            y += 8;

            // Experiment Title
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(50, 50, 50);
            doc.text(exp.title, pageWidth / 2, y, { align: 'center' });
            y += 8;

            // Divider line
            doc.setDrawColor(37, 99, 235);
            doc.setLineWidth(0.8);
            doc.line(margin, y, pageWidth - margin, y);
            y += 12;

            // AIM section
            y = addSectionHeader('Aim', y);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50, 50, 50);
            y = addWrappedText(exp.aim, margin + 6, y, contentWidth - 10);
            y += 8;

            // APPARATUS section
            y = addSectionHeader('Apparatus Used', y);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50, 50, 50);
            if (state.placedApparatus.length > 0) {
                state.placedApparatus.forEach((a, i) => {
                    const name = a.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    doc.text(`${i + 1}. ${name}`, margin + 10, y);
                    y += 6;
                });
            } else {
                doc.text('No apparatus used yet.', margin + 10, y);
                y += 6;
            }
            y += 6;

            // CHEMICALS section
            y = addSectionHeader('Chemicals / Materials', y);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50, 50, 50);
            if (exp.id === 'salt-dissolution') {
                // For salt-dissolution: show chemicals based on tests completed
                let chemIndex = 1;
                doc.text(`${chemIndex}. Water`, margin + 10, y);
                y += 6;
                chemIndex++;
                if (state.saltTested) {
                    doc.text(`${chemIndex}. Common Salt`, margin + 10, y);
                    y += 6;
                    chemIndex++;
                }
                if (state.sandTested) {
                    doc.text(`${chemIndex}. Sand`, margin + 10, y);
                    y += 6;
                }
            } else if (exp.id === 'physical-chemical') {
                // For physical-chemical: show materials based on tests completed
                let chemIndex = 1;
                if (state.iceTested) {
                    doc.text(`${chemIndex}. Ice Cubes`, margin + 10, y);
                    y += 6;
                    chemIndex++;
                }
                if (state.paperTested) {
                    doc.text(`${chemIndex}. Paper Strip`, margin + 10, y);
                    y += 6;
                    chemIndex++;
                }
                if (state.magnesiumTested) {
                    doc.text(`${chemIndex}. Magnesium Ribbon`, margin + 10, y);
                    y += 6;
                }
            } else if (exp.id === 'acids-bases') {
                // For acids-bases: show substances based on tests completed
                let chemIndex = 1;
                if (isVinegarTested()) {
                    doc.text(`${chemIndex}. Vinegar (Acid)`, margin + 10, y);
                    y += 6;
                    chemIndex++;
                }
                if (isLemonJuiceTested()) {
                    doc.text(`${chemIndex}. Lemon Juice (Acid)`, margin + 10, y);
                    y += 6;
                    chemIndex++;
                }
                if (isSoapSolutionTested()) {
                    doc.text(`${chemIndex}. Soap Solution (Base)`, margin + 10, y);
                    y += 6;
                    chemIndex++;
                }
                if (isBakingSodaTested()) {
                    doc.text(`${chemIndex}. Baking Soda Solution (Base)`, margin + 10, y);
                    y += 6;
                    chemIndex++;
                }
                doc.text(`${chemIndex}. Litmus Indicators (Blue & Red)`, margin + 10, y);
                y += 6;
            } else if (state.addedChemicals.length > 0) {
                state.addedChemicals.forEach((c, i) => {
                    const chem = exp.chemicals.find(ch => ch.id === c);
                    const name = chem ? chem.name : c.replace(/-/g, ' ');
                    doc.text(`${i + 1}. ${name}`, margin + 10, y);
                    y += 6;
                });
            } else {
                doc.text('No chemicals added yet.', margin + 10, y);
                y += 6;
            }
            y += 6;

            // PROCEDURE section
            y = addSectionHeader('Procedure', y);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50, 50, 50);

            // For multi-round experiments: combine all test histories
            let fullHistory = [];
            if (exp.id === 'salt-dissolution') {
                fullHistory = [...state.saltTestHistory, ...state.observationHistory];
            } else if (exp.id === 'physical-chemical') {
                fullHistory = [...state.physicalChemicalTestHistory, ...state.observationHistory];
            } else if (exp.id === 'acids-bases') {
                fullHistory = [...state.acidsBasesTestHistory, ...state.observationHistory];
            } else {
                fullHistory = state.observationHistory;
            }

            // For acids-bases: use custom procedure steps
            if (exp.id === 'acids-bases') {
                const steps = [];
                if (state.vinegarBlueLitmusTested) {
                    steps.push('Setup apparatus. Add vinegar and blue litmus - blue turns RED (acid).');
                }
                if (state.vinegarRedLitmusTested) {
                    steps.push('Reset. Add vinegar and red litmus - red stays red (confirms acid).');
                }
                if (state.lemonJuiceBlueLitmusTested) {
                    steps.push('Reset. Add lemon juice and blue litmus - blue turns RED (acid).');
                }
                if (state.lemonJuiceRedLitmusTested) {
                    steps.push('Reset. Add lemon juice and red litmus - red stays red (confirms acid).');
                }
                if (state.soapSolutionRedLitmusTested) {
                    steps.push('Reset. Add soap solution and red litmus - red turns BLUE (base).');
                }
                if (state.soapSolutionBlueLitmusTested) {
                    steps.push('Reset. Add soap solution and blue litmus - blue stays blue (confirms base).');
                }
                if (state.bakingSodaRedLitmusTested) {
                    steps.push('Reset. Add baking soda solution and red litmus - red turns BLUE (base).');
                }
                if (state.bakingSodaBlueLitmusTested) {
                    steps.push('Reset. Add baking soda solution and blue litmus - blue stays blue (confirms base).');
                }
                if (steps.length > 0) {
                    steps.forEach((step, i) => {
                        if (y > 260) {
                            doc.addPage();
                            y = 20;
                        }
                        y = addWrappedText(`${i + 1}. ${step}`, margin + 10, y, contentWidth - 15);
                        y += 2;
                    });
                } else {
                    doc.text('No steps recorded yet.', margin + 10, y);
                    y += 6;
                }
            } else if (exp.id === 'neutralization') {
                // Custom procedure for neutralization
                const steps = [];
                if (state.addedChemicals.includes('naoh')) {
                    steps.push('Place beaker and dropper on the bench.');
                    steps.push('Add NaOH solution (sodium hydroxide) to the beaker - a colorless basic solution.');
                }
                if (state.addedChemicals.includes('phenolphthalein')) {
                    steps.push('Add phenolphthalein indicator - the solution turns PINK indicating a base.');
                }
                if (state.addedChemicals.includes('hcl') && !state.neutralizationAnimating) {
                    steps.push('Add dilute HCl (hydrochloric acid) drop by drop using the dropper.');
                    steps.push('Observe the pink color gradually fading as the acid neutralizes the base.');
                    steps.push('The solution becomes COLORLESS when neutralization is complete.');
                }
                if (steps.length > 0) {
                    steps.forEach((step, i) => {
                        if (y > 260) {
                            doc.addPage();
                            y = 20;
                        }
                        y = addWrappedText(`${i + 1}. ${step}`, margin + 10, y, contentWidth - 15);
                        y += 2;
                    });
                } else {
                    doc.text('No steps recorded yet.', margin + 10, y);
                    y += 6;
                }
            } else if (fullHistory.length > 0) {
                fullHistory.forEach((h, i) => {
                    if (y > 260) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(sanitizeForPdf(`${i + 1}. ${h.action}`), margin + 10, y);
                    y += 6;
                });
            } else {
                doc.text('No steps recorded yet.', margin + 10, y);
                y += 6;
            }
            y += 6;

            // OBSERVATION section
            y = addSectionHeader('Observation', y);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50, 50, 50);

            let observation = '';
            if (exp.id === 'salt-dissolution') {
                // For salt-dissolution: show both test observations
                const observations = [];
                if (state.saltTested) {
                    observations.push('Salt Test: Salt crystals gradually disappear - salt is SOLUBLE in water.');
                }
                if (state.sandTested) {
                    observations.push('Sand Test: Sand particles swirl but settle at bottom - sand is INSOLUBLE in water.');
                }
                if (observations.length > 0) {
                    observation = observations.join(' ');
                } else {
                    observation = 'Experiment in progress...';
                }
            } else if (exp.id === 'physical-chemical') {
                // For physical-chemical: show all tested material observations
                const observations = [];
                if (state.iceTested) {
                    observations.push('Ice Test (PHYSICAL): Ice melts into water - reversible, no new substance formed.');
                }
                if (state.paperTested) {
                    observations.push('Paper Test (CHEMICAL): Paper burns to ash - irreversible, new substances formed.');
                }
                if (state.magnesiumTested) {
                    observations.push('Magnesium Test (CHEMICAL): Burns with bright white flame, forms white MgO powder.');
                }
                if (observations.length > 0) {
                    observation = observations.join(' ');
                } else {
                    observation = 'Experiment in progress...';
                }
            } else if (exp.id === 'acids-bases') {
                // For acids-bases: show all tested substance observations
                const observations = [];
                if (isVinegarTested()) {
                    observations.push('Vinegar (ACID): Blue litmus turns RED, red litmus stays red.');
                }
                if (isLemonJuiceTested()) {
                    observations.push('Lemon Juice (ACID): Blue litmus turns RED, red litmus stays red.');
                }
                if (isSoapSolutionTested()) {
                    observations.push('Soap Solution (BASE): Red litmus turns BLUE, blue litmus stays blue.');
                }
                if (isBakingSodaTested()) {
                    observations.push('Baking Soda (BASE): Red litmus turns BLUE, blue litmus stays blue.');
                }
                if (observations.length > 0) {
                    observation = observations.join(' ');
                } else {
                    observation = 'Experiment in progress...';
                }
            } else if (exp.id === 'neutralization') {
                // For neutralization: show the observation
                const hasHCl = state.addedChemicals.includes('hcl');
                const isNeutralized = hasHCl && !state.neutralizationAnimating;
                if (isNeutralized) {
                    observation = 'NEUTRALIZATION COMPLETE! The solution is now colorless - the acid has neutralized the base! HCl + NaOH -> NaCl + H2O.';
                } else if (state.addedChemicals.includes('phenolphthalein')) {
                    observation = 'The solution turned PINK! Phenolphthalein indicates the presence of a base.';
                } else if (state.addedChemicals.includes('naoh')) {
                    observation = 'NaOH solution is in the beaker.';
                } else {
                    observation = 'Experiment in progress...';
                }
            } else {
                const lastReaction = exp.reactions[getReactionKey()];
                observation = lastReaction ? lastReaction.observation : 'Experiment in progress...';
            }

            y = addWrappedText(observation, margin + 6, y, contentWidth - 10);
            y += 8;

            // CONCLUSION section
            y = addSectionHeader('Conclusion', y);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50, 50, 50);

            let showConclusion = false;
            if (exp.id === 'salt-dissolution') {
                // For salt-dissolution: only show conclusion when both tests are complete
                showConclusion = state.saltTested && state.sandTested;
            } else if (exp.id === 'physical-chemical') {
                // For physical-chemical: only show conclusion when all 3 tests are complete
                showConclusion = state.iceTested && state.paperTested && state.magnesiumTested;
            } else if (exp.id === 'acids-bases') {
                // For acids-bases: only show conclusion when all 4 tests are complete (both litmus each)
                showConclusion = areAllAcidsBasesTested();
            } else if (exp.id === 'neutralization') {
                // For neutralization: show conclusion when HCl drops are complete
                const hasHCl = state.addedChemicals.includes('hcl');
                showConclusion = hasHCl && !state.neutralizationAnimating;
            } else {
                const lastReaction = exp.reactions[getReactionKey()];
                showConclusion = lastReaction && lastReaction.success;
            }

            // Check if we need a new page for conclusion
            if (y > 240) {
                doc.addPage();
                y = 20;
            }

            const conclusion = showConclusion ? exp.conclusion : (exp.id === 'salt-dissolution' ? 'Complete both tests (salt AND sand) to see the conclusion.' : exp.id === 'physical-chemical' ? 'Complete all 3 tests (ice, paper, AND magnesium) to see the conclusion.' : exp.id === 'acids-bases' ? 'Complete all 8 litmus tests (2 per substance: vinegar, lemon juice, soap, AND baking soda) to see the conclusion.' : 'Complete the experiment to see the conclusion.');
            y = addWrappedText(conclusion, margin + 6, y, contentWidth - 10);
            y += 15;

            // Save the PDF with experiment name
            const fileName = `Lab_Record_${exp.title.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
            doc.save(fileName);
        }

        // ==================== CERTIFICATE GENERATION ====================
        function generateCertificate(studentName) {
            const { jsPDF } = window.jspdf;
            // Landscape A4 certificate
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

            const pageWidth = 297; // A4 landscape width in mm
            const pageHeight = 210; // A4 landscape height in mm

            // Background gradient effect (light cream/beige)
            doc.setFillColor(255, 253, 245);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');

            // Decorative border - outer
            doc.setDrawColor(0, 90, 156); // Deep blue
            doc.setLineWidth(3);
            doc.rect(8, 8, pageWidth - 16, pageHeight - 16);

            // Decorative border - inner
            doc.setDrawColor(255, 193, 7); // Gold
            doc.setLineWidth(1.5);
            doc.rect(14, 14, pageWidth - 28, pageHeight - 28);

            // Corner decorations (gold stars)
            doc.setFillColor(255, 193, 7);
            const starSize = 6;
            // Top-left
            drawStar(doc, 25, 25, starSize);
            // Top-right
            drawStar(doc, pageWidth - 25, 25, starSize);
            // Bottom-left
            drawStar(doc, 25, pageHeight - 25, starSize);
            // Bottom-right
            drawStar(doc, pageWidth - 25, pageHeight - 25, starSize);

            // Title: "CERTIFICATE OF ACHIEVEMENT"
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(32);
            doc.setTextColor(0, 90, 156); // Deep blue
            doc.text('CERTIFICATE OF ACHIEVEMENT', pageWidth / 2, 45, { align: 'center' });

            // Trophy icon area (decorative line)
            doc.setDrawColor(255, 193, 7);
            doc.setLineWidth(0.5);
            doc.line(pageWidth / 2 - 40, 55, pageWidth / 2 + 40, 55);

            // "Virtual Chemistry Lab" subtitle
            doc.setFontSize(18);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text('Virtual Chemistry Lab', pageWidth / 2, 70, { align: 'center' });

            // "This is to certify that"
            doc.setFontSize(14);
            doc.setTextColor(80, 80, 80);
            doc.text('This is to certify that', pageWidth / 2, 90, { align: 'center' });

            // Student Name (prominent)
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(28);
            doc.setTextColor(0, 90, 156);
            doc.text(studentName, pageWidth / 2, 110, { align: 'center' });

            // Decorative line under name
            const nameWidth = doc.getTextWidth(studentName);
            doc.setDrawColor(255, 193, 7);
            doc.setLineWidth(0.8);
            doc.line(pageWidth / 2 - nameWidth / 2 - 10, 115, pageWidth / 2 + nameWidth / 2 + 10, 115);

            // Achievement text
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(14);
            doc.setTextColor(60, 60, 60);
            doc.text('has successfully completed all experiments in the', pageWidth / 2, 130, { align: 'center' });

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.setTextColor(0, 90, 156);
            doc.text('Virtual Chemistry Lab (Classes 6, 7 & 8)', pageWidth / 2, 142, { align: 'center' });

            // Count of experiments
            const totalExperiments = getTotalExperimentCount();
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Total Experiments Completed: ${totalExperiments}`, pageWidth / 2, 158, { align: 'center' });

            // Date
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            doc.setFontSize(11);
            doc.text(`Date: ${dateStr}`, pageWidth / 2, 172, { align: 'center' });

            // Footer text
            doc.setFontSize(10);
            doc.setTextColor(120, 120, 120);
            doc.text('Congratulations on becoming a Young Scientist!', pageWidth / 2, 190, { align: 'center' });

            // Save the certificate
            doc.save(`Certificate_${studentName.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`);
        }

        // Helper function to draw a simple star
        function drawStar(doc, cx, cy, size) {
            // Simple 5-pointed star approximation using lines
            const points = 5;
            const outerRadius = size;
            const innerRadius = size / 2.5;

            doc.setFillColor(255, 193, 7);
            doc.setDrawColor(255, 193, 7);

            // Draw a simple diamond/star shape
            doc.circle(cx, cy, size / 3, 'F');
        }
    </script>
</body>

</html>